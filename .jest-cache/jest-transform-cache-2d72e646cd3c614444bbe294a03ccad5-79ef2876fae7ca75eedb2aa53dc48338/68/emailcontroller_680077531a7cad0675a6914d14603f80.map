{"file":"C:\\Users\\g-ekoh\\Desktop\\StrellerMinds-Backend\\src\\email\\email.controller.ts","mappings":"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","names":[],"sources":["C:\\Users\\g-ekoh\\Desktop\\StrellerMinds-Backend\\src\\email\\email.controller.ts"],"sourcesContent":["/**\r\n * EmailController handles endpoints for managing email preferences, analytics, and tracking.\r\n */\r\nimport { Controller, Get, Post, Body, Param, Query, Res } from '@nestjs/common';\r\nimport { ApiTags, ApiOperation, ApiResponse, ApiBody, ApiParam, ApiQuery } from '@nestjs/swagger';\r\nimport { EmailService } from './email.service';\r\nimport { EmailPreference } from './entities/email-preference.entity';\r\n\r\n@ApiTags('Email')\r\n@Controller('email')\r\nexport class EmailController {\r\n  constructor(private readonly emailService: EmailService) {}\r\n\r\n  /**\r\n   * Update a user's email preference for a specific email type.\r\n   * @param body - Email, emailType, and optOut flag\r\n   * @returns The updated EmailPreference entity\r\n   */\r\n  @Post('preferences')\r\n  @ApiOperation({ summary: 'Update email preference', description: 'Update a user\\'s email preference for a specific email type.' })\r\n  @ApiBody({ schema: { properties: { email: { type: 'string' }, emailType: { type: 'string' }, optOut: { type: 'boolean' } } } })\r\n  @ApiResponse({ status: 200, description: 'Email preference updated', type: EmailPreference })\r\n  async updatePreference(\r\n    @Body() body: { email: string; emailType: string; optOut: boolean },\r\n  ): Promise<EmailPreference> {\r\n    return this.emailService.updateEmailPreference(\r\n      body.email,\r\n      body.emailType,\r\n      body.optOut,\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get email analytics for a date range and optional template name.\r\n   * @param startDate - Start date (ISO8601)\r\n   * @param endDate - End date (ISO8601)\r\n   * @param templateName - Optional template name\r\n   * @returns Analytics data\r\n   */\r\n  @Get('analytics')\r\n  @ApiOperation({ summary: 'Get email analytics', description: 'Get email analytics for a date range and optional template name.' })\r\n  @ApiQuery({ name: 'startDate', required: true, description: 'Start date (ISO8601)' })\r\n  @ApiQuery({ name: 'endDate', required: true, description: 'End date (ISO8601)' })\r\n  @ApiQuery({ name: 'templateName', required: false, description: 'Template name' })\r\n  @ApiResponse({ status: 200, description: 'Email analytics data' })\r\n  async getAnalytics(\r\n    @Query('startDate') startDate: string,\r\n    @Query('endDate') endDate: string,\r\n    @Query('templateName') templateName?: string,\r\n  ) {\r\n    return this.emailService.getEmailAnalytics(\r\n      new Date(startDate),\r\n      new Date(endDate),\r\n      templateName,\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Track email open event (returns a 1x1 transparent pixel).\r\n   * @param id - Email log ID\r\n   * @param res - Response object\r\n   */\r\n  @Get('track/open/:id')\r\n  @ApiOperation({ summary: 'Track email open', description: 'Track email open event (returns a 1x1 transparent pixel).' })\r\n  @ApiParam({ name: 'id', description: 'Email log ID' })\r\n  @ApiResponse({ status: 200, description: '1x1 transparent pixel returned' })\r\n  async trackOpen(@Param('id') id: string, @Res() res) {\r\n    try {\r\n      // Update the email log to mark as opened\r\n      await this.emailService.markEmailAsOpened(id);\r\n\r\n      // Return a 1x1 transparent pixel\r\n      const buffer = Buffer.from(\r\n        'R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',\r\n        'base64',\r\n      );\r\n\r\n      res.set('Content-Type', 'image/gif');\r\n      res.set(\r\n        'Cache-Control',\r\n        'no-store, no-cache, must-revalidate, proxy-revalidate',\r\n      );\r\n      res.set('Pragma', 'no-cache');\r\n      res.set('Expires', '0');\r\n      return res.send(buffer);\r\n    } catch (error) {\r\n      // Still return the pixel even if tracking fails\r\n      const buffer = Buffer.from(\r\n        'R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',\r\n        'base64',\r\n      );\r\n\r\n      res.set('Content-Type', 'image/gif');\r\n      return res.send(buffer);\r\n    }\r\n  }\r\n\r\n  // This endpoint would be used for tracking email clicks\r\n  @Get('track/click/:id')\r\n  async trackClick(\r\n    @Param('id') id: string,\r\n    @Query('url') url: string,\r\n    @Res() res,\r\n  ) {\r\n    try {\r\n      // Update the email log to mark as clicked\r\n      await this.emailService.markEmailAsClicked(id, url);\r\n    } catch (error) {\r\n      // Log the error but continue with the redirect\r\n      console.error('Error tracking click:', error);\r\n    }\r\n\r\n    // Redirect to the original URL\r\n    return res.redirect(url);\r\n  }\r\n}\r\n"],"version":3}