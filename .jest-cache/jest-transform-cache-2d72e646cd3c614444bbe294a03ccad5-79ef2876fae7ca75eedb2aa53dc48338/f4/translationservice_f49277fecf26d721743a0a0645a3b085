28d17869232f12a3ddfc131f1ab48934
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var TranslationService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TranslationService = void 0;
const common_1 = require("@nestjs/common");
const translation_entity_1 = require("../entities/translation.entity");
let TranslationService = TranslationService_1 = class TranslationService {
    constructor(translationRepository, tmsService) {
        this.translationRepository = translationRepository;
        this.tmsService = tmsService;
        this.logger = new common_1.Logger(TranslationService_1.name);
    }
    async createTranslation(dto) {
        const existingTranslation = await this.translationRepository.findOne({
            where: {
                key: dto.key,
                locale: dto.locale,
                namespace: dto.namespace,
            },
        });
        if (existingTranslation) {
            throw new Error(`Translation already exists for key: ${dto.key}, locale: ${dto.locale}`);
        }
        const translation = this.translationRepository.create({
            ...dto,
            status: translation_entity_1.TranslationStatus.DRAFT,
            source: translation_entity_1.TranslationSource.MANUAL,
            version: 1,
        });
        return this.translationRepository.save(translation);
    }
    async updateTranslation(id, dto) {
        const translation = await this.translationRepository.findOne({ where: { id } });
        if (!translation) {
            throw new common_1.NotFoundException(`Translation with ID ${id} not found`);
        }
        // Create new version if value changed
        if (dto.value && dto.value !== translation.value) {
            translation.version += 1;
            translation.translatedAt = new Date();
        }
        Object.assign(translation, dto);
        return this.translationRepository.save(translation);
    }
    async getTranslations(filters = {}) {
        const query = this.translationRepository.createQueryBuilder("translation");
        if (filters.locale) {
            query.andWhere("translation.locale = :locale", { locale: filters.locale });
        }
        if (filters.namespace) {
            query.andWhere("translation.namespace = :namespace", { namespace: filters.namespace });
        }
        if (filters.status) {
            query.andWhere("translation.status = :status", { status: filters.status });
        }
        if (filters.source) {
            query.andWhere("translation.source = :source", { source: filters.source });
        }
        if (filters.keys && filters.keys.length > 0) {
            query.andWhere("translation.key IN (:...keys)", { keys: filters.keys });
        }
        if (filters.search) {
            query.andWhere("(translation.key ILIKE :search OR translation.value ILIKE :search OR translation.description ILIKE :search)", { search: `%${filters.search}%` });
        }
        return query.orderBy("translation.namespace", "ASC").addOrderBy("translation.key", "ASC").getMany();
    }
    async getTranslationById(id) {
        const translation = await this.translationRepository.findOne({ where: { id } });
        if (!translation) {
            throw new common_1.NotFoundException(`Translation with ID ${id} not found`);
        }
        return translation;
    }
    async deleteTranslation(id) {
        const result = await this.translationRepository.delete(id);
        if (result.affected === 0) {
            throw new common_1.NotFoundException(`Translation with ID ${id} not found`);
        }
    }
    async bulkCreateTranslations(translations) {
        const entities = translations.map((dto) => this.translationRepository.create({
            ...dto,
            status: translation_entity_1.TranslationStatus.DRAFT,
            source: translation_entity_1.TranslationSource.IMPORT,
            version: 1,
        }));
        return this.translationRepository.save(entities);
    }
    async bulkUpdateStatus(ids, status) {
        await this.translationRepository.update(ids, {
            status,
            ...(status === translation_entity_1.TranslationStatus.PUBLISHED && { publishedAt: new Date() }),
        });
    }
    async getTranslationStats(locale) {
        const query = this.translationRepository.createQueryBuilder("translation");
        if (locale) {
            query.where("translation.locale = :locale", { locale });
        }
        const translations = await query.getMany();
        const stats = {
            total: translations.length,
            byStatus: {},
            byNamespace: {},
            completionPercentage: 0,
        };
        // Initialize status counts
        Object.values(translation_entity_1.TranslationStatus).forEach((status) => {
            stats.byStatus[status] = 0;
        });
        // Count by status and namespace
        for (const translation of translations) {
            stats.byStatus[translation.status]++;
            stats.byNamespace[translation.namespace] = (stats.byNamespace[translation.namespace] || 0) + 1;
        }
        // Calculate completion percentage
        const publishedCount = stats.byStatus[translation_entity_1.TranslationStatus.PUBLISHED];
        stats.completionPercentage = stats.total > 0 ? Math.round((publishedCount / stats.total) * 100) : 0;
        return stats;
    }
    async syncWithTms(locale, namespace) {
        this.logger.log(`Syncing translations with TMS for locale: ${locale}`);
        try {
            const tmsTranslations = await this.tmsService.getTranslations(locale, namespace);
            for (const tmsTranslation of tmsTranslations) {
                const existingTranslation = await this.translationRepository.findOne({
                    where: {
                        key: tmsTranslation.key,
                        locale: tmsTranslation.locale,
                        namespace: tmsTranslation.namespace,
                    },
                });
                if (existingTranslation) {
                    if (existingTranslation.value !== tmsTranslation.value) {
                        await this.updateTranslation(existingTranslation.id, {
                            value: tmsTranslation.value,
                            status: translation_entity_1.TranslationStatus.APPROVED,
                        });
                    }
                }
                else {
                    await this.createTranslation({
                        ...tmsTranslation,
                        source: translation_entity_1.TranslationSource.TMS,
                    });
                }
            }
            this.logger.log(`TMS sync completed for locale: ${locale}`);
        }
        catch (error) {
            this.logger.error(`TMS sync failed for locale: ${locale}`, error);
            throw error;
        }
    }
    async exportTranslations(locale, namespace) {
        const filters = {
            locale,
            status: translation_entity_1.TranslationStatus.PUBLISHED,
        };
        if (namespace) {
            filters.namespace = namespace;
        }
        const translations = await this.getTranslations(filters);
        const result = {};
        for (const translation of translations) {
            const key = namespace ? translation.key : `${translation.namespace}.${translation.key}`;
            result[key] = translation.value;
        }
        return result;
    }
};
exports.TranslationService = TranslationService;
exports.TranslationService = TranslationService = TranslationService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [Object, Object])
], TranslationService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxpMThuXFxzZXJ2aWNlc1xcdHJhbnNsYXRpb24uc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQXNFO0FBR3RFLHVFQUF1RztBQStCaEcsSUFBTSxrQkFBa0IsMEJBQXhCLE1BQU0sa0JBQWtCO0lBRzdCLFlBQ21CLHFCQUE4QyxFQUM5QyxVQUFzQjtRQUR0QiwwQkFBcUIsR0FBckIscUJBQXFCLENBQXlCO1FBQzlDLGVBQVUsR0FBVixVQUFVLENBQVk7UUFKeEIsV0FBTSxHQUFHLElBQUksZUFBTSxDQUFDLG9CQUFrQixDQUFDLElBQUksQ0FBQyxDQUFBO0lBSzFELENBQUM7SUFFSixLQUFLLENBQUMsaUJBQWlCLENBQUMsR0FBeUI7UUFDL0MsTUFBTSxtQkFBbUIsR0FBRyxNQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUM7WUFDbkUsS0FBSyxFQUFFO2dCQUNMLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRztnQkFDWixNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU07Z0JBQ2xCLFNBQVMsRUFBRSxHQUFHLENBQUMsU0FBUzthQUN6QjtTQUNGLENBQUMsQ0FBQTtRQUVGLElBQUksbUJBQW1CLEVBQUUsQ0FBQztZQUN4QixNQUFNLElBQUksS0FBSyxDQUFDLHVDQUF1QyxHQUFHLENBQUMsR0FBRyxhQUFhLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFBO1FBQzFGLENBQUM7UUFFRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDO1lBQ3BELEdBQUcsR0FBRztZQUNOLE1BQU0sRUFBRSxzQ0FBaUIsQ0FBQyxLQUFLO1lBQy9CLE1BQU0sRUFBRSxzQ0FBaUIsQ0FBQyxNQUFNO1lBQ2hDLE9BQU8sRUFBRSxDQUFDO1NBQ1gsQ0FBQyxDQUFBO1FBRUYsT0FBTyxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFB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b2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxpMThuXFxzZXJ2aWNlc1xcdHJhbnNsYXRpb24uc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIsIE5vdEZvdW5kRXhjZXB0aW9uIH0gZnJvbSBcIkBuZXN0anMvY29tbW9uXCJcclxuaW1wb3J0IHR5cGUgeyBSZXBvc2l0b3J5IH0gZnJvbSBcInR5cGVvcm1cIlxyXG5cclxuaW1wb3J0IHsgdHlwZSBUcmFuc2xhdGlvbiwgVHJhbnNsYXRpb25TdGF0dXMsIFRyYW5zbGF0aW9uU291cmNlIH0gZnJvbSBcIi4uL2VudGl0aWVzL3RyYW5zbGF0aW9uLmVudGl0eVwiXHJcbmltcG9ydCB0eXBlIHsgVG1zU2VydmljZSB9IGZyb20gXCIuL3Rtcy5zZXJ2aWNlXCJcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQ3JlYXRlVHJhbnNsYXRpb25EdG8ge1xyXG4gIGtleTogc3RyaW5nXHJcbiAgbG9jYWxlOiBzdHJpbmdcclxuICBuYW1lc3BhY2U6IHN0cmluZ1xyXG4gIHZhbHVlOiBzdHJpbmdcclxuICBkZXNjcmlwdGlvbj86IHN0cmluZ1xyXG4gIGNvbnRleHQ/OiBzdHJpbmdcclxuICBtZXRhZGF0YT86IGFueVxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFVwZGF0ZVRyYW5zbGF0aW9uRHRvIHtcclxuICB2YWx1ZT86IHN0cmluZ1xyXG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nXHJcbiAgY29udGV4dD86IHN0cmluZ1xyXG4gIHN0YXR1cz86IFRyYW5zbGF0aW9uU3RhdHVzXHJcbiAgbWV0YWRhdGE/OiBhbnlcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBUcmFuc2xhdGlvbkZpbHRlcnMge1xyXG4gIGxvY2FsZT86IHN0cmluZ1xyXG4gIG5hbWVzcGFjZT86IHN0cmluZ1xyXG4gIHN0YXR1cz86IFRyYW5zbGF0aW9uU3RhdHVzXHJcbiAgc291cmNlPzogVHJhbnNsYXRpb25Tb3VyY2VcclxuICBzZWFyY2g/OiBzdHJpbmdcclxuICBrZXlzPzogc3RyaW5nW11cclxufVxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgVHJhbnNsYXRpb25TZXJ2aWNlIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlciA9IG5ldyBMb2dnZXIoVHJhbnNsYXRpb25TZXJ2aWNlLm5hbWUpXHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSB0cmFuc2xhdGlvblJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8VHJhbnNsYXRpb24+LFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSB0bXNTZXJ2aWNlOiBUbXNTZXJ2aWNlLFxyXG4gICkge31cclxuXHJcbiAgYXN5bmMgY3JlYXRlVHJhbnNsYXRpb24oZHRvOiBDcmVhdGVUcmFuc2xhdGlvbkR0byk6IFByb21pc2U8VHJhbnNsYXRpb24+IHtcclxuICAgIGNvbnN0IGV4aXN0aW5nVHJhbnNsYXRpb24gPSBhd2FpdCB0aGlzLnRyYW5zbGF0aW9uUmVwb3NpdG9yeS5maW5kT25lKHtcclxuICAgICAgd2hlcmU6IHtcclxuICAgICAgICBrZXk6IGR0by5rZXksXHJcbiAgICAgICAgbG9jYWxlOiBkdG8ubG9jYWxlLFxyXG4gICAgICAgIG5hbWVzcGFjZTogZHRvLm5hbWVzcGFjZSxcclxuICAgICAgfSxcclxuICAgIH0pXHJcblxyXG4gICAgaWYgKGV4aXN0aW5nVHJhbnNsYXRpb24pIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcmFuc2xhdGlvbiBhbHJlYWR5IGV4aXN0cyBmb3Iga2V5OiAke2R0by5rZXl9LCBsb2NhbGU6ICR7ZHRvLmxvY2FsZX1gKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRyYW5zbGF0aW9uID0gdGhpcy50cmFuc2xhdGlvblJlcG9zaXRvcnkuY3JlYXRlKHtcclxuICAgICAgLi4uZHRvLFxyXG4gICAgICBzdGF0dXM6IFRyYW5zbGF0aW9uU3RhdHVzLkRSQUZULFxyXG4gICAgICBzb3VyY2U6IFRyYW5zbGF0aW9uU291cmNlLk1BTlVBTCxcclxuICAgICAgdmVyc2lvbjogMSxcclxuICAgIH0pXHJcblxyXG4gICAgcmV0dXJuIHRoaXMudHJhbnNsYXRpb25SZXBvc2l0b3J5LnNhdmUodHJhbnNsYXRpb24pXHJcbiAgfVxyXG5cclxuICBhc3luYyB1cGRhdGVUcmFuc2xhdGlvbihpZDogc3RyaW5nLCBkdG86IFVwZGF0ZVRyYW5zbGF0aW9uRHRvKTogUHJvbWlzZTxUcmFuc2xhdGlvbj4ge1xyXG4gICAgY29uc3QgdHJhbnNsYXRpb24gPSBhd2FpdCB0aGlzLnRyYW5zbGF0aW9uUmVwb3NpdG9yeS5maW5kT25lKHsgd2hlcmU6IHsgaWQgfSB9KVxyXG4gICAgaWYgKCF0cmFuc2xhdGlvbikge1xyXG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFRyYW5zbGF0aW9uIHdpdGggSUQgJHtpZH0gbm90IGZvdW5kYClcclxuICAgIH1cclxuXHJcbiAgICAvLyBDcmVhdGUgbmV3IHZlcnNpb24gaWYgdmFsdWUgY2hhbmdlZFxyXG4gICAgaWYgKGR0by52YWx1ZSAmJiBkdG8udmFsdWUgIT09IHRyYW5zbGF0aW9uLnZhbHVlKSB7XHJcbiAgICAgIHRyYW5zbGF0aW9uLnZlcnNpb24gKz0gMVxyXG4gICAgICB0cmFuc2xhdGlvbi50cmFuc2xhdGVkQXQgPSBuZXcgRGF0ZSgpXHJcbiAgICB9XHJcblxyXG4gICAgT2JqZWN0LmFzc2lnbih0cmFuc2xhdGlvbiwgZHRvKVxyXG4gICAgcmV0dXJuIHRoaXMudHJhbnNsYXRpb25SZXBvc2l0b3J5LnNhdmUodHJhbnNsYXRpb24pXHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRUcmFuc2xhdGlvbnMoZmlsdGVyczogVHJhbnNsYXRpb25GaWx0ZXJzID0ge30pOiBQcm9taXNlPFRyYW5zbGF0aW9uW10+IHtcclxuICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy50cmFuc2xhdGlvblJlcG9zaXRvcnkuY3JlYXRlUXVlcnlCdWlsZGVyKFwidHJhbnNsYXRpb25cIilcclxuXHJcbiAgICBpZiAoZmlsdGVycy5sb2NhbGUpIHtcclxuICAgICAgcXVlcnkuYW5kV2hlcmUoXCJ0cmFuc2xhdGlvbi5sb2NhbGUgPSA6bG9jYWxlXCIsIHsgbG9jYWxlOiBmaWx0ZXJzLmxvY2FsZSB9KVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChmaWx0ZXJzLm5hbWVzcGFjZSkge1xyXG4gICAgICBxdWVyeS5hbmRXaGVyZShcInRyYW5zbGF0aW9uLm5hbWVzcGFjZSA9IDpuYW1lc3BhY2VcIiwgeyBuYW1lc3BhY2U6IGZpbHRlcnMubmFtZXNwYWNlIH0pXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGZpbHRlcnMuc3RhdHVzKSB7XHJcbiAgICAgIHF1ZXJ5LmFuZFdoZXJlKFwidHJhbnNsYXRpb24uc3RhdHVzID0gOnN0YXR1c1wiLCB7IHN0YXR1czogZmlsdGVycy5zdGF0dXMgfSlcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZmlsdGVycy5zb3VyY2UpIHtcclxuICAgICAgcXVlcnkuYW5kV2hlcmUoXCJ0cmFuc2xhdGlvbi5zb3VyY2UgPSA6c291cmNlXCIsIHsgc291cmNlOiBmaWx0ZXJzLnNvdXJjZSB9KVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChmaWx0ZXJzLmtleXMgJiYgZmlsdGVycy5rZXlzLmxlbmd0aCA+IDApIHtcclxuICAgICAgcXVlcnkuYW5kV2hlcmUoXCJ0cmFuc2xhdGlvbi5rZXkgSU4gKDouLi5rZXlzKVwiLCB7IGtleXM6IGZpbHRlcnMua2V5cyB9KVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChmaWx0ZXJzLnNlYXJjaCkge1xyXG4gICAgICBxdWVyeS5hbmRXaGVyZShcclxuICAgICAgICBcIih0cmFuc2xhdGlvbi5rZXkgSUxJS0UgOnNlYXJjaCBPUiB0cmFuc2xhdGlvbi52YWx1ZSBJTElLRSA6c2VhcmNoIE9SIHRyYW5zbGF0aW9uLmRlc2NyaXB0aW9uIElMSUtFIDpzZWFyY2gpXCIsXHJcbiAgICAgICAgeyBzZWFyY2g6IGAlJHtmaWx0ZXJzLnNlYXJjaH0lYCB9LFxyXG4gICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHF1ZXJ5Lm9yZGVyQnkoXCJ0cmFuc2xhdGlvbi5uYW1lc3BhY2VcIiwgXCJBU0NcIikuYWRkT3JkZXJCeShcInRyYW5zbGF0aW9uLmtleVwiLCBcIkFTQ1wiKS5nZXRNYW55KClcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFRyYW5zbGF0aW9uQnlJZChpZDogc3RyaW5nKTogUHJvbWlzZTxUcmFuc2xhdGlvbj4ge1xyXG4gICAgY29uc3QgdHJhbnNsYXRpb24gPSBhd2FpdCB0aGlzLnRyYW5zbGF0aW9uUmVwb3NpdG9yeS5maW5kT25lKHsgd2hlcmU6IHsgaWQgfSB9KVxyXG4gICAgaWYgKCF0cmFuc2xhdGlvbikge1xyXG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFRyYW5zbGF0aW9uIHdpdGggSUQgJHtpZH0gbm90IGZvdW5kYClcclxuICAgIH1cclxuICAgIHJldHVybiB0cmFuc2xhdGlvblxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZGVsZXRlVHJhbnNsYXRpb24oaWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy50cmFuc2xhdGlvblJlcG9zaXRvcnkuZGVsZXRlKGlkKVxyXG4gICAgaWYgKHJlc3VsdC5hZmZlY3RlZCA9PT0gMCkge1xyXG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oYFRyYW5zbGF0aW9uIHdpdGggSUQgJHtpZH0gbm90IGZvdW5kYClcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGJ1bGtDcmVhdGVUcmFuc2xhdGlvbnModHJhbnNsYXRpb25zOiBDcmVhdGVUcmFuc2xhdGlvbkR0b1tdKTogUHJvbWlzZTxUcmFuc2xhdGlvbltdPiB7XHJcbiAgICBjb25zdCBlbnRpdGllcyA9IHRyYW5zbGF0aW9ucy5tYXAoKGR0bykgPT5cclxuICAgICAgdGhpcy50cmFuc2xhdGlvblJlcG9zaXRvcnkuY3JlYXRlKHtcclxuICAgICAgICAuLi5kdG8sXHJcbiAgICAgICAgc3RhdHVzOiBUcmFuc2xhdGlvblN0YXR1cy5EUkFGVCxcclxuICAgICAgICBzb3VyY2U6IFRyYW5zbGF0aW9uU291cmNlLklNUE9SVCxcclxuICAgICAgICB2ZXJzaW9uOiAxLFxyXG4gICAgICB9KSxcclxuICAgIClcclxuXHJcbiAgICByZXR1cm4gdGhpcy50cmFuc2xhdGlvblJlcG9zaXRvcnkuc2F2ZShlbnRpdGllcylcclxuICB9XHJcblxyXG4gIGFzeW5jIGJ1bGtVcGRhdGVTdGF0dXMoaWRzOiBzdHJpbmdbXSwgc3RhdHVzOiBUcmFuc2xhdGlvblN0YXR1cyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgdGhpcy50cmFuc2xhdGlvblJlcG9zaXRvcnkudXBkYXRlKGlkcywge1xyXG4gICAgICBzdGF0dXMsXHJcbiAgICAgIC4uLihzdGF0dXMgPT09IFRyYW5zbGF0aW9uU3RhdHVzLlBVQkxJU0hFRCAmJiB7IHB1Ymxpc2hlZEF0OiBuZXcgRGF0ZSgpIH0pLFxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFRyYW5zbGF0aW9uU3RhdHMobG9jYWxlPzogc3RyaW5nKTogUHJvbWlzZTx7XHJcbiAgICB0b3RhbDogbnVtYmVyXHJcbiAgICBieVN0YXR1czogUmVjb3JkPFRyYW5zbGF0aW9uU3RhdHVzLCBudW1iZXI+XHJcbiAgICBieU5hbWVzcGFjZTogUmVjb3JkPHN0cmluZywgbnVtYmVyPlxyXG4gICAgY29tcGxldGlvblBlcmNlbnRhZ2U6IG51bWJlclxyXG4gIH0+IHtcclxuICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy50cmFuc2xhdGlvblJlcG9zaXRvcnkuY3JlYXRlUXVlcnlCdWlsZGVyKFwidHJhbnNsYXRpb25cIilcclxuXHJcbiAgICBpZiAobG9jYWxlKSB7XHJcbiAgICAgIHF1ZXJ5LndoZXJlKFwidHJhbnNsYXRpb24ubG9jYWxlID0gOmxvY2FsZVwiLCB7IGxvY2FsZSB9KVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRyYW5zbGF0aW9ucyA9IGF3YWl0IHF1ZXJ5LmdldE1hbnkoKVxyXG5cclxuICAgIGNvbnN0IHN0YXRzID0ge1xyXG4gICAgICB0b3RhbDogdHJhbnNsYXRpb25zLmxlbmd0aCxcclxuICAgICAgYnlTdGF0dXM6IHt9IGFzIFJlY29yZDxUcmFuc2xhdGlvblN0YXR1cywgbnVtYmVyPixcclxuICAgICAgYnlOYW1lc3BhY2U6IHt9IGFzIFJlY29yZDxzdHJpbmcsIG51bWJlcj4sXHJcbiAgICAgIGNvbXBsZXRpb25QZXJjZW50YWdlOiAwLFxyXG4gICAgfVxyXG5cclxuICAgIC8vIEluaXRpYWxpemUgc3RhdHVzIGNvdW50c1xyXG4gICAgT2JqZWN0LnZhbHVlcyhUcmFuc2xhdGlvblN0YXR1cykuZm9yRWFjaCgoc3RhdHVzKSA9PiB7XHJcbiAgICAgIHN0YXRzLmJ5U3RhdHVzW3N0YXR1c10gPSAwXHJcbiAgICB9KVxyXG5cclxuICAgIC8vIENvdW50IGJ5IHN0YXR1cyBhbmQgbmFtZXNwYWNlXHJcbiAgICBmb3IgKGNvbnN0IHRyYW5zbGF0aW9uIG9mIHRyYW5zbGF0aW9ucykge1xyXG4gICAgICBzdGF0cy5ieVN0YXR1c1t0cmFuc2xhdGlvbi5zdGF0dXNdKytcclxuICAgICAgc3RhdHMuYnlOYW1lc3BhY2VbdHJhbnNsYXRpb24ubmFtZXNwYWNlXSA9IChzdGF0cy5ieU5hbWVzcGFjZVt0cmFuc2xhdGlvbi5uYW1lc3BhY2VdIHx8IDApICsgMVxyXG4gICAgfVxyXG5cclxuICAgIC8vIENhbGN1bGF0ZSBjb21wbGV0aW9uIHBlcmNlbnRhZ2VcclxuICAgIGNvbnN0IHB1Ymxpc2hlZENvdW50ID0gc3RhdHMuYnlTdGF0dXNbVHJhbnNsYXRpb25TdGF0dXMuUFVCTElTSEVEXVxyXG4gICAgc3RhdHMuY29tcGxldGlvblBlcmNlbnRhZ2UgPSBzdGF0cy50b3RhbCA+IDAgPyBNYXRoLnJvdW5kKChwdWJsaXNoZWRDb3VudCAvIHN0YXRzLnRvdGFsKSAqIDEwMCkgOiAwXHJcblxyXG4gICAgcmV0dXJuIHN0YXRzXHJcbiAgfVxyXG5cclxuICBhc3luYyBzeW5jV2l0aFRtcyhsb2NhbGU6IHN0cmluZywgbmFtZXNwYWNlPzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0aGlzLmxvZ2dlci5sb2coYFN5bmNpbmcgdHJhbnNsYXRpb25zIHdpdGggVE1TIGZvciBsb2NhbGU6ICR7bG9jYWxlfWApXHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgdG1zVHJhbnNsYXRpb25zID0gYXdhaXQgdGhpcy50bXNTZXJ2aWNlLmdldFRyYW5zbGF0aW9ucyhsb2NhbGUsIG5hbWVzcGFjZSlcclxuXHJcbiAgICAgIGZvciAoY29uc3QgdG1zVHJhbnNsYXRpb24gb2YgdG1zVHJhbnNsYXRpb25zKSB7XHJcbiAgICAgICAgY29uc3QgZXhpc3RpbmdUcmFuc2xhdGlvbiA9IGF3YWl0IHRoaXMudHJhbnNsYXRpb25SZXBvc2l0b3J5LmZpbmRPbmUoe1xyXG4gICAgICAgICAgd2hlcmU6IHtcclxuICAgICAgICAgICAga2V5OiB0bXNUcmFuc2xhdGlvbi5rZXksXHJcbiAgICAgICAgICAgIGxvY2FsZTogdG1zVHJhbnNsYXRpb24ubG9jYWxlLFxyXG4gICAgICAgICAgICBuYW1lc3BhY2U6IHRtc1RyYW5zbGF0aW9uLm5hbWVzcGFjZSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgaWYgKGV4aXN0aW5nVHJhbnNsYXRpb24pIHtcclxuICAgICAgICAgIGlmIChleGlzdGluZ1RyYW5zbGF0aW9uLnZhbHVlICE9PSB0bXNUcmFuc2xhdGlvbi52YWx1ZSkge1xyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZVRyYW5zbGF0aW9uKGV4aXN0aW5nVHJhbnNsYXRpb24uaWQsIHtcclxuICAgICAgICAgICAgICB2YWx1ZTogdG1zVHJhbnNsYXRpb24udmFsdWUsXHJcbiAgICAgICAgICAgICAgc3RhdHVzOiBUcmFuc2xhdGlvblN0YXR1cy5BUFBST1ZFRCxcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgYXdhaXQgdGhpcy5jcmVhdGVUcmFuc2xhdGlvbih7XHJcbiAgICAgICAgICAgIC4uLnRtc1RyYW5zbGF0aW9uLFxyXG4gICAgICAgICAgICBzb3VyY2U6IFRyYW5zbGF0aW9uU291cmNlLlRNUyxcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFRNUyBzeW5jIGNvbXBsZXRlZCBmb3IgbG9jYWxlOiAke2xvY2FsZX1gKVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYFRNUyBzeW5jIGZhaWxlZCBmb3IgbG9jYWxlOiAke2xvY2FsZX1gLCBlcnJvcilcclxuICAgICAgdGhyb3cgZXJyb3JcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGV4cG9ydFRyYW5zbGF0aW9ucyhsb2NhbGU6IHN0cmluZywgbmFtZXNwYWNlPzogc3RyaW5nKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+PiB7XHJcbiAgICBjb25zdCBmaWx0ZXJzOiBUcmFuc2xhdGlvbkZpbHRlcnMgPSB7XHJcbiAgICAgIGxvY2FsZSxcclxuICAgICAgc3RhdHVzOiBUcmFuc2xhdGlvblN0YXR1cy5QVUJMSVNIRUQsXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG5hbWVzcGFjZSkge1xyXG4gICAgICBmaWx0ZXJzLm5hbWVzcGFjZSA9IG5hbWVzcGFjZVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRyYW5zbGF0aW9ucyA9IGF3YWl0IHRoaXMuZ2V0VHJhbnNsYXRpb25zKGZpbHRlcnMpXHJcblxyXG4gICAgY29uc3QgcmVzdWx0OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge31cclxuICAgIGZvciAoY29uc3QgdHJhbnNsYXRpb24gb2YgdHJhbnNsYXRpb25zKSB7XHJcbiAgICAgIGNvbnN0IGtleSA9IG5hbWVzcGFjZSA/IHRyYW5zbGF0aW9uLmtleSA6IGAke3RyYW5zbGF0aW9uLm5hbWVzcGFjZX0uJHt0cmFuc2xhdGlvbi5rZXl9YFxyXG4gICAgICByZXN1bHRba2V5XSA9IHRyYW5zbGF0aW9uLnZhbHVlXHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdFxyXG4gIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=