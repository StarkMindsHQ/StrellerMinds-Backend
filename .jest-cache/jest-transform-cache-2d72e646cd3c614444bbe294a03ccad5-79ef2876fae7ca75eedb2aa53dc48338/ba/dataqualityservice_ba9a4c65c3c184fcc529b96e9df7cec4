6c448dca6ff87f5cd48b4ccc0f808cbf
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var DataQualityService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.DataQualityService = void 0;
const common_1 = require("@nestjs/common");
const data_quality_rule_entity_1 = require("../entities/data-quality-rule.entity");
let DataQualityService = DataQualityService_1 = class DataQualityService {
    constructor(ruleRepository, metricRepository, issueRepository, dataQualityQueue, validationService, monitoringService) {
        this.ruleRepository = ruleRepository;
        this.metricRepository = metricRepository;
        this.issueRepository = issueRepository;
        this.dataQualityQueue = dataQualityQueue;
        this.validationService = validationService;
        this.monitoringService = monitoringService;
        this.logger = new common_1.Logger(DataQualityService_1.name);
    }
    async checkDataQuality(entityType, data) {
        try {
            const rules = await this.getActiveRules(entityType);
            const result = {
                passed: true,
                score: 100,
                issues: [],
                metrics: [],
            };
            let totalScore = 0;
            let ruleCount = 0;
            for (const rule of rules) {
                const ruleResult = await this.validateRule(rule, data);
                if (!ruleResult.passed) {
                    result.passed = false;
                    result.issues.push({
                        ruleId: rule.id,
                        severity: rule.severity,
                        message: rule.errorMessage || `Rule ${rule.name} failed`,
                        data: ruleResult.failedData,
                    });
                    // Create issue record
                    await this.createOrUpdateIssue(rule, ruleResult);
                }
                // Record metric
                await this.recordMetric(rule, ruleResult);
                totalScore += ruleResult.score;
                ruleCount++;
                result.metrics.push({
                    name: rule.name,
                    value: ruleResult.score,
                    category: rule.ruleType,
                });
            }
            result.score = ruleCount > 0 ? totalScore / ruleCount : 100;
            // Queue for background processing
            await this.dataQualityQueue.add("process-quality-check", {
                entityType,
                result,
                timestamp: new Date(),
            });
            return result;
        }
        catch (error) {
            this.logger.error(`Data quality check failed: ${error.message}`, error.stack);
            throw error;
        }
    }
    async getActiveRules(entityType) {
        return this.ruleRepository.find({
            where: {
                entityType,
                status: data_quality_rule_entity_1.RuleStatus.ACTIVE,
            },
            order: {
                severity: "DESC",
                createdAt: "ASC",
            },
        });
    }
    async createRule(ruleData) {
        const rule = this.ruleRepository.create(ruleData);
        return this.ruleRepository.save(rule);
    }
    async updateRule(id, updates) {
        await this.ruleRepository.update(id, updates);
        const rule = await this.ruleRepository.findOne({ where: { id } });
        if (!rule) {
            throw new Error(`Rule with id ${id} not found`);
        }
        return rule;
    }
    async deleteRule(id) {
        await this.ruleRepository.update(id, { status: data_quality_rule_entity_1.RuleStatus.DEPRECATED });
    }
    async getRules(filters) {
        const query = this.ruleRepository.createQueryBuilder("rule");
        if (filters.entityType) {
            query.andWhere("rule.entityType = :entityType", { entityType: filters.entityType });
        }
        if (filters.ruleType) {
            query.andWhere("rule.ruleType = :ruleType", { ruleType: filters.ruleType });
        }
        if (filters.status) {
            query.andWhere("rule.status = :status", { status: filters.status });
        }
        if (filters.severity) {
            query.andWhere("rule.severity = :severity", { severity: filters.severity });
        }
        return query.orderBy("rule.createdAt", "DESC").getMany();
    }
    async validateRule(rule, data) {
        try {
            switch (rule.ruleType) {
                case "completeness":
                    return this.validationService.checkCompleteness(rule, data);
                case "accuracy":
                    return this.validationService.checkAccuracy(rule, data);
                case "consistency":
                    return this.validationService.checkConsistency(rule, data);
                case "validity":
                    return this.validationService.checkValidity(rule, data);
                case "uniqueness":
                    return this.validationService.checkUniqueness(rule, data);
                case "timeliness":
                    return this.validationService.checkTimeliness(rule, data);
                case "conformity":
                    return this.validationService.checkConformity(rule, data);
                default:
                    return { passed: true, score: 100 };
            }
        }
        catch (error) {
            this.logger.error(`Rule validation failed for ${rule.name}: ${error.message}`);
            return { passed: false, score: 0, details: { error: error.message } };
        }
    }
    async recordMetric(rule, result) {
        const metric = this.metricRepository.create({
            ruleId: rule.id,
            entityType: rule.entityType,
            metricCategory: rule.ruleType,
            metricName: rule.name,
            value: result.score,
            threshold: rule.threshold,
            passed: result.passed,
            details: result.details,
            timestamp: new Date(),
        });
        await this.metricRepository.save(metric);
    }
    async createOrUpdateIssue(rule, result) {
        const existingIssue = await this.issueRepository.findOne({
            where: {
                ruleId: rule.id,
                status: "open",
            },
        });
        if (existingIssue) {
            // Update existing issue
            existingIssue.occurrenceCount += 1;
            existingIssue.lastOccurrence = new Date();
            existingIssue.issueData = result.failedData || {};
            await this.issueRepository.save(existingIssue);
        }
        else {
            // Create new issue
            const issue = this.issueRepository.create({
                ruleId: rule.id,
                entityType: rule.entityType,
                title: `Data Quality Issue: ${rule.name}`,
                description: rule.errorMessage || `Rule ${rule.name} validation failed`,
                priority: rule.severity,
                issueData: result.failedData || {},
                context: result.details,
                occurrenceCount: 1,
                firstOccurrence: new Date(),
                lastOccurrence: new Date(),
            });
            await this.issueRepository.save(issue);
        }
    }
    async getQualityMetrics(filters) {
        const query = this.metricRepository.createQueryBuilder("metric");
        if (filters.entityType) {
            query.andWhere("metric.entityType = :entityType", { entityType: filters.entityType });
        }
        if (filters.startDate) {
            query.andWhere("metric.timestamp >= :startDate", { startDate: filters.startDate });
        }
        if (filters.endDate) {
            query.andWhere("metric.timestamp <= :endDate", { endDate: filters.endDate });
        }
        if (filters.metricCategory) {
            query.andWhere("metric.metricCategory = :metricCategory", { metricCategory: filters.metricCategory });
        }
        return query.orderBy("metric.timestamp", "DESC").getMany();
    }
    async getQualityIssues(filters) {
        const query = this.issueRepository.createQueryBuilder("issue");
        if (filters.status) {
            query.andWhere("issue.status = :status", { status: filters.status });
        }
        if (filters.priority) {
            query.andWhere("issue.priority = :priority", { priority: filters.priority });
        }
        if (filters.entityType) {
            query.andWhere("issue.entityType = :entityType", { entityType: filters.entityType });
        }
        if (filters.assignedTo) {
            query.andWhere("issue.assignedTo = :assignedTo", { assignedTo: filters.assignedTo });
        }
        return query.orderBy("issue.createdAt", "DESC").getMany();
    }
    async resolveIssue(issueId, resolution, resolvedBy) {
        await this.issueRepository.update(issueId, {
            status: "resolved",
            resolution,
            resolvedBy,
            resolvedAt: new Date(),
        });
    }
};
exports.DataQualityService = DataQualityService;
exports.DataQualityService = DataQualityService = DataQualityService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [Object, Object, Object, Object, Object, Object])
], DataQualityService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxkYXRhLXF1YWxpdHlcXHNlcnZpY2VzXFxkYXRhLXF1YWxpdHkuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUEsMkNBQW1EO0FBSW5ELG1GQUF1RjtBQXVCaEYsSUFBTSxrQkFBa0IsMEJBQXhCLE1BQU0sa0JBQWtCO0lBRzdCLFlBQ21CLGNBQTJDLEVBQzNDLGdCQUErQyxFQUMvQyxlQUE2QyxFQUM3QyxnQkFBdUIsRUFDdkIsaUJBQXdDLEVBQ3hDLGlCQUErQztRQUwvQyxtQkFBYyxHQUFkLGNBQWMsQ0FBNkI7UUFDM0MscUJBQWdCLEdBQWhCLGdCQUFnQixDQUErQjtRQUMvQyxvQkFBZSxHQUFmLGVBQWUsQ0FBOEI7UUFDN0MscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFPO1FBQ3ZCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBdUI7UUFDeEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUE4QjtRQVJqRCxXQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsb0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUE7SUFTMUQsQ0FBQztJQUVKLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFrQixFQUFFLElBQVc7UUFDcEQsSUFBSSxDQUFDO1lBQ0gsTUFBTSxLQUFLLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBQ25ELE1BQU0sTUFBTSxHQUF1QjtnQkFDakMsTUFBTSxFQUFFLElBQUk7Z0JBQ1osS0FBSyxFQUFFLEdBQUc7Z0JBQ1YsTUFBTSxFQUFFLEVBQUU7Z0JBQ1YsT0FBTyxFQUFFLEVBQUU7YUFDWixDQUFBO1lBRUQsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFBO1lBQ2xCLElBQUksU0FBUyxHQUFHLENBQUMsQ0FBQTtZQUVqQixLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRSxDQUFDO2dCQUN6QixNQUFNLFVBQVUsR0FBRyxNQUFN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Q0FBQyxDQUFBO1FBQ3RGLENBQUM7UUFFRCxJQUFJLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUN2QixLQUFLLENBQUMsUUFBUSxDQUFDLGdDQUFnQyxFQUFFLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFBO1FBQ3RGLENBQUM7UUFFRCxPQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsTUFBTSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDM0QsQ0FBQztJQUVELEtBQUssQ0FBQyxZQUFZLENBQUMsT0FBZSxFQUFFLFVBQWtCLEVBQUUsVUFBa0I7UUFDeEUsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUU7WUFDekMsTUFBTSxFQUFFLFVBQWlCO1lBQ3pCLFVBQVU7WUFDVixVQUFVO1lBQ1YsVUFBVSxFQUFFLElBQUksSUFBSSxFQUFFO1NBQ3ZCLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FDRixDQUFBO0FBaFJZLGdEQUFrQjs2QkFBbEIsa0JBQWtCO0lBRDlCLElBQUEsbUJBQVUsR0FBRTs7R0FDQSxrQkFBa0IsQ0FnUjlCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZy1la29oXFxEZXNrdG9wXFxTdHJlbGxlck1pbmRzLUJhY2tlbmRcXHNyY1xcZGF0YS1xdWFsaXR5XFxzZXJ2aWNlc1xcZGF0YS1xdWFsaXR5LnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTG9nZ2VyIH0gZnJvbSBcIkBuZXN0anMvY29tbW9uXCJcclxuaW1wb3J0IHR5cGUgeyBSZXBvc2l0b3J5IH0gZnJvbSBcInR5cGVvcm1cIlxyXG5pbXBvcnQgdHlwZSB7IFF1ZXVlIH0gZnJvbSBcImJ1bGxcIlxyXG5cclxuaW1wb3J0IHsgdHlwZSBEYXRhUXVhbGl0eVJ1bGUsIFJ1bGVTdGF0dXMgfSBmcm9tIFwiLi4vZW50aXRpZXMvZGF0YS1xdWFsaXR5LXJ1bGUuZW50aXR5XCJcclxuaW1wb3J0IHR5cGUgeyBEYXRhUXVhbGl0eU1ldHJpYyB9IGZyb20gXCIuLi9lbnRpdGllcy9kYXRhLXF1YWxpdHktbWV0cmljLmVudGl0eVwiXHJcbmltcG9ydCB0eXBlIHsgRGF0YVF1YWxpdHlJc3N1ZSB9IGZyb20gXCIuLi9lbnRpdGllcy9kYXRhLXF1YWxpdHktaXNzdWUuZW50aXR5XCJcclxuaW1wb3J0IHR5cGUgeyBEYXRhVmFsaWRhdGlvblNlcnZpY2UgfSBmcm9tIFwiLi9kYXRhLXZhbGlkYXRpb24uc2VydmljZVwiXHJcbmltcG9ydCB0eXBlIHsgRGF0YVF1YWxpdHlNb25pdG9yaW5nU2VydmljZSB9IGZyb20gXCIuL2RhdGEtcXVhbGl0eS1tb25pdG9yaW5nLnNlcnZpY2VcIlxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBRdWFsaXR5Q2hlY2tSZXN1bHQge1xyXG4gIHBhc3NlZDogYm9vbGVhblxyXG4gIHNjb3JlOiBudW1iZXJcclxuICBpc3N1ZXM6IEFycmF5PHtcclxuICAgIHJ1bGVJZDogc3RyaW5nXHJcbiAgICBzZXZlcml0eTogc3RyaW5nXHJcbiAgICBtZXNzYWdlOiBzdHJpbmdcclxuICAgIGRhdGE/OiBhbnlcclxuICB9PlxyXG4gIG1ldHJpY3M6IEFycmF5PHtcclxuICAgIG5hbWU6IHN0cmluZ1xyXG4gICAgdmFsdWU6IG51bWJlclxyXG4gICAgY2F0ZWdvcnk6IHN0cmluZ1xyXG4gIH0+XHJcbn1cclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIERhdGFRdWFsaXR5U2VydmljZSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKERhdGFRdWFsaXR5U2VydmljZS5uYW1lKVxyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgcnVsZVJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8RGF0YVF1YWxpdHlSdWxlPixcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgbWV0cmljUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxEYXRhUXVhbGl0eU1ldHJpYz4sXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGlzc3VlUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxEYXRhUXVhbGl0eUlzc3VlPixcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGF0YVF1YWxpdHlRdWV1ZTogUXVldWUsXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHZhbGlkYXRpb25TZXJ2aWNlOiBEYXRhVmFsaWRhdGlvblNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1vbml0b3JpbmdTZXJ2aWNlOiBEYXRhUXVhbGl0eU1vbml0b3JpbmdTZXJ2aWNlLFxyXG4gICkge31cclxuXHJcbiAgYXN5bmMgY2hlY2tEYXRhUXVhbGl0eShlbnRpdHlUeXBlOiBzdHJpbmcsIGRhdGE6IGFueVtdKTogUHJvbWlzZTxRdWFsaXR5Q2hlY2tSZXN1bHQ+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJ1bGVzID0gYXdhaXQgdGhpcy5nZXRBY3RpdmVSdWxlcyhlbnRpdHlUeXBlKVxyXG4gICAgICBjb25zdCByZXN1bHQ6IFF1YWxpdHlDaGVja1Jlc3VsdCA9IHtcclxuICAgICAgICBwYXNzZWQ6IHRydWUsXHJcbiAgICAgICAgc2NvcmU6IDEwMCxcclxuICAgICAgICBpc3N1ZXM6IFtdLFxyXG4gICAgICAgIG1ldHJpY3M6IFtdLFxyXG4gICAgICB9XHJcblxyXG4gICAgICBsZXQgdG90YWxTY29yZSA9IDBcclxuICAgICAgbGV0IHJ1bGVDb3VudCA9IDBcclxuXHJcbiAgICAgIGZvciAoY29uc3QgcnVsZSBvZiBydWxlcykge1xyXG4gICAgICAgIGNvbnN0IHJ1bGVSZXN1bHQgPSBhd2FpdCB0aGlzLnZhbGlkYXRlUnVsZShydWxlLCBkYXRhKVxyXG5cclxuICAgICAgICBpZiAoIXJ1bGVSZXN1bHQucGFzc2VkKSB7XHJcbiAgICAgICAgICByZXN1bHQucGFzc2VkID0gZmFsc2VcclxuICAgICAgICAgIHJlc3VsdC5pc3N1ZXMucHVzaCh7XHJcbiAgICAgICAgICAgIHJ1bGVJZDogcnVsZS5pZCxcclxuICAgICAgICAgICAgc2V2ZXJpdHk6IHJ1bGUuc2V2ZXJpdHksXHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IHJ1bGUuZXJyb3JNZXNzYWdlIHx8IGBSdWxlICR7cnVsZS5uYW1lfSBmYWlsZWRgLFxyXG4gICAgICAgICAgICBkYXRhOiBydWxlUmVzdWx0LmZhaWxlZERhdGEsXHJcbiAgICAgICAgICB9KVxyXG5cclxuICAgICAgICAgIC8vIENyZWF0ZSBpc3N1ZSByZWNvcmRcclxuICAgICAgICAgIGF3YWl0IHRoaXMuY3JlYXRlT3JVcGRhdGVJc3N1ZShydWxlLCBydWxlUmVzdWx0KVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gUmVjb3JkIG1ldHJpY1xyXG4gICAgICAgIGF3YWl0IHRoaXMucmVjb3JkTWV0cmljKHJ1bGUsIHJ1bGVSZXN1bHQpXHJcblxyXG4gICAgICAgIHRvdGFsU2NvcmUgKz0gcnVsZVJlc3VsdC5zY29yZVxyXG4gICAgICAgIHJ1bGVDb3VudCsrXHJcblxyXG4gICAgICAgIHJlc3VsdC5tZXRyaWNzLnB1c2goe1xyXG4gICAgICAgICAgbmFtZTogcnVsZS5uYW1lLFxyXG4gICAgICAgICAgdmFsdWU6IHJ1bGVSZXN1bHQuc2NvcmUsXHJcbiAgICAgICAgICBjYXRlZ29yeTogcnVsZS5ydWxlVHlwZSxcclxuICAgICAgICB9KVxyXG4gICAgICB9XHJcblxyXG4gICAgICByZXN1bHQuc2NvcmUgPSBydWxlQ291bnQgPiAwID8gdG90YWxTY29yZSAvIHJ1bGVDb3VudCA6IDEwMFxyXG5cclxuICAgICAgLy8gUXVldWUgZm9yIGJhY2tncm91bmQgcHJvY2Vzc2luZ1xyXG4gICAgICBhd2FpdCB0aGlzLmRhdGFRdWFsaXR5UXVldWUuYWRkKFwicHJvY2Vzcy1xdWFsaXR5LWNoZWNrXCIsIHtcclxuICAgICAgICBlbnRpdHlUeXBlLFxyXG4gICAgICAgIHJlc3VsdCxcclxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXHJcbiAgICAgIH0pXHJcblxyXG4gICAgICByZXR1cm4gcmVzdWx0XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRGF0YSBxdWFsaXR5IGNoZWNrIGZhaWxlZDogJHtlcnJvci5tZXNzYWdlfWAsIGVycm9yLnN0YWNrKVxyXG4gICAgICB0aHJvdyBlcnJvclxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0QWN0aXZlUnVsZXMoZW50aXR5VHlwZTogc3RyaW5nKTogUHJvbWlzZTxEYXRhUXVhbGl0eVJ1bGVbXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMucnVsZVJlcG9zaXRvcnkuZmluZCh7XHJcbiAgICAgIHdoZXJlOiB7XHJcbiAgICAgICAgZW50aXR5VHlwZSxcclxuICAgICAgICBzdGF0dXM6IFJ1bGVTdGF0dXMuQUNUSVZFLFxyXG4gICAgICB9LFxyXG4gICAgICBvcmRlcjoge1xyXG4gICAgICAgIHNldmVyaXR5OiBcIkRFU0NcIixcclxuICAgICAgICBjcmVhdGVkQXQ6IFwiQVNDXCIsXHJcbiAgICAgIH0sXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgY3JlYXRlUnVsZShydWxlRGF0YTogUGFydGlhbDxEYXRhUXVhbGl0eVJ1bGU+KTogUHJvbWlzZTxEYXRhUXVhbGl0eVJ1bGU+IHtcclxuICAgIGNvbnN0IHJ1bGUgPSB0aGlzLnJ1bGVSZXBvc2l0b3J5LmNyZWF0ZShydWxlRGF0YSlcclxuICAgIHJldHVybiB0aGlzLnJ1bGVSZXBvc2l0b3J5LnNhdmUocnVsZSlcclxuICB9XHJcblxyXG4gIGFzeW5jIHVwZGF0ZVJ1bGUoaWQ6IHN0cmluZywgdXBkYXRlczogUGFydGlhbDxEYXRhUXVhbGl0eVJ1bGU+KTogUHJvbWlzZTxEYXRhUXVhbGl0eVJ1bGU+IHtcclxuICAgIGF3YWl0IHRoaXMucnVsZVJlcG9zaXRvcnkudXBkYXRlKGlkLCB1cGRhdGVzKVxyXG4gICAgY29uc3QgcnVsZSA9IGF3YWl0IHRoaXMucnVsZVJlcG9zaXRvcnkuZmluZE9uZSh7IHdoZXJlOiB7IGlkIH0gfSlcclxuICAgIGlmICghcnVsZSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFJ1bGUgd2l0aCBpZCAke2lkfSBub3QgZm91bmRgKVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJ1bGVcclxuICB9XHJcblxyXG4gIGFzeW5jIGRlbGV0ZVJ1bGUoaWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgdGhpcy5ydWxlUmVwb3NpdG9yeS51cGRhdGUoaWQsIHsgc3RhdHVzOiBSdWxlU3RhdHVzLkRFUFJFQ0FURUQgfSlcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFJ1bGVzKGZpbHRlcnM6IHtcclxuICAgIGVudGl0eVR5cGU/OiBzdHJpbmdcclxuICAgIHJ1bGVUeXBlPzogc3RyaW5nXHJcbiAgICBzdGF0dXM/OiBSdWxlU3RhdHVzXHJcbiAgICBzZXZlcml0eT86IHN0cmluZ1xyXG4gIH0pOiBQcm9taXNlPERhdGFRdWFsaXR5UnVsZVtdPiB7XHJcbiAgICBjb25zdCBxdWVyeSA9IHRoaXMucnVsZVJlcG9zaXRvcnkuY3JlYXRlUXVlcnlCdWlsZGVyKFwicnVsZVwiKVxyXG5cclxuICAgIGlmIChmaWx0ZXJzLmVudGl0eVR5cGUpIHtcclxuICAgICAgcXVlcnkuYW5kV2hlcmUoXCJydWxlLmVudGl0eVR5cGUgPSA6ZW50aXR5VHlwZVwiLCB7IGVudGl0eVR5cGU6IGZpbHRlcnMuZW50aXR5VHlwZSB9KVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChmaWx0ZXJzLnJ1bGVUeXBlKSB7XHJcbiAgICAgIHF1ZXJ5LmFuZFdoZXJlKFwicnVsZS5ydWxlVHlwZSA9IDpydWxlVHlwZVwiLCB7IHJ1bGVUeXBlOiBmaWx0ZXJzLnJ1bGVUeXBlIH0pXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGZpbHRlcnMuc3RhdHVzKSB7XHJcbiAgICAgIHF1ZXJ5LmFuZFdoZXJlKFwicnVsZS5zdGF0dXMgPSA6c3RhdHVzXCIsIHsgc3RhdHVzOiBmaWx0ZXJzLnN0YXR1cyB9KVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChmaWx0ZXJzLnNldmVyaXR5KSB7XHJcbiAgICAgIHF1ZXJ5LmFuZFdoZXJlKFwicnVsZS5zZXZlcml0eSA9IDpzZXZlcml0eVwiLCB7IHNldmVyaXR5OiBmaWx0ZXJzLnNldmVyaXR5IH0pXHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHF1ZXJ5Lm9yZGVyQnkoXCJydWxlLmNyZWF0ZWRBdFwiLCBcIkRFU0NcIikuZ2V0TWFueSgpXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIHZhbGlkYXRlUnVsZShcclxuICAgIHJ1bGU6IERhdGFRdWFsaXR5UnVsZSxcclxuICAgIGRhdGE6IGFueVtdLFxyXG4gICk6IFByb21pc2U8e1xyXG4gICAgcGFzc2VkOiBib29sZWFuXHJcbiAgICBzY29yZTogbnVtYmVyXHJcbiAgICBmYWlsZWREYXRhPzogYW55W11cclxuICAgIGRldGFpbHM/OiBhbnlcclxuICB9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBzd2l0Y2ggKHJ1bGUucnVsZVR5cGUpIHtcclxuICAgICAgICBjYXNlIFwiY29tcGxldGVuZXNzXCI6XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0aW9uU2VydmljZS5jaGVja0NvbXBsZXRlbmVzcyhydWxlLCBkYXRhKVxyXG4gICAgICAgIGNhc2UgXCJhY2N1cmFjeVwiOlxyXG4gICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGlvblNlcnZpY2UuY2hlY2tBY2N1cmFjeShydWxlLCBkYXRhKVxyXG4gICAgICAgIGNhc2UgXCJjb25zaXN0ZW5jeVwiOlxyXG4gICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGlvblNlcnZpY2UuY2hlY2tDb25zaXN0ZW5jeShydWxlLCBkYXRhKVxyXG4gICAgICAgIGNhc2UgXCJ2YWxpZGl0eVwiOlxyXG4gICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGlvblNlcnZpY2UuY2hlY2tWYWxpZGl0eShydWxlLCBkYXRhKVxyXG4gICAgICAgIGNhc2UgXCJ1bmlxdWVuZXNzXCI6XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0aW9uU2VydmljZS5jaGVja1VuaXF1ZW5lc3MocnVsZSwgZGF0YSlcclxuICAgICAgICBjYXNlIFwidGltZWxpbmVzc1wiOlxyXG4gICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGlvblNlcnZpY2UuY2hlY2tUaW1lbGluZXNzKHJ1bGUsIGRhdGEpXHJcbiAgICAgICAgY2FzZSBcImNvbmZvcm1pdHlcIjpcclxuICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRpb25TZXJ2aWNlLmNoZWNrQ29uZm9ybWl0eShydWxlLCBkYXRhKVxyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICByZXR1cm4geyBwYXNzZWQ6IHRydWUsIHNjb3JlOiAxMDAgfVxyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgUnVsZSB2YWxpZGF0aW9uIGZhaWxlZCBmb3IgJHtydWxlLm5hbWV9OiAke2Vycm9yLm1lc3NhZ2V9YClcclxuICAgICAgcmV0dXJuIHsgcGFzc2VkOiBmYWxzZSwgc2NvcmU6IDAsIGRldGFpbHM6IHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIHJlY29yZE1ldHJpYyhydWxlOiBEYXRhUXVhbGl0eVJ1bGUsIHJlc3VsdDogYW55KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zdCBtZXRyaWMgPSB0aGlzLm1ldHJpY1JlcG9zaXRvcnkuY3JlYXRlKHtcclxuICAgICAgcnVsZUlkOiBydWxlLmlkLFxyXG4gICAgICBlbnRpdHlUeXBlOiBydWxlLmVudGl0eVR5cGUsXHJcbiAgICAgIG1ldHJpY0NhdGVnb3J5OiBydWxlLnJ1bGVUeXBlIGFzIGFueSxcclxuICAgICAgbWV0cmljTmFtZTogcnVsZS5uYW1lLFxyXG4gICAgICB2YWx1ZTogcmVzdWx0LnNjb3JlLFxyXG4gICAgICB0aHJlc2hvbGQ6IHJ1bGUudGhyZXNob2xkLFxyXG4gICAgICBwYXNzZWQ6IHJlc3VsdC5wYXNzZWQsXHJcbiAgICAgIGRldGFpbHM6IHJlc3VsdC5kZXRhaWxzLFxyXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXHJcbiAgICB9KVxyXG5cclxuICAgIGF3YWl0IHRoaXMubWV0cmljUmVwb3NpdG9yeS5zYXZlKG1ldHJpYylcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgY3JlYXRlT3JVcGRhdGVJc3N1ZShydWxlOiBEYXRhUXVhbGl0eVJ1bGUsIHJlc3VsdDogYW55KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zdCBleGlzdGluZ0lzc3VlID0gYXdhaXQgdGhpcy5pc3N1ZVJlcG9zaXRvcnkuZmluZE9uZSh7XHJcbiAgICAgIHdoZXJlOiB7XHJcbiAgICAgICAgcnVsZUlkOiBydWxlLmlkLFxyXG4gICAgICAgIHN0YXR1czogXCJvcGVuXCIsXHJcbiAgICAgIH0sXHJcbiAgICB9KVxyXG5cclxuICAgIGlmIChleGlzdGluZ0lzc3VlKSB7XHJcbiAgICAgIC8vIFVwZGF0ZSBleGlzdGluZyBpc3N1ZVxyXG4gICAgICBleGlzdGluZ0lzc3VlLm9jY3VycmVuY2VDb3VudCArPSAxXHJcbiAgICAgIGV4aXN0aW5nSXNzdWUubGFzdE9jY3VycmVuY2UgPSBuZXcgRGF0ZSgpXHJcbiAgICAgIGV4aXN0aW5nSXNzdWUuaXNzdWVEYXRhID0gcmVzdWx0LmZhaWxlZERhdGEgfHwge31cclxuICAgICAgYXdhaXQgdGhpcy5pc3N1ZVJlcG9zaXRvcnkuc2F2ZShleGlzdGluZ0lzc3VlKVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gQ3JlYXRlIG5ldyBpc3N1ZVxyXG4gICAgICBjb25zdCBpc3N1ZSA9IHRoaXMuaXNzdWVSZXBvc2l0b3J5LmNyZWF0ZSh7XHJcbiAgICAgICAgcnVsZUlkOiBydWxlLmlkLFxyXG4gICAgICAgIGVudGl0eVR5cGU6IHJ1bGUuZW50aXR5VHlwZSxcclxuICAgICAgICB0aXRsZTogYERhdGEgUXVhbGl0eSBJc3N1ZTogJHtydWxlLm5hbWV9YCxcclxuICAgICAgICBkZXNjcmlwdGlvbjogcnVsZS5lcnJvck1lc3NhZ2UgfHwgYFJ1bGUgJHtydWxlLm5hbWV9IHZhbGlkYXRpb24gZmFpbGVkYCxcclxuICAgICAgICBwcmlvcml0eTogcnVsZS5zZXZlcml0eSBhcyBhbnksXHJcbiAgICAgICAgaXNzdWVEYXRhOiByZXN1bHQuZmFpbGVkRGF0YSB8fCB7fSxcclxuICAgICAgICBjb250ZXh0OiByZXN1bHQuZGV0YWlscyxcclxuICAgICAgICBvY2N1cnJlbmNlQ291bnQ6IDEsXHJcbiAgICAgICAgZmlyc3RPY2N1cnJlbmNlOiBuZXcgRGF0ZSgpLFxyXG4gICAgICAgIGxhc3RPY2N1cnJlbmNlOiBuZXcgRGF0ZSgpLFxyXG4gICAgICB9KVxyXG4gICAgICBhd2FpdCB0aGlzLmlzc3VlUmVwb3NpdG9yeS5zYXZlKGlzc3VlKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0UXVhbGl0eU1ldHJpY3MoZmlsdGVyczoge1xyXG4gICAgZW50aXR5VHlwZT86IHN0cmluZ1xyXG4gICAgc3RhcnREYXRlPzogRGF0ZVxyXG4gICAgZW5kRGF0ZT86IERhdGVcclxuICAgIG1ldHJpY0NhdGVnb3J5Pzogc3RyaW5nXHJcbiAgfSk6IFByb21pc2U8RGF0YVF1YWxpdHlNZXRyaWNbXT4ge1xyXG4gICAgY29uc3QgcXVlcnkgPSB0aGlzLm1ldHJpY1JlcG9zaXRvcnkuY3JlYXRlUXVlcnlCdWlsZGVyKFwibWV0cmljXCIpXHJcblxyXG4gICAgaWYgKGZpbHRlcnMuZW50aXR5VHlwZSkge1xyXG4gICAgICBxdWVyeS5hbmRXaGVyZShcIm1ldHJpYy5lbnRpdHlUeXBlID0gOmVudGl0eVR5cGVcIiwgeyBlbnRpdHlUeXBlOiBmaWx0ZXJzLmVudGl0eVR5cGUgfSlcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZmlsdGVycy5zdGFydERhdGUpIHtcclxuICAgICAgcXVlcnkuYW5kV2hlcmUoXCJtZXRyaWMudGltZXN0YW1wID49IDpzdGFydERhdGVcIiwgeyBzdGFydERhdGU6IGZpbHRlcnMuc3RhcnREYXRlIH0pXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGZpbHRlcnMuZW5kRGF0ZSkge1xyXG4gICAgICBxdWVyeS5hbmRXaGVyZShcIm1ldHJpYy50aW1lc3RhbXAgPD0gOmVuZERhdGVcIiwgeyBlbmREYXRlOiBmaWx0ZXJzLmVuZERhdGUgfSlcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZmlsdGVycy5tZXRyaWNDYXRlZ29yeSkge1xyXG4gICAgICBxdWVyeS5hbmRXaGVyZShcIm1ldHJpYy5tZXRyaWNDYXRlZ29yeSA9IDptZXRyaWNDYXRlZ29yeVwiLCB7IG1ldHJpY0NhdGVnb3J5OiBmaWx0ZXJzLm1ldHJpY0NhdGVnb3J5IH0pXHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHF1ZXJ5Lm9yZGVyQnkoXCJtZXRyaWMudGltZXN0YW1wXCIsIFwiREVTQ1wiKS5nZXRNYW55KClcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFF1YWxpdHlJc3N1ZXMoZmlsdGVyczoge1xyXG4gICAgc3RhdHVzPzogc3RyaW5nXHJcbiAgICBwcmlvcml0eT86IHN0cmluZ1xyXG4gICAgZW50aXR5VHlwZT86IHN0cmluZ1xyXG4gICAgYXNzaWduZWRUbz86IHN0cmluZ1xyXG4gIH0pOiBQcm9taXNlPERhdGFRdWFsaXR5SXNzdWVbXT4ge1xyXG4gICAgY29uc3QgcXVlcnkgPSB0aGlzLmlzc3VlUmVwb3NpdG9yeS5jcmVhdGVRdWVyeUJ1aWxkZXIoXCJpc3N1ZVwiKVxyXG5cclxuICAgIGlmIChmaWx0ZXJzLnN0YXR1cykge1xyXG4gICAgICBxdWVyeS5hbmRXaGVyZShcImlzc3VlLnN0YXR1cyA9IDpzdGF0dXNcIiwgeyBzdGF0dXM6IGZpbHRlcnMuc3RhdHVzIH0pXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGZpbHRlcnMucHJpb3JpdHkpIHtcclxuICAgICAgcXVlcnkuYW5kV2hlcmUoXCJpc3N1ZS5wcmlvcml0eSA9IDpwcmlvcml0eVwiLCB7IHByaW9yaXR5OiBmaWx0ZXJzLnByaW9yaXR5IH0pXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGZpbHRlcnMuZW50aXR5VHlwZSkge1xyXG4gICAgICBxdWVyeS5hbmRXaGVyZShcImlzc3VlLmVudGl0eVR5cGUgPSA6ZW50aXR5VHlwZVwiLCB7IGVudGl0eVR5cGU6IGZpbHRlcnMuZW50aXR5VHlwZSB9KVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChmaWx0ZXJzLmFzc2lnbmVkVG8pIHtcclxuICAgICAgcXVlcnkuYW5kV2hlcmUoXCJpc3N1ZS5hc3NpZ25lZFRvID0gOmFzc2lnbmVkVG9cIiwgeyBhc3NpZ25lZFRvOiBmaWx0ZXJzLmFzc2lnbmVkVG8gfSlcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcXVlcnkub3JkZXJCeShcImlzc3VlLmNyZWF0ZWRBdFwiLCBcIkRFU0NcIikuZ2V0TWFueSgpXHJcbiAgfVxyXG5cclxuICBhc3luYyByZXNvbHZlSXNzdWUoaXNzdWVJZDogc3RyaW5nLCByZXNvbHV0aW9uOiBzdHJpbmcsIHJlc29sdmVkQnk6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgdGhpcy5pc3N1ZVJlcG9zaXRvcnkudXBkYXRlKGlzc3VlSWQsIHtcclxuICAgICAgc3RhdHVzOiBcInJlc29sdmVkXCIgYXMgYW55LFxyXG4gICAgICByZXNvbHV0aW9uLFxyXG4gICAgICByZXNvbHZlZEJ5LFxyXG4gICAgICByZXNvbHZlZEF0OiBuZXcgRGF0ZSgpLFxyXG4gICAgfSlcclxuICB9XHJcbn1cclxuIl0sInZlcnNpb24iOjN9