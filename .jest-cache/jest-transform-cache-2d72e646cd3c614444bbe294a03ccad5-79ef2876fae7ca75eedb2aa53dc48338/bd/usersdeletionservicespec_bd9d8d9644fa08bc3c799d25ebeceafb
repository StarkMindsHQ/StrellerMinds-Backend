d3cf9de56478d9c36adf89e695f5811b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const user_entity_1 = require("../entities/user.entity");
const wallet_info_entity_1 = require("../entities/wallet-info.entity");
const config_1 = require("@nestjs/config");
const common_1 = require("@nestjs/common");
const user_progress_entity_1 = require("../entities/user-progress.entity");
const users_deletion_service_1 = require("./users.deletion.service");
const audit_log_service_1 = require("src/audit/services/audit.log.service");
const account_deletion_confirmation_service_1 = require("./account.deletion.confirmation.service");
const accountStatus_enum_1 = require("../enums/accountStatus.enum");
describe('UserDeletionService', () => {
    let service;
    let userRepository;
    let walletInfoRepository;
    let userProgressRepository;
    let auditLogService;
    let confirmationService;
    let connection;
    const mockQueryRunner = {
        connect: jest.fn(),
        startTransaction: jest.fn(),
        commitTransaction: jest.fn(),
        rollbackTransaction: jest.fn(),
        release: jest.fn(),
        manager: {
            update: jest.fn(),
            save: jest.fn(),
            softDelete: jest.fn(),
            delete: jest.fn(),
        },
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                users_deletion_service_1.UserDeletionService,
                {
                    provide: (0, typeorm_1.getRepositoryToken)(user_entity_1.User),
                    useValue: {
                        findOne: jest.fn(),
                        save: jest.fn(),
                        update: jest.fn(),
                        delete: jest.fn(),
                    },
                },
                {
                    provide: (0, typeorm_1.getRepositoryToken)(wallet_info_entity_1.WalletInfo),
                    useValue: {
                        findOne: jest.fn(),
                        update: jest.fn(),
                        delete: jest.fn(),
                    },
                },
                {
                    provide: (0, typeorm_1.getRepositoryToken)(user_progress_entity_1.UserProgress),
                    useValue: {
                        delete: jest.fn(),
                    },
                },
                {
                    provide: audit_log_service_1.AuditLogService,
                    useValue: {
                        createLog: jest.fn().mockResolvedValue({}),
                    },
                },
                {
                    provide: account_deletion_confirmation_service_1.AccountDeletionConfirmationService,
                    useValue: {
                        startDeletionConfirmationWorkflow: jest
                            .fn()
                            .mockResolvedValue(undefined),
                        validateDeletionConfirmation: jest.fn().mockResolvedValue(true),
                    },
                },
                {
                    provide: config_1.ConfigService,
                    useValue: {
                        get: jest.fn().mockImplementation((key, defaultValue) => {
                            if (key === 'DATA_RETENTION_PERIOD')
                                return 30;
                            return defaultValue;
                        }),
                    },
                },
                {
                    provide: typeorm_2.Connection,
                    useValue: {
                        createQueryRunner: jest.fn().mockReturnValue(mockQueryRunner),
                    },
                },
            ],
        }).compile();
        service = module.get(users_deletion_service_1.UserDeletionService);
        userRepository = module.get((0, typeorm_1.getRepositoryToken)(user_entity_1.User));
        walletInfoRepository = module.get((0, typeorm_1.getRepositoryToken)(wallet_info_entity_1.WalletInfo));
        userProgressRepository = module.get((0, typeorm_1.getRepositoryToken)(user_progress_entity_1.UserProgress));
        auditLogService = module.get(audit_log_service_1.AuditLogService);
        confirmationService = module.get(account_deletion_confirmation_service_1.AccountDeletionConfirmationService);
        connection = module.get(typeorm_2.Connection);
    });
    it('should be defined', () => {
        expect(service).toBeDefined();
    });
    describe('deactivateAccount', () => {
        it('should deactivate user account', async () => {
            const mockUser = { id: 'user-id', email: 'test@example.com' };
            jest.spyOn(userRepository, 'findOne').mockResolvedValue(mockUser);
            await service.deactivateAccount('user-id', 'requester-id');
            expect(mockQueryRunner.connect).toHaveBeenCalled();
            expect(mockQueryRunner.startTransaction).toHaveBeenCalled();
            expect(mockQueryRunner.manager.save).toHaveBeenCalledWith({
                ...mockUser,
                status: accountStatus_enum_1.AccountStatus.DEACTIVATED,
                deactivatedAt: expect.any(Date),
            });
            expect(auditLogService.createLog).toHaveBeenCalledWith({
                action: 'ACCOUNT_DEACTIVATION',
                entityType: 'USER',
                entityId: 'user-id',
                performedBy: 'requester-id',
                details: expect.any(Object),
            });
            expect(mockQueryRunner.commitTransaction).toHaveBeenCalled();
            expect(mockQueryRunner.release).toHaveBeenCalled();
        });
        it('should throw NotFoundException if user not found', async () => {
            jest.spyOn(userRepository, 'findOne').mockResolvedValue(null);
            await expect(service.deactivateAccount('non-existent-id', 'requester-id')).rejects.toThrow(common_1.NotFoundException);
        });
        it('should rollback transaction on error', async () => {
            const mockUser = { id: 'user-id', email: 'test@example.com' };
            jest.spyOn(userRepository, 'findOne').mockResolvedValue(mockUser);
            jest
                .spyOn(mockQueryRunner.manager, 'save')
                .mockRejectedValue(new Error('Database error'));
            await expect(service.deactivateAccount('user-id', 'requester-id')).rejects.toThrow('Database error');
            expect(mockQueryRunner.rollbackTransaction).toHaveBeenCalled();
            expect(mockQueryRunner.release).toHaveBeenCalled();
        });
    });
    describe('requestAccountDeletion', () => {
        it('should start deletion workflow', async () => {
            const mockUser = {
                id: 'user-id',
                email: 'test@example.com',
                role: 'STUDENT',
            };
            jest.spyOn(userRepository, 'findOne').mockResolvedValue(mockUser);
            await service.requestAccountDeletion('user-id', 'user-id');
            expect(userRepository.save).toHaveBeenCalledWith({
                ...mockUser,
                status: accountStatus_enum_1.AccountStatus.PENDING_DELETION,
                deletionRequestedAt: expect.any(Date),
            });
            expect(confirmationService.startDeletionConfirmationWorkflow).toHaveBeenCalledWith('user-id');
            expect(auditLogService.createLog).toHaveBeenCalled();
        });
        it('should throw error if user tries to delete another user without admin rights', async () => {
            const mockUser = {
                id: 'user-id',
                email: 'test@example.com',
                role: 'STUDENT',
            };
            const mockRequester = {
                id: 'requester-id',
                email: 'requester@example.com',
                role: 'STUDENT',
            };
            jest
                .spyOn(userRepository, 'findOne')
                .mockResolvedValueOnce(mockUser)
                .mockResolvedValueOnce(mockRequester);
            await expect(service.requestAccountDeletion('user-id', 'requester-id')).rejects.toThrow(common_1.BadRequestException);
        });
    });
    describe('confirmAccountDeletion', () => {
        it('should confirm and perform deletion with valid token', async () => {
            jest
                .spyOn(confirmationService, 'validateDeletionConfirmation')
                .mockResolvedValue(true);
            jest
                .spyOn(service, 'performAccountDeletion')
                .mockResolvedValue(undefined);
            await service.confirmAccountDeletion('user-id', 'valid-token');
            expect(confirmationService.validateDeletionConfirmation).toHaveBeenCalledWith('user-id', 'valid-token');
            expect(service.performAccountDeletion).toHaveBeenCalledWith('user-id', 'user-id');
        });
        it('should throw error with invalid token', async () => {
            jest
                .spyOn(confirmationService, 'validateDeletionConfirmation')
                .mockResolvedValue(false);
            await expect(service.confirmAccountDeletion('user-id', 'invalid-token')).rejects.toThrow(common_1.BadRequestException);
            expect(service.performAccountDeletion).not.toHaveBeenCalled();
        });
    });
    describe('performAccountDeletion', () => {
        it('should perform full deletion process', async () => {
            const mockUser = { id: 'user-id', email: 'test@example.com' };
            const mockWallet = { id: 'wallet-id', walletAddress: '0x123' };
            jest.spyOn(userRepository, 'findOne').mockResolvedValue(mockUser);
            jest
                .spyOn(walletInfoRepository, 'findOne')
                .mockResolvedValue(mockWallet);
            jest
                .spyOn(service, 'scheduleDataPurge')
                .mockImplementation(() => { });
            await service.performAccountDeletion('user-id', 'requester-id');
            expect(mockQueryRunner.manager.update).toHaveBeenCalledWith(user_entity_1.User, 'user-id', expect.objectContaining({
                firstName: '[REDACTED]',
                lastName: '[REDACTED]',
            }));
            expect(mockQueryRunner.manager.update).toHaveBeenCalledWith(wallet_info_entity_1.WalletInfo, 'wallet-id', expect.objectContaining({
                orphaned: true,
                orphanedAt: expect.any(Date),
            }));
            expect(mockQueryRunner.manager.softDelete).toHaveBeenCalledWith(user_progress_entity_1.UserProgress, { user: { id: 'user-id' } });
            expect(mockQueryRunner.manager.save).toHaveBeenCalled();
            expect(auditLogService.createLog).toHaveBeenCalled();
            expect(service.scheduleDataPurge).toHaveBeenCalledWith('user-id');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFx1c2Vyc1xcc2VydmljZXNcXHVzZXJzLmRlbGV0aW9uLnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDZDQUFzRDtBQUN0RCw2Q0FBcUQ7QUFDckQscUNBQWlEO0FBQ2pELHlEQUErQztBQUMvQyx1RUFBNEQ7QUFDNUQsMkNBQStDO0FBQy9DLDJDQUF3RTtBQUN4RSwyRUFBZ0U7QUFDaEUscUVBQStEO0FBQy9ELDRFQUF1RTtBQUN2RSxtR0FBNkY7QUFDN0Ysb0VBQTREO0FBRTVELFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLEVBQUU7SUFDbkMsSUFBSSxPQUE0QixDQUFDO0lBQ2pDLElBQUksY0FBZ0MsQ0FBQztJQUNyQyxJQUFJLG9CQUE0QyxDQUFDO0lBQ2pELElBQUksc0JBQWdELENBQUM7SUFDckQsSUFBSSxlQUFnQyxDQUFDO0lBQ3JDLElBQUksbUJBQXVELENBQUM7SUFDNUQsSUFBSSxVQUFzQixDQUFDO0lBRTNCLE1BQU0sZUFBZSxHQUFHO1FBQ3RCLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2xCLGdCQUFnQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDM0IsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUM1QixtQkFBbUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQzlCLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ2xCLE9BQU8sRUFBRTtZQUNQLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2pCLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2YsVUFBVSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDckIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDbEI7S0FDRixDQUFDO0lBRUYsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLE1BQU0s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QUNILENBQUM7WUFFRixNQUFNLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxvQkFBb0IsQ0FDekQsK0JBQVUsRUFDVixXQUFXLEVBQ1gsTUFBTSxDQUFDLGdCQUFnQixDQUFDO2dCQUN0QixRQUFRLEVBQUUsSUFBSTtnQkFDZCxVQUFVLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7YUFDN0IsQ0FBQyxDQUNILENBQUM7WUFFRixNQUFNLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxvQkFBb0IsQ0FDN0QsbUNBQVksRUFDWixFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsRUFBRSxDQUM1QixDQUFDO1lBQ0YsTUFBTSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUN4RCxNQUFNLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDckQsTUFBTSxDQUFFLE9BQWUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLG9CQUFvQixDQUM3RCxTQUFTLENBQ1YsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGctZWtvaFxcRGVza3RvcFxcU3RyZWxsZXJNaW5kcy1CYWNrZW5kXFxzcmNcXHVzZXJzXFxzZXJ2aWNlc1xcdXNlcnMuZGVsZXRpb24uc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xyXG5pbXBvcnQgeyBnZXRSZXBvc2l0b3J5VG9rZW4gfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xyXG5pbXBvcnQgeyBDb25uZWN0aW9uLCBSZXBvc2l0b3J5IH0gZnJvbSAndHlwZW9ybSc7XHJcbmltcG9ydCB7IFVzZXIgfSBmcm9tICcuLi9lbnRpdGllcy91c2VyLmVudGl0eSc7XHJcbmltcG9ydCB7IFdhbGxldEluZm8gfSBmcm9tICcuLi9lbnRpdGllcy93YWxsZXQtaW5mby5lbnRpdHknO1xyXG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xyXG5pbXBvcnQgeyBOb3RGb3VuZEV4Y2VwdGlvbiwgQmFkUmVxdWVzdEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcclxuaW1wb3J0IHsgVXNlclByb2dyZXNzIH0gZnJvbSAnLi4vZW50aXRpZXMvdXNlci1wcm9ncmVzcy5lbnRpdHknO1xyXG5pbXBvcnQgeyBVc2VyRGVsZXRpb25TZXJ2aWNlIH0gZnJvbSAnLi91c2Vycy5kZWxldGlvbi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQXVkaXRMb2dTZXJ2aWNlIH0gZnJvbSAnc3JjL2F1ZGl0L3NlcnZpY2VzL2F1ZGl0LmxvZy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQWNjb3VudERlbGV0aW9uQ29uZmlybWF0aW9uU2VydmljZSB9IGZyb20gJy4vYWNjb3VudC5kZWxldGlvbi5jb25maXJtYXRpb24uc2VydmljZSc7XHJcbmltcG9ydCB7IEFjY291bnRTdGF0dXMgfSBmcm9tICcuLi9lbnVtcy9hY2NvdW50U3RhdHVzLmVudW0nO1xyXG5cclxuZGVzY3JpYmUoJ1VzZXJEZWxldGlvblNlcnZpY2UnLCAoKSA9PiB7XHJcbiAgbGV0IHNlcnZpY2U6IFVzZXJEZWxldGlvblNlcnZpY2U7XHJcbiAgbGV0IHVzZXJSZXBvc2l0b3J5OiBSZXBvc2l0b3J5PFVzZXI+O1xyXG4gIGxldCB3YWxsZXRJbmZvUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxXYWxsZXRJbmZvPjtcclxuICBsZXQgdXNlclByb2dyZXNzUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxVc2VyUHJvZ3Jlc3M+O1xyXG4gIGxldCBhdWRpdExvZ1NlcnZpY2U6IEF1ZGl0TG9nU2VydmljZTtcclxuICBsZXQgY29uZmlybWF0aW9uU2VydmljZTogQWNjb3VudERlbGV0aW9uQ29uZmlybWF0aW9uU2VydmljZTtcclxuICBsZXQgY29ubmVjdGlvbjogQ29ubmVjdGlvbjtcclxuXHJcbiAgY29uc3QgbW9ja1F1ZXJ5UnVubmVyID0ge1xyXG4gICAgY29ubmVjdDogamVzdC5mbigpLFxyXG4gICAgc3RhcnRUcmFuc2FjdGlvbjogamVzdC5mbigpLFxyXG4gICAgY29tbWl0VHJhbnNhY3Rpb246IGplc3QuZm4oKSxcclxuICAgIHJvbGxiYWNrVHJhbnNhY3Rpb246IGplc3QuZm4oKSxcclxuICAgIHJlbGVhc2U6IGplc3QuZm4oKSxcclxuICAgIG1hbmFnZXI6IHtcclxuICAgICAgdXBkYXRlOiBqZXN0LmZuKCksXHJcbiAgICAgIHNhdmU6IGplc3QuZm4oKSxcclxuICAgICAgc29mdERlbGV0ZTogamVzdC5mbigpLFxyXG4gICAgICBkZWxldGU6IGplc3QuZm4oKSxcclxuICAgIH0sXHJcbiAgfTtcclxuXHJcbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xyXG4gICAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICBVc2VyRGVsZXRpb25TZXJ2aWNlLFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIHByb3ZpZGU6IGdldFJlcG9zaXRvcnlUb2tlbihVc2VyKSxcclxuICAgICAgICAgIHVzZVZhbHVlOiB7XHJcbiAgICAgICAgICAgIGZpbmRPbmU6IGplc3QuZm4oKSxcclxuICAgICAgICAgICAgc2F2ZTogamVzdC5mbigpLFxyXG4gICAgICAgICAgICB1cGRhdGU6IGplc3QuZm4oKSxcclxuICAgICAgICAgICAgZGVsZXRlOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogZ2V0UmVwb3NpdG9yeVRva2VuKFdhbGxldEluZm8pLFxyXG4gICAgICAgICAgdXNlVmFsdWU6IHtcclxuICAgICAgICAgICAgZmluZE9uZTogamVzdC5mbigpLFxyXG4gICAgICAgICAgICB1cGRhdGU6IGplc3QuZm4oKSxcclxuICAgICAgICAgICAgZGVsZXRlOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogZ2V0UmVwb3NpdG9yeVRva2VuKFVzZXJQcm9ncmVzcyksXHJcbiAgICAgICAgICB1c2VWYWx1ZToge1xyXG4gICAgICAgICAgICBkZWxldGU6IGplc3QuZm4oKSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBwcm92aWRlOiBBdWRpdExvZ1NlcnZpY2UsXHJcbiAgICAgICAgICB1c2VWYWx1ZToge1xyXG4gICAgICAgICAgICBjcmVhdGVMb2c6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogQWNjb3VudERlbGV0aW9uQ29uZmlybWF0aW9uU2VydmljZSxcclxuICAgICAgICAgIHVzZVZhbHVlOiB7XHJcbiAgICAgICAgICAgIHN0YXJ0RGVsZXRpb25Db25maXJtYXRpb25Xb3JrZmxvdzogamVzdFxyXG4gICAgICAgICAgICAgIC5mbigpXHJcbiAgICAgICAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCksXHJcbiAgICAgICAgICAgIHZhbGlkYXRlRGVsZXRpb25Db25maXJtYXRpb246IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh0cnVlKSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBwcm92aWRlOiBDb25maWdTZXJ2aWNlLFxyXG4gICAgICAgICAgdXNlVmFsdWU6IHtcclxuICAgICAgICAgICAgZ2V0OiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChrZXksIGRlZmF1bHRWYWx1ZSkgPT4ge1xyXG4gICAgICAgICAgICAgIGlmIChrZXkgPT09ICdEQVRBX1JFVEVOVElPTl9QRVJJT0QnKSByZXR1cm4gMzA7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTtcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogQ29ubmVjdGlvbixcclxuICAgICAgICAgIHVzZVZhbHVlOiB7XHJcbiAgICAgICAgICAgIGNyZWF0ZVF1ZXJ5UnVubmVyOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKG1vY2tRdWVyeVJ1bm5lciksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0sXHJcbiAgICB9KS5jb21waWxlKCk7XHJcblxyXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8VXNlckRlbGV0aW9uU2VydmljZT4oVXNlckRlbGV0aW9uU2VydmljZSk7XHJcbiAgICB1c2VyUmVwb3NpdG9yeSA9IG1vZHVsZS5nZXQ8UmVwb3NpdG9yeTxVc2VyPj4oZ2V0UmVwb3NpdG9yeVRva2VuKFVzZXIpKTtcclxuICAgIHdhbGxldEluZm9SZXBvc2l0b3J5ID0gbW9kdWxlLmdldDxSZXBvc2l0b3J5PFdhbGxldEluZm8+PihcclxuICAgICAgZ2V0UmVwb3NpdG9yeVRva2VuKFdhbGxldEluZm8pLFxyXG4gICAgKTtcclxuICAgIHVzZXJQcm9ncmVzc1JlcG9zaXRvcnkgPSBtb2R1bGUuZ2V0PFJlcG9zaXRvcnk8VXNlclByb2dyZXNzPj4oXHJcbiAgICAgIGdldFJlcG9zaXRvcnlUb2tlbihVc2VyUHJvZ3Jlc3MpLFxyXG4gICAgKTtcclxuICAgIGF1ZGl0TG9nU2VydmljZSA9IG1vZHVsZS5nZXQ8QXVkaXRMb2dTZXJ2aWNlPihBdWRpdExvZ1NlcnZpY2UpO1xyXG4gICAgY29uZmlybWF0aW9uU2VydmljZSA9IG1vZHVsZS5nZXQ8QWNjb3VudERlbGV0aW9uQ29uZmlybWF0aW9uU2VydmljZT4oXHJcbiAgICAgIEFjY291bnREZWxldGlvbkNvbmZpcm1hdGlvblNlcnZpY2UsXHJcbiAgICApO1xyXG4gICAgY29ubmVjdGlvbiA9IG1vZHVsZS5nZXQ8Q29ubmVjdGlvbj4oQ29ubmVjdGlvbik7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgYmUgZGVmaW5lZCcsICgpID0+IHtcclxuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZGVhY3RpdmF0ZUFjY291bnQnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGRlYWN0aXZhdGUgdXNlciBhY2NvdW50JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrVXNlciA9IHsgaWQ6ICd1c2VyLWlkJywgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyB9O1xyXG4gICAgICBqZXN0LnNweU9uKHVzZXJSZXBvc2l0b3J5LCAnZmluZE9uZScpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc2VyIGFzIGFueSk7XHJcblxyXG4gICAgICBhd2FpdCBzZXJ2aWNlLmRlYWN0aXZhdGVBY2NvdW50KCd1c2VyLWlkJywgJ3JlcXVlc3Rlci1pZCcpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tRdWVyeVJ1bm5lci5jb25uZWN0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICAgIGV4cGVjdChtb2NrUXVlcnlSdW5uZXIuc3RhcnRUcmFuc2FjdGlvbikudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICBleHBlY3QobW9ja1F1ZXJ5UnVubmVyLm1hbmFnZXIuc2F2ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xyXG4gICAgICAgIC4uLm1vY2tVc2VyLFxyXG4gICAgICAgIHN0YXR1czogQWNjb3VudFN0YXR1cy5ERUFDVElWQVRFRCxcclxuICAgICAgICBkZWFjdGl2YXRlZEF0OiBleHBlY3QuYW55KERhdGUpLFxyXG4gICAgICB9KTtcclxuICAgICAgZXhwZWN0KGF1ZGl0TG9nU2VydmljZS5jcmVhdGVMb2cpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcclxuICAgICAgICBhY3Rpb246ICdBQ0NPVU5UX0RFQUNUSVZBVElPTicsXHJcbiAgICAgICAgZW50aXR5VHlwZTogJ1VTRVInLFxyXG4gICAgICAgIGVudGl0eUlkOiAndXNlci1pZCcsXHJcbiAgICAgICAgcGVyZm9ybWVkQnk6ICdyZXF1ZXN0ZXItaWQnLFxyXG4gICAgICAgIGRldGFpbHM6IGV4cGVjdC5hbnkoT2JqZWN0KSxcclxuICAgICAgfSk7XHJcbiAgICAgIGV4cGVjdChtb2NrUXVlcnlSdW5uZXIuY29tbWl0VHJhbnNhY3Rpb24pLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgZXhwZWN0KG1vY2tRdWVyeVJ1bm5lci5yZWxlYXNlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHRocm93IE5vdEZvdW5kRXhjZXB0aW9uIGlmIHVzZXIgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBqZXN0LnNweU9uKHVzZXJSZXBvc2l0b3J5LCAnZmluZE9uZScpLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgIHNlcnZpY2UuZGVhY3RpdmF0ZUFjY291bnQoJ25vbi1leGlzdGVudC1pZCcsICdyZXF1ZXN0ZXItaWQnKSxcclxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coTm90Rm91bmRFeGNlcHRpb24pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCByb2xsYmFjayB0cmFuc2FjdGlvbiBvbiBlcnJvcicsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja1VzZXIgPSB7IGlkOiAndXNlci1pZCcsIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScgfTtcclxuICAgICAgamVzdC5zcHlPbih1c2VyUmVwb3NpdG9yeSwgJ2ZpbmRPbmUnKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlciBhcyBhbnkpO1xyXG4gICAgICBqZXN0XHJcbiAgICAgICAgLnNweU9uKG1vY2tRdWVyeVJ1bm5lci5tYW5hZ2VyLCAnc2F2ZScpXHJcbiAgICAgICAgLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignRGF0YWJhc2UgZXJyb3InKSk7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3QoXHJcbiAgICAgICAgc2VydmljZS5kZWFjdGl2YXRlQWNjb3VudCgndXNlci1pZCcsICdyZXF1ZXN0ZXItaWQnKSxcclxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coJ0RhdGFiYXNlIGVycm9yJyk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja1F1ZXJ5UnVubmVyLnJvbGxiYWNrVHJhbnNhY3Rpb24pLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgZXhwZWN0KG1vY2tRdWVyeVJ1bm5lci5yZWxlYXNlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ3JlcXVlc3RBY2NvdW50RGVsZXRpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHN0YXJ0IGRlbGV0aW9uIHdvcmtmbG93JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrVXNlciA9IHtcclxuICAgICAgICBpZDogJ3VzZXItaWQnLFxyXG4gICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXHJcbiAgICAgICAgcm9sZTogJ1NUVURFTlQnLFxyXG4gICAgICB9O1xyXG4gICAgICBqZXN0LnNweU9uKHVzZXJSZXBvc2l0b3J5LCAnZmluZE9uZScpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc2VyIGFzIGFueSk7XHJcblxyXG4gICAgICBhd2FpdCBzZXJ2aWNlLnJlcXVlc3RBY2NvdW50RGVsZXRpb24oJ3VzZXItaWQnLCAndXNlci1pZCcpO1xyXG5cclxuICAgICAgZXhwZWN0KHVzZXJSZXBvc2l0b3J5LnNhdmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcclxuICAgICAgICAuLi5tb2NrVXNlcixcclxuICAgICAgICBzdGF0dXM6IEFjY291bnRTdGF0dXMuUEVORElOR19ERUxFVElPTixcclxuICAgICAgICBkZWxldGlvblJlcXVlc3RlZEF0OiBleHBlY3QuYW55KERhdGUpLFxyXG4gICAgICB9KTtcclxuICAgICAgZXhwZWN0KFxyXG4gICAgICAgIGNvbmZpcm1hdGlvblNlcnZpY2Uuc3RhcnREZWxldGlvbkNvbmZpcm1hdGlvbldvcmtmbG93LFxyXG4gICAgICApLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd1c2VyLWlkJyk7XHJcbiAgICAgIGV4cGVjdChhdWRpdExvZ1NlcnZpY2UuY3JlYXRlTG9nKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIGlmIHVzZXIgdHJpZXMgdG8gZGVsZXRlIGFub3RoZXIgdXNlciB3aXRob3V0IGFkbWluIHJpZ2h0cycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja1VzZXIgPSB7XHJcbiAgICAgICAgaWQ6ICd1c2VyLWlkJyxcclxuICAgICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxyXG4gICAgICAgIHJvbGU6ICdTVFVERU5UJyxcclxuICAgICAgfTtcclxuICAgICAgY29uc3QgbW9ja1JlcXVlc3RlciA9IHtcclxuICAgICAgICBpZDogJ3JlcXVlc3Rlci1pZCcsXHJcbiAgICAgICAgZW1haWw6ICdyZXF1ZXN0ZXJAZXhhbXBsZS5jb20nLFxyXG4gICAgICAgIHJvbGU6ICdTVFVERU5UJyxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIGplc3RcclxuICAgICAgICAuc3B5T24odXNlclJlcG9zaXRvcnksICdmaW5kT25lJylcclxuICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWVPbmNlKG1vY2tVc2VyIGFzIGFueSlcclxuICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWVPbmNlKG1vY2tSZXF1ZXN0ZXIgYXMgYW55KTtcclxuXHJcbiAgICAgIGF3YWl0IGV4cGVjdChcclxuICAgICAgICBzZXJ2aWNlLnJlcXVlc3RBY2NvdW50RGVsZXRpb24oJ3VzZXItaWQnLCAncmVxdWVzdGVyLWlkJyksXHJcbiAgICAgICkucmVqZWN0cy50b1Rocm93KEJhZFJlcXVlc3RFeGNlcHRpb24pO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdjb25maXJtQWNjb3VudERlbGV0aW9uJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjb25maXJtIGFuZCBwZXJmb3JtIGRlbGV0aW9uIHdpdGggdmFsaWQgdG9rZW4nLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGplc3RcclxuICAgICAgICAuc3B5T24oY29uZmlybWF0aW9uU2VydmljZSwgJ3ZhbGlkYXRlRGVsZXRpb25Db25maXJtYXRpb24nKVxyXG4gICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZSh0cnVlKTtcclxuICAgICAgamVzdFxyXG4gICAgICAgIC5zcHlPbihzZXJ2aWNlIGFzIGFueSwgJ3BlcmZvcm1BY2NvdW50RGVsZXRpb24nKVxyXG4gICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xyXG5cclxuICAgICAgYXdhaXQgc2VydmljZS5jb25maXJtQWNjb3VudERlbGV0aW9uKCd1c2VyLWlkJywgJ3ZhbGlkLXRva2VuJyk7XHJcblxyXG4gICAgICBleHBlY3QoXHJcbiAgICAgICAgY29uZmlybWF0aW9uU2VydmljZS52YWxpZGF0ZURlbGV0aW9uQ29uZmlybWF0aW9uLFxyXG4gICAgICApLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd1c2VyLWlkJywgJ3ZhbGlkLXRva2VuJyk7XHJcbiAgICAgIGV4cGVjdCgoc2VydmljZSBhcyBhbnkpLnBlcmZvcm1BY2NvdW50RGVsZXRpb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICd1c2VyLWlkJyxcclxuICAgICAgICAndXNlci1pZCcsXHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIHdpdGggaW52YWxpZCB0b2tlbicsIGFzeW5jICgpID0+IHtcclxuICAgICAgamVzdFxyXG4gICAgICAgIC5zcHlPbihjb25maXJtYXRpb25TZXJ2aWNlLCAndmFsaWRhdGVEZWxldGlvbkNvbmZpcm1hdGlvbicpXHJcbiAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlKGZhbHNlKTtcclxuXHJcbiAgICAgIGF3YWl0IGV4cGVjdChcclxuICAgICAgICBzZXJ2aWNlLmNvbmZpcm1BY2NvdW50RGVsZXRpb24oJ3VzZXItaWQnLCAnaW52YWxpZC10b2tlbicpLFxyXG4gICAgICApLnJlamVjdHMudG9UaHJvdyhCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcclxuXHJcbiAgICAgIGV4cGVjdCgoc2VydmljZSBhcyBhbnkpLnBlcmZvcm1BY2NvdW50RGVsZXRpb24pLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ3BlcmZvcm1BY2NvdW50RGVsZXRpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHBlcmZvcm0gZnVsbCBkZWxldGlvbiBwcm9jZXNzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrVXNlciA9IHsgaWQ6ICd1c2VyLWlkJywgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyB9O1xyXG4gICAgICBjb25zdCBtb2NrV2FsbGV0ID0geyBpZDogJ3dhbGxldC1pZCcsIHdhbGxldEFkZHJlc3M6ICcweDEyMycgfTtcclxuXHJcbiAgICAgIGplc3Quc3B5T24odXNlclJlcG9zaXRvcnksICdmaW5kT25lJykubW9ja1Jlc29sdmVkVmFsdWUobW9ja1VzZXIgYXMgYW55KTtcclxuICAgICAgamVzdFxyXG4gICAgICAgIC5zcHlPbih3YWxsZXRJbmZvUmVwb3NpdG9yeSwgJ2ZpbmRPbmUnKVxyXG4gICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrV2FsbGV0IGFzIGFueSk7XHJcbiAgICAgIGplc3RcclxuICAgICAgICAuc3B5T24oc2VydmljZSBhcyBhbnksICdzY2hlZHVsZURhdGFQdXJnZScpXHJcbiAgICAgICAgLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7fSk7XHJcblxyXG4gICAgICBhd2FpdCBzZXJ2aWNlLnBlcmZvcm1BY2NvdW50RGVsZXRpb24oJ3VzZXItaWQnLCAncmVxdWVzdGVyLWlkJyk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja1F1ZXJ5UnVubmVyLm1hbmFnZXIudXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICBVc2VyLFxyXG4gICAgICAgICd1c2VyLWlkJyxcclxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICBmaXJzdE5hbWU6ICdbUkVEQUNURURdJyxcclxuICAgICAgICAgIGxhc3ROYW1lOiAnW1JFREFDVEVEXScsXHJcbiAgICAgICAgfSksXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja1F1ZXJ5UnVubmVyLm1hbmFnZXIudXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICBXYWxsZXRJbmZvLFxyXG4gICAgICAgICd3YWxsZXQtaWQnLFxyXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgIG9ycGhhbmVkOiB0cnVlLFxyXG4gICAgICAgICAgb3JwaGFuZWRBdDogZXhwZWN0LmFueShEYXRlKSxcclxuICAgICAgICB9KSxcclxuICAgICAgKTtcclxuXHJcbiAgICAgIGV4cGVjdChtb2NrUXVlcnlSdW5uZXIubWFuYWdlci5zb2Z0RGVsZXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICBVc2VyUHJvZ3Jlc3MsXHJcbiAgICAgICAgeyB1c2VyOiB7IGlkOiAndXNlci1pZCcgfSB9LFxyXG4gICAgICApO1xyXG4gICAgICBleHBlY3QobW9ja1F1ZXJ5UnVubmVyLm1hbmFnZXIuc2F2ZSkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICBleHBlY3QoYXVkaXRMb2dTZXJ2aWNlLmNyZWF0ZUxvZykudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICBleHBlY3QoKHNlcnZpY2UgYXMgYW55KS5zY2hlZHVsZURhdGFQdXJnZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgJ3VzZXItaWQnLFxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn0pO1xyXG4iXSwidmVyc2lvbiI6M30=