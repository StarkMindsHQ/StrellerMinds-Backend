44531dee21dfa10c3aed7e171ec25b19
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const typeorm_1 = require("@nestjs/typeorm");
const jwt_1 = require("@nestjs/jwt");
const wallet_service_1 = require("../src/wallet/services/wallet.service");
const wallet_entity_1 = require("../src/wallet/entities/wallet.entity");
const credential_entity_1 = require("../src/wallet/entities/credential.entity");
const ethereum_wallet_provider_1 = require("../src/wallet/providers/ethereum-wallet.provider");
describe('WalletService', () => {
    let service;
    let walletRepository;
    let credentialRepository;
    let jwtService;
    const mockWalletRepository = {
        findOne: jest.fn(),
        create: jest.fn(),
        save: jest.fn(),
    };
    const mockCredentialRepository = {
        find: jest.fn(),
        findOne: jest.fn(),
        save: jest.fn(),
        createQueryBuilder: jest.fn(),
    };
    const mockJwtService = {
        sign: jest.fn(),
    };
    const mockEthereumProvider = {
        verifySignature: jest.fn(),
        generateNonce: jest.fn(),
        formatMessage: jest.fn(),
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                wallet_service_1.WalletService,
                {
                    provide: (0, typeorm_1.getRepositoryToken)(wallet_entity_1.Wallet),
                    useValue: mockWalletRepository,
                },
                {
                    provide: (0, typeorm_1.getRepositoryToken)(credential_entity_1.Credential),
                    useValue: mockCredentialRepository,
                },
                {
                    provide: jwt_1.JwtService,
                    useValue: mockJwtService,
                },
                {
                    provide: ethereum_wallet_provider_1.EthereumWalletProvider,
                    useValue: mockEthereumProvider,
                },
            ],
        }).compile();
        service = module.get(wallet_service_1.WalletService);
        walletRepository = module.get((0, typeorm_1.getRepositoryToken)(wallet_entity_1.Wallet));
        credentialRepository = module.get((0, typeorm_1.getRepositoryToken)(credential_entity_1.Credential));
        jwtService = module.get(jwt_1.JwtService);
    });
    describe('connectWallet', () => {
        it('should connect a new wallet successfully', async () => {
            const connectDto = {
                address: '0x1234567890123456789012345678901234567890',
                type: wallet_entity_1.WalletType.METAMASK,
                signature: 'mock-signature',
                message: 'mock-message',
            };
            mockEthereumProvider.verifySignature.mockResolvedValue(true);
            mockWalletRepository.findOne.mockResolvedValue(null);
            mockWalletRepository.create.mockReturnValue({
                id: 'wallet-id',
                address: connectDto.address.toLowerCase(),
                type: connectDto.type,
            });
            mockWalletRepository.save.mockResolvedValue({
                id: 'wallet-id',
                address: connectDto.address.toLowerCase(),
                type: connectDto.type,
            });
            mockJwtService.sign.mockReturnValue('jwt-token');
            const result = await service.connectWallet(connectDto);
            expect(result.isNewWallet).toBe(true);
            expect(result.accessToken).toBe('jwt-token');
            expect(mockEthereumProvider.verifySignature).toHaveBeenCalledWith(connectDto.address, connectDto.message, connectDto.signature);
        });
        it('should throw UnauthorizedException for invalid signature', async () => {
            const connectDto = {
                address: '0x1234567890123456789012345678901234567890',
                type: wallet_entity_1.WalletType.METAMASK,
                signature: 'invalid-signature',
                message: 'mock-message',
            };
            mockEthereumProvider.verifySignature.mockResolvedValue(false);
            await expect(service.connectWallet(connectDto)).rejects.toThrow('Invalid wallet signature');
        });
    });
    describe('shareCredentials', () => {
        it('should share credentials successfully', async () => {
            const walletId = 'wallet-id';
            const shareDto = {
                credentialIds: ['cred-1', 'cred-2'],
                recipientAddress: '0x9876543210987654321098765432109876543210',
            };
            const mockCredentials = [
                { id: 'cred-1', walletId },
                { id: 'cred-2', walletId },
            ];
            mockCredentialRepository.find.mockResolvedValue(mockCredentials);
            mockCredentialRepository.save.mockResolvedValue({});
            const result = await service.shareCredentials(walletId, shareDto);
            expect(result.success).toBe(true);
            expect(result.sharedCredentials).toEqual(['cred-1', 'cred-2']);
            expect(mockCredentialRepository.save).toHaveBeenCalledTimes(2);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFx3YWxsZXQtaW50ZWdyYXRpb25cXHRlc3RzXFx3YWxsZXQuc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQXNEO0FBQ3RELDZDQUFxRDtBQUNyRCxxQ0FBeUM7QUFDekMsMEVBQXNFO0FBQ3RFLHdFQUEwRTtBQUMxRSxnRkFBc0U7QUFDdEUsK0ZBQTBGO0FBRTFGLFFBQVEsQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO0lBQzdCLElBQUksT0FBc0IsQ0FBQztJQUMzQixJQUFJLGdCQUFxQixDQUFDO0lBQzFCLElBQUksb0JBQXlCLENBQUM7SUFDOUIsSUFBSSxVQUFzQixDQUFDO0lBRTNCLE1BQU0sb0JBQW9CLEdBQUc7UUFDM0IsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDbEIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDakIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDaEIsQ0FBQztJQUVGLE1BQU0sd0JBQXdCLEdBQUc7UUFDL0IsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7UUFDZixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNsQixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNmLGtCQUFrQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7S0FDOUIsQ0FBQztJQUVGLE1BQU0sY0FBYyxHQUFHO1FBQ3JCLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ2hCLENBQUM7SUFFRixNQUFNLG9CQUFvQixHQUFHO1FBQzNCLGVBQWUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQzFCLGFBQWEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1FBQ3hCLGFBQWEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ3pCLENBQUM7SUFFRixVQUFVLENBQUMsS0FBSyxJQUFJLEVB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LFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDL0QsTUFBTSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGctZWtvaFxcRGVza3RvcFxcU3RyZWxsZXJNaW5kcy1CYWNrZW5kXFxzcmNcXHdhbGxldC1pbnRlZ3JhdGlvblxcdGVzdHNcXHdhbGxldC5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XHJcbmltcG9ydCB7IGdldFJlcG9zaXRvcnlUb2tlbiB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XHJcbmltcG9ydCB7IEp3dFNlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2p3dCc7XHJcbmltcG9ydCB7IFdhbGxldFNlcnZpY2UgfSBmcm9tICcuLi9zcmMvd2FsbGV0L3NlcnZpY2VzL3dhbGxldC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgV2FsbGV0LCBXYWxsZXRUeXBlIH0gZnJvbSAnLi4vc3JjL3dhbGxldC9lbnRpdGllcy93YWxsZXQuZW50aXR5JztcclxuaW1wb3J0IHsgQ3JlZGVudGlhbCB9IGZyb20gJy4uL3NyYy93YWxsZXQvZW50aXRpZXMvY3JlZGVudGlhbC5lbnRpdHknO1xyXG5pbXBvcnQgeyBFdGhlcmV1bVdhbGxldFByb3ZpZGVyIH0gZnJvbSAnLi4vc3JjL3dhbGxldC9wcm92aWRlcnMvZXRoZXJldW0td2FsbGV0LnByb3ZpZGVyJztcclxuXHJcbmRlc2NyaWJlKCdXYWxsZXRTZXJ2aWNlJywgKCkgPT4ge1xyXG4gIGxldCBzZXJ2aWNlOiBXYWxsZXRTZXJ2aWNlO1xyXG4gIGxldCB3YWxsZXRSZXBvc2l0b3J5OiBhbnk7XHJcbiAgbGV0IGNyZWRlbnRpYWxSZXBvc2l0b3J5OiBhbnk7XHJcbiAgbGV0IGp3dFNlcnZpY2U6IEp3dFNlcnZpY2U7XHJcblxyXG4gIGNvbnN0IG1vY2tXYWxsZXRSZXBvc2l0b3J5ID0ge1xyXG4gICAgZmluZE9uZTogamVzdC5mbigpLFxyXG4gICAgY3JlYXRlOiBqZXN0LmZuKCksXHJcbiAgICBzYXZlOiBqZXN0LmZuKCksXHJcbiAgfTtcclxuXHJcbiAgY29uc3QgbW9ja0NyZWRlbnRpYWxSZXBvc2l0b3J5ID0ge1xyXG4gICAgZmluZDogamVzdC5mbigpLFxyXG4gICAgZmluZE9uZTogamVzdC5mbigpLFxyXG4gICAgc2F2ZTogamVzdC5mbigpLFxyXG4gICAgY3JlYXRlUXVlcnlCdWlsZGVyOiBqZXN0LmZuKCksXHJcbiAgfTtcclxuXHJcbiAgY29uc3QgbW9ja0p3dFNlcnZpY2UgPSB7XHJcbiAgICBzaWduOiBqZXN0LmZuKCksXHJcbiAgfTtcclxuXHJcbiAgY29uc3QgbW9ja0V0aGVyZXVtUHJvdmlkZXIgPSB7XHJcbiAgICB2ZXJpZnlTaWduYXR1cmU6IGplc3QuZm4oKSxcclxuICAgIGdlbmVyYXRlTm9uY2U6IGplc3QuZm4oKSxcclxuICAgIGZvcm1hdE1lc3NhZ2U6IGplc3QuZm4oKSxcclxuICB9O1xyXG5cclxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XHJcbiAgICAgIHByb3ZpZGVyczogW1xyXG4gICAgICAgIFdhbGxldFNlcnZpY2UsXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogZ2V0UmVwb3NpdG9yeVRva2VuKFdhbGxldCksXHJcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja1dhbGxldFJlcG9zaXRvcnksXHJcbiAgICAgICAgfSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBwcm92aWRlOiBnZXRSZXBvc2l0b3J5VG9rZW4oQ3JlZGVudGlhbCksXHJcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja0NyZWRlbnRpYWxSZXBvc2l0b3J5LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogSnd0U2VydmljZSxcclxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrSnd0U2VydmljZSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIHByb3ZpZGU6IEV0aGVyZXVtV2FsbGV0UHJvdmlkZXIsXHJcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja0V0aGVyZXVtUHJvdmlkZXIsXHJcbiAgICAgICAgfSxcclxuICAgICAgXSxcclxuICAgIH0pLmNvbXBpbGUoKTtcclxuXHJcbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxXYWxsZXRTZXJ2aWNlPihXYWxsZXRTZXJ2aWNlKTtcclxuICAgIHdhbGxldFJlcG9zaXRvcnkgPSBtb2R1bGUuZ2V0KGdldFJlcG9zaXRvcnlUb2tlbihXYWxsZXQpKTtcclxuICAgIGNyZWRlbnRpYWxSZXBvc2l0b3J5ID0gbW9kdWxlLmdldChnZXRSZXBvc2l0b3J5VG9rZW4oQ3JlZGVudGlhbCkpO1xyXG4gICAgand0U2VydmljZSA9IG1vZHVsZS5nZXQ8Snd0U2VydmljZT4oSnd0U2VydmljZSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdjb25uZWN0V2FsbGV0JywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjb25uZWN0IGEgbmV3IHdhbGxldCBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGNvbm5lY3REdG8gPSB7XHJcbiAgICAgICAgYWRkcmVzczogJzB4MTIzNDU2Nzg5MDEyMzQ1Njc4OTAxMjM0NTY3ODkwMTIzNDU2Nzg5MCcsXHJcbiAgICAgICAgdHlwZTogV2FsbGV0VHlwZS5NRVRBTUFTSyxcclxuICAgICAgICBzaWduYXR1cmU6ICdtb2NrLXNpZ25hdHVyZScsXHJcbiAgICAgICAgbWVzc2FnZTogJ21vY2stbWVzc2FnZScsXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBtb2NrRXRoZXJldW1Qcm92aWRlci52ZXJpZnlTaWduYXR1cmUubW9ja1Jlc29sdmVkVmFsdWUodHJ1ZSk7XHJcbiAgICAgIG1vY2tXYWxsZXRSZXBvc2l0b3J5LmZpbmRPbmUubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XHJcbiAgICAgIG1vY2tXYWxsZXRSZXBvc2l0b3J5LmNyZWF0ZS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIGlkOiAnd2FsbGV0LWlkJyxcclxuICAgICAgICBhZGRyZXNzOiBjb25uZWN0RHRvLmFkZHJlc3MudG9Mb3dlckNhc2UoKSxcclxuICAgICAgICB0eXBlOiBjb25uZWN0RHRvLnR5cGUsXHJcbiAgICAgIH0pO1xyXG4gICAgICBtb2NrV2FsbGV0UmVwb3NpdG9yeS5zYXZlLm1vY2tSZXNvbHZlZFZhbHVlKHtcclxuICAgICAgICBpZDogJ3dhbGxldC1pZCcsXHJcbiAgICAgICAgYWRkcmVzczogY29ubmVjdER0by5hZGRyZXNzLnRvTG93ZXJDYXNlKCksXHJcbiAgICAgICAgdHlwZTogY29ubmVjdER0by50eXBlLFxyXG4gICAgICB9KTtcclxuICAgICAgbW9ja0p3dFNlcnZpY2Uuc2lnbi5tb2NrUmV0dXJuVmFsdWUoJ2p3dC10b2tlbicpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5jb25uZWN0V2FsbGV0KGNvbm5lY3REdG8pO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5pc05ld1dhbGxldCkudG9CZSh0cnVlKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC5hY2Nlc3NUb2tlbikudG9CZSgnand0LXRva2VuJyk7XHJcbiAgICAgIGV4cGVjdChtb2NrRXRoZXJldW1Qcm92aWRlci52ZXJpZnlTaWduYXR1cmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgIGNvbm5lY3REdG8uYWRkcmVzcyxcclxuICAgICAgICBjb25uZWN0RHRvLm1lc3NhZ2UsXHJcbiAgICAgICAgY29ubmVjdER0by5zaWduYXR1cmVcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgdGhyb3cgVW5hdXRob3JpemVkRXhjZXB0aW9uIGZvciBpbnZhbGlkIHNpZ25hdHVyZScsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgY29ubmVjdER0byA9IHtcclxuICAgICAgICBhZGRyZXNzOiAnMHgxMjM0NTY3ODkwMTIzNDU2Nzg5MDEyMzQ1Njc4OTAxMjM0NTY3ODkwJyxcclxuICAgICAgICB0eXBlOiBXYWxsZXRUeXBlLk1FVEFNQVNLLFxyXG4gICAgICAgIHNpZ25hdHVyZTogJ2ludmFsaWQtc2lnbmF0dXJlJyxcclxuICAgICAgICBtZXNzYWdlOiAnbW9jay1tZXNzYWdlJyxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIG1vY2tFdGhlcmV1bVByb3ZpZGVyLnZlcmlmeVNpZ25hdHVyZS5tb2NrUmVzb2x2ZWRWYWx1ZShmYWxzZSk7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5jb25uZWN0V2FsbGV0KGNvbm5lY3REdG8pKS5yZWplY3RzLnRvVGhyb3coXHJcbiAgICAgICAgJ0ludmFsaWQgd2FsbGV0IHNpZ25hdHVyZSdcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnc2hhcmVDcmVkZW50aWFscycsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgc2hhcmUgY3JlZGVudGlhbHMgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB3YWxsZXRJZCA9ICd3YWxsZXQtaWQnO1xyXG4gICAgICBjb25zdCBzaGFyZUR0byA9IHtcclxuICAgICAgICBjcmVkZW50aWFsSWRzOiBbJ2NyZWQtMScsICdjcmVkLTInXSxcclxuICAgICAgICByZWNpcGllbnRBZGRyZXNzOiAnMHg5ODc2NTQzMjEwOTg3NjU0MzIxMDk4NzY1NDMyMTA5ODc2NTQzMjEwJyxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIGNvbnN0IG1vY2tDcmVkZW50aWFscyA9IFtcclxuICAgICAgICB7IGlkOiAnY3JlZC0xJywgd2FsbGV0SWQgfSxcclxuICAgICAgICB7IGlkOiAnY3JlZC0yJywgd2FsbGV0SWQgfSxcclxuICAgICAgXTtcclxuXHJcbiAgICAgIG1vY2tDcmVkZW50aWFsUmVwb3NpdG9yeS5maW5kLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tDcmVkZW50aWFscyk7XHJcbiAgICAgIG1vY2tDcmVkZW50aWFsUmVwb3NpdG9yeS5zYXZlLm1vY2tSZXNvbHZlZFZhbHVlKHt9KTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2Uuc2hhcmVDcmVkZW50aWFscyh3YWxsZXRJZCwgc2hhcmVEdG8pO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xyXG4gICAgICBleHBlY3QocmVzdWx0LnNoYXJlZENyZWRlbnRpYWxzKS50b0VxdWFsKFsnY3JlZC0xJywgJ2NyZWQtMiddKTtcclxuICAgICAgZXhwZWN0KG1vY2tDcmVkZW50aWFsUmVwb3NpdG9yeS5zYXZlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==