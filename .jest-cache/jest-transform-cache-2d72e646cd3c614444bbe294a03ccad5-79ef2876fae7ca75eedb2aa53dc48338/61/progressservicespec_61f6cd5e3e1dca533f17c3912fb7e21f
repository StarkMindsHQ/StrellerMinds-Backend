f0348058fff9c63cacc230c871c2d3fb
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const typeorm_1 = require("@nestjs/typeorm");
const progress_service_1 = require("./progress.service");
const user_progress_entity_1 = require("../entities/user-progress.entity");
const course_entity_1 = require("../../courses/entities/course.entity");
const lesson_entity_1 = require("../../lesson/entity/lesson.entity");
const course_module_entity_1 = require("../../courses/entities/course-module.entity");
const common_1 = require("@nestjs/common");
describe('ProgressService', () => {
    let service;
    let progressRepository;
    let courseRepository;
    let lessonRepository;
    let moduleRepository;
    const mockUserProgress = {
        id: '1',
        progressPercentage: 0,
        isCompleted: false,
        user: { id: 'user1' },
        course: { id: 'course1' },
        lesson: { id: 'lesson1' },
        module: { id: 'module1' },
    };
    const mockCourse = {
        id: 'course1',
        title: 'Test Course',
        modules: [
            {
                id: 'module1',
                title: 'Module 1',
                lessons: [
                    { id: 'lesson1', title: 'Lesson 1' },
                    { id: 'lesson2', title: 'Lesson 2' },
                ],
            },
        ],
    };
    const mockLesson = {
        id: 'lesson1',
        title: 'Lesson 1',
        module: { id: 'module1', courseId: 'course1' },
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                progress_service_1.ProgressService,
                {
                    provide: (0, typeorm_1.getRepositoryToken)(user_progress_entity_1.UserProgress),
                    useValue: {
                        findOne: jest.fn(),
                        find: jest.fn(),
                        create: jest.fn(),
                        save: jest.fn(),
                    },
                },
                {
                    provide: (0, typeorm_1.getRepositoryToken)(course_entity_1.Course),
                    useValue: {
                        findOne: jest.fn(),
                    },
                },
                {
                    provide: (0, typeorm_1.getRepositoryToken)(lesson_entity_1.Lesson),
                    useValue: {
                        findOne: jest.fn(),
                        find: jest.fn(),
                    },
                },
                {
                    provide: (0, typeorm_1.getRepositoryToken)(course_module_entity_1.CourseModule),
                    useValue: {
                        findOne: jest.fn(),
                    },
                },
            ],
        }).compile();
        service = module.get(progress_service_1.ProgressService);
        progressRepository = module.get((0, typeorm_1.getRepositoryToken)(user_progress_entity_1.UserProgress));
        courseRepository = module.get((0, typeorm_1.getRepositoryToken)(course_entity_1.Course));
        lessonRepository = module.get((0, typeorm_1.getRepositoryToken)(lesson_entity_1.Lesson));
        moduleRepository = module.get((0, typeorm_1.getRepositoryToken)(course_module_entity_1.CourseModule));
    });
    describe('updateLessonProgress', () => {
        it('should create new progress record if none exists', async () => {
            jest.spyOn(lessonRepository, 'findOne').mockResolvedValue(mockLesson);
            jest.spyOn(progressRepository, 'findOne').mockResolvedValue(null);
            jest.spyOn(progressRepository, 'create').mockReturnValue(mockUserProgress);
            jest.spyOn(progressRepository, 'save').mockResolvedValue(mockUserProgress);
            const result = await service.updateLessonProgress('user1', 'course1', 'lesson1', 50);
            expect(result).toBeDefined();
            expect(progressRepository.create).toHaveBeenCalled();
            expect(progressRepository.save).toHaveBeenCalled();
        });
        it('should throw NotFoundException if lesson not found', async () => {
            jest.spyOn(lessonRepository, 'findOne').mockResolvedValue(null);
            await expect(service.updateLessonProgress('user1', 'course1', 'lesson1', 50)).rejects.toThrow(common_1.NotFoundException);
        });
        it('should throw BadRequestException if lesson does not belong to course', async () => {
            jest.spyOn(lessonRepository, 'findOne').mockResolvedValue({
                ...mockLesson,
                module: { id: 'module1', courseId: 'different-course' },
            });
            await expect(service.updateLessonProgress('user1', 'course1', 'lesson1', 50)).rejects.toThrow(common_1.BadRequestException);
        });
    });
    describe('getCourseProgress', () => {
        it('should return course progress with module details', async () => {
            jest.spyOn(courseRepository, 'findOne').mockResolvedValue(mockCourse);
            jest.spyOn(progressRepository, 'find').mockResolvedValue([
                {
                    ...mockUserProgress,
                    isCompleted: true,
                    progressPercentage: 100,
                },
            ]);
            const result = await service.getCourseProgress('user1', 'course1');
            expect(result).toBeDefined();
            expect(result.overallProgress).toBe(50); // 1 completed out of 2 lessons
            expect(result.moduleProgress).toHaveLength(1);
            expect(result.moduleProgress[0].progress).toBe(50);
        });
        it('should throw NotFoundException if course not found', async () => {
            jest.spyOn(courseRepository, 'findOne').mockResolvedValue(null);
            await expect(service.getCourseProgress('user1', 'course1')).rejects.toThrow(common_1.NotFoundException);
        });
    });
    describe('getUserProgress', () => {
        it('should return user progress across all courses', async () => {
            const mockProgress = [
                {
                    ...mockUserProgress,
                    course: { id: 'course1', title: 'Course 1' },
                    lastAccessedAt: new Date(),
                },
            ];
            jest.spyOn(progressRepository, 'find').mockResolvedValue(mockProgress);
            const result = await service.getUserProgress('user1');
            expect(result).toBeDefined();
            expect(result).toHaveLength(1);
            expect(result[0].courseId).toBe('course1');
        });
    });
    describe('syncProgress', () => {
        it('should sync progress for all modules in a course', async () => {
            jest.spyOn(courseRepository, 'findOne').mockResolvedValue(mockCourse);
            jest.spyOn(moduleRepository, 'findOne').mockResolvedValue(mockCourse.modules[0]);
            jest.spyOn(progressRepository, 'find').mockResolvedValue([]);
            jest.spyOn(progressRepository, 'save').mockResolvedValue({});
            await service.syncProgress('user1', 'course1');
            expect(moduleRepository.findOne).toHaveBeenCalled();
            expect(progressRepository.save).toHaveBeenCalled();
        });
        it('should throw NotFoundException if course not found', async () => {
            jest.spyOn(courseRepository, 'findOne').mockResolvedValue(null);
            await expect(service.syncProgress('user1', 'course1')).rejects.toThrow(common_1.NotFoundException);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFx1c2Vyc1xcc2VydmljZXNcXHByb2dyZXNzLnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDZDQUFzRDtBQUN0RCw2Q0FBcUQ7QUFFckQseURBQXFEO0FBQ3JELDJFQUFnRTtBQUNoRSx3RUFBOEQ7QUFDOUQscUVBQTJEO0FBQzNELHNGQUEyRTtBQUMzRSwyQ0FBd0U7QUFFeEUsUUFBUSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRTtJQUMvQixJQUFJLE9BQXdCLENBQUM7SUFDN0IsSUFBSSxrQkFBNEMsQ0FBQztJQUNqRCxJQUFJLGdCQUFvQyxDQUFDO0lBQ3pDLElBQUksZ0JBQW9DLENBQUM7SUFDekMsSUFBSSxnQkFBMEMsQ0FBQztJQUUvQyxNQUFNLGdCQUFnQixHQUFHO1FBQ3ZCLEVBQUUsRUFBRSxHQUFHO1FBQ1Asa0JBQWtCLEVBQUUsQ0FBQztRQUNyQixXQUFXLEVBQUUsS0FBSztRQUNsQixJQUFJLEVBQUUsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFO1FBQ3JCLE1BQU0sRUFBRSxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUU7UUFDekIsTUFBTSxFQUFFLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRTtRQUN6QixNQUFNLEVBQUUsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFO0tBQzFCLENBQUM7SUFFRixNQUFNLFVBQVUsR0FBRztRQUNqQixFQUFFLEVBQUUsU0FBUztRQUNiLEtBQUssRUFBRSxhQUFhO1FBQ3BCLE9BQU8sRUFBRTtZQUNQO2dCQUNFLEVBQUUsRUFBRSxTQUFTO2dCQUNiLEtBQUssRUFBRSxVQUFVO2dCQUNqQixPQUFPLEVBQUU7b0JBQ1AsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUU7b0JBQ3BDLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFO2lCQUNyQzthQUNGO1NBQ0Y7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LENBQUMsRUFBRSxDQUFDLENBQUM7WUFDN0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsRUFBRSxNQUFNLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFTLENBQUMsQ0FBQztZQUVwRSxNQUFNLE9BQU8sQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBRS9DLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3BELE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3JELENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLG9EQUFvRCxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ2xFLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEVBQUUsU0FBUyxDQUFDLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFaEUsTUFBTSxNQUFNLENBQ1YsT0FBTyxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQ3pDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQywwQkFBaUIsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGctZWtvaFxcRGVza3RvcFxcU3RyZWxsZXJNaW5kcy1CYWNrZW5kXFxzcmNcXHVzZXJzXFxzZXJ2aWNlc1xccHJvZ3Jlc3Muc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xyXG5pbXBvcnQgeyBnZXRSZXBvc2l0b3J5VG9rZW4gfSBmcm9tICdAbmVzdGpzL3R5cGVvcm0nO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAndHlwZW9ybSc7XHJcbmltcG9ydCB7IFByb2dyZXNzU2VydmljZSB9IGZyb20gJy4vcHJvZ3Jlc3Muc2VydmljZSc7XHJcbmltcG9ydCB7IFVzZXJQcm9ncmVzcyB9IGZyb20gJy4uL2VudGl0aWVzL3VzZXItcHJvZ3Jlc3MuZW50aXR5JztcclxuaW1wb3J0IHsgQ291cnNlIH0gZnJvbSAnLi4vLi4vY291cnNlcy9lbnRpdGllcy9jb3Vyc2UuZW50aXR5JztcclxuaW1wb3J0IHsgTGVzc29uIH0gZnJvbSAnLi4vLi4vbGVzc29uL2VudGl0eS9sZXNzb24uZW50aXR5JztcclxuaW1wb3J0IHsgQ291cnNlTW9kdWxlIH0gZnJvbSAnLi4vLi4vY291cnNlcy9lbnRpdGllcy9jb3Vyc2UtbW9kdWxlLmVudGl0eSc7XHJcbmltcG9ydCB7IE5vdEZvdW5kRXhjZXB0aW9uLCBCYWRSZXF1ZXN0RXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xyXG5cclxuZGVzY3JpYmUoJ1Byb2dyZXNzU2VydmljZScsICgpID0+IHtcclxuICBsZXQgc2VydmljZTogUHJvZ3Jlc3NTZXJ2aWNlO1xyXG4gIGxldCBwcm9ncmVzc1JlcG9zaXRvcnk6IFJlcG9zaXRvcnk8VXNlclByb2dyZXNzPjtcclxuICBsZXQgY291cnNlUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxDb3Vyc2U+O1xyXG4gIGxldCBsZXNzb25SZXBvc2l0b3J5OiBSZXBvc2l0b3J5PExlc3Nvbj47XHJcbiAgbGV0IG1vZHVsZVJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8Q291cnNlTW9kdWxlPjtcclxuXHJcbiAgY29uc3QgbW9ja1VzZXJQcm9ncmVzcyA9IHtcclxuICAgIGlkOiAnMScsXHJcbiAgICBwcm9ncmVzc1BlcmNlbnRhZ2U6IDAsXHJcbiAgICBpc0NvbXBsZXRlZDogZmFsc2UsXHJcbiAgICB1c2VyOiB7IGlkOiAndXNlcjEnIH0sXHJcbiAgICBjb3Vyc2U6IHsgaWQ6ICdjb3Vyc2UxJyB9LFxyXG4gICAgbGVzc29uOiB7IGlkOiAnbGVzc29uMScgfSxcclxuICAgIG1vZHVsZTogeyBpZDogJ21vZHVsZTEnIH0sXHJcbiAgfTtcclxuXHJcbiAgY29uc3QgbW9ja0NvdXJzZSA9IHtcclxuICAgIGlkOiAnY291cnNlMScsXHJcbiAgICB0aXRsZTogJ1Rlc3QgQ291cnNlJyxcclxuICAgIG1vZHVsZXM6IFtcclxuICAgICAge1xyXG4gICAgICAgIGlkOiAnbW9kdWxlMScsXHJcbiAgICAgICAgdGl0bGU6ICdNb2R1bGUgMScsXHJcbiAgICAgICAgbGVzc29uczogW1xyXG4gICAgICAgICAgeyBpZDogJ2xlc3NvbjEnLCB0aXRsZTogJ0xlc3NvbiAxJyB9LFxyXG4gICAgICAgICAgeyBpZDogJ2xlc3NvbjInLCB0aXRsZTogJ0xlc3NvbiAyJyB9LFxyXG4gICAgICAgIF0sXHJcbiAgICAgIH0sXHJcbiAgICBdLFxyXG4gIH07XHJcblxyXG4gIGNvbnN0IG1vY2tMZXNzb24gPSB7XHJcbiAgICBpZDogJ2xlc3NvbjEnLFxyXG4gICAgdGl0bGU6ICdMZXNzb24gMScsXHJcbiAgICBtb2R1bGU6IHsgaWQ6ICdtb2R1bGUxJywgY291cnNlSWQ6ICdjb3Vyc2UxJyB9LFxyXG4gIH07XHJcblxyXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcclxuICAgICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAgUHJvZ3Jlc3NTZXJ2aWNlLFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIHByb3ZpZGU6IGdldFJlcG9zaXRvcnlUb2tlbihVc2VyUHJvZ3Jlc3MpLFxyXG4gICAgICAgICAgdXNlVmFsdWU6IHtcclxuICAgICAgICAgICAgZmluZE9uZTogamVzdC5mbigpLFxyXG4gICAgICAgICAgICBmaW5kOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICAgIGNyZWF0ZTogamVzdC5mbigpLFxyXG4gICAgICAgICAgICBzYXZlOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogZ2V0UmVwb3NpdG9yeVRva2VuKENvdXJzZSksXHJcbiAgICAgICAgICB1c2VWYWx1ZToge1xyXG4gICAgICAgICAgICBmaW5kT25lOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogZ2V0UmVwb3NpdG9yeVRva2VuKExlc3NvbiksXHJcbiAgICAgICAgICB1c2VWYWx1ZToge1xyXG4gICAgICAgICAgICBmaW5kT25lOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICAgIGZpbmQ6IGplc3QuZm4oKSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBwcm92aWRlOiBnZXRSZXBvc2l0b3J5VG9rZW4oQ291cnNlTW9kdWxlKSxcclxuICAgICAgICAgIHVzZVZhbHVlOiB7XHJcbiAgICAgICAgICAgIGZpbmRPbmU6IGplc3QuZm4oKSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgXSxcclxuICAgIH0pLmNvbXBpbGUoKTtcclxuXHJcbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxQcm9ncmVzc1NlcnZpY2U+KFByb2dyZXNzU2VydmljZSk7XHJcbiAgICBwcm9ncmVzc1JlcG9zaXRvcnkgPSBtb2R1bGUuZ2V0PFJlcG9zaXRvcnk8VXNlclByb2dyZXNzPj4oXHJcbiAgICAgIGdldFJlcG9zaXRvcnlUb2tlbihVc2VyUHJvZ3Jlc3MpLFxyXG4gICAgKTtcclxuICAgIGNvdXJzZVJlcG9zaXRvcnkgPSBtb2R1bGUuZ2V0PFJlcG9zaXRvcnk8Q291cnNlPj4oXHJcbiAgICAgIGdldFJlcG9zaXRvcnlUb2tlbihDb3Vyc2UpLFxyXG4gICAgKTtcclxuICAgIGxlc3NvblJlcG9zaXRvcnkgPSBtb2R1bGUuZ2V0PFJlcG9zaXRvcnk8TGVzc29uPj4oXHJcbiAgICAgIGdldFJlcG9zaXRvcnlUb2tlbihMZXNzb24pLFxyXG4gICAgKTtcclxuICAgIG1vZHVsZVJlcG9zaXRvcnkgPSBtb2R1bGUuZ2V0PFJlcG9zaXRvcnk8Q291cnNlTW9kdWxlPj4oXHJcbiAgICAgIGdldFJlcG9zaXRvcnlUb2tlbihDb3Vyc2VNb2R1bGUpLFxyXG4gICAgKTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ3VwZGF0ZUxlc3NvblByb2dyZXNzJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgbmV3IHByb2dyZXNzIHJlY29yZCBpZiBub25lIGV4aXN0cycsIGFzeW5jICgpID0+IHtcclxuICAgICAgamVzdC5zcHlPbihsZXNzb25SZXBvc2l0b3J5LCAnZmluZE9uZScpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tMZXNzb24gYXMgYW55KTtcclxuICAgICAgamVzdC5zcHlPbihwcm9ncmVzc1JlcG9zaXRvcnksICdmaW5kT25lJykubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XHJcbiAgICAgIGplc3Quc3B5T24ocHJvZ3Jlc3NSZXBvc2l0b3J5LCAnY3JlYXRlJykubW9ja1JldHVyblZhbHVlKG1vY2tVc2VyUHJvZ3Jlc3MgYXMgYW55KTtcclxuICAgICAgamVzdC5zcHlPbihwcm9ncmVzc1JlcG9zaXRvcnksICdzYXZlJykubW9ja1Jlc29sdmVkVmFsdWUobW9ja1VzZXJQcm9ncmVzcyBhcyBhbnkpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS51cGRhdGVMZXNzb25Qcm9ncmVzcyhcclxuICAgICAgICAndXNlcjEnLFxyXG4gICAgICAgICdjb3Vyc2UxJyxcclxuICAgICAgICAnbGVzc29uMScsXHJcbiAgICAgICAgNTAsXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICBleHBlY3QocHJvZ3Jlc3NSZXBvc2l0b3J5LmNyZWF0ZSkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICBleHBlY3QocHJvZ3Jlc3NSZXBvc2l0b3J5LnNhdmUpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgdGhyb3cgTm90Rm91bmRFeGNlcHRpb24gaWYgbGVzc29uIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgamVzdC5zcHlPbihsZXNzb25SZXBvc2l0b3J5LCAnZmluZE9uZScpLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgIHNlcnZpY2UudXBkYXRlTGVzc29uUHJvZ3Jlc3MoJ3VzZXIxJywgJ2NvdXJzZTEnLCAnbGVzc29uMScsIDUwKSxcclxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coTm90Rm91bmRFeGNlcHRpb24pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBCYWRSZXF1ZXN0RXhjZXB0aW9uIGlmIGxlc3NvbiBkb2VzIG5vdCBiZWxvbmcgdG8gY291cnNlJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBqZXN0LnNweU9uKGxlc3NvblJlcG9zaXRvcnksICdmaW5kT25lJykubW9ja1Jlc29sdmVkVmFsdWUoe1xyXG4gICAgICAgIC4uLm1vY2tMZXNzb24sXHJcbiAgICAgICAgbW9kdWxlOiB7IGlkOiAnbW9kdWxlMScsIGNvdXJzZUlkOiAnZGlmZmVyZW50LWNvdXJzZScgfSxcclxuICAgICAgfSBhcyBhbnkpO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgIHNlcnZpY2UudXBkYXRlTGVzc29uUHJvZ3Jlc3MoJ3VzZXIxJywgJ2NvdXJzZTEnLCAnbGVzc29uMScsIDUwKSxcclxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coQmFkUmVxdWVzdEV4Y2VwdGlvbik7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ2dldENvdXJzZVByb2dyZXNzJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gY291cnNlIHByb2dyZXNzIHdpdGggbW9kdWxlIGRldGFpbHMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGplc3Quc3B5T24oY291cnNlUmVwb3NpdG9yeSwgJ2ZpbmRPbmUnKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrQ291cnNlIGFzIGFueSk7XHJcbiAgICAgIGplc3Quc3B5T24ocHJvZ3Jlc3NSZXBvc2l0b3J5LCAnZmluZCcpLm1vY2tSZXNvbHZlZFZhbHVlKFtcclxuICAgICAgICB7XHJcbiAgICAgICAgICAuLi5tb2NrVXNlclByb2dyZXNzLFxyXG4gICAgICAgICAgaXNDb21wbGV0ZWQ6IHRydWUsXHJcbiAgICAgICAgICBwcm9ncmVzc1BlcmNlbnRhZ2U6IDEwMCxcclxuICAgICAgICB9LFxyXG4gICAgICBdIGFzIGFueSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmdldENvdXJzZVByb2dyZXNzKCd1c2VyMScsICdjb3Vyc2UxJyk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlRGVmaW5lZCgpO1xyXG4gICAgICBleHBlY3QocmVzdWx0Lm92ZXJhbGxQcm9ncmVzcykudG9CZSg1MCk7IC8vIDEgY29tcGxldGVkIG91dCBvZiAyIGxlc3NvbnNcclxuICAgICAgZXhwZWN0KHJlc3VsdC5tb2R1bGVQcm9ncmVzcykudG9IYXZlTGVuZ3RoKDEpO1xyXG4gICAgICBleHBlY3QocmVzdWx0Lm1vZHVsZVByb2dyZXNzWzBdLnByb2dyZXNzKS50b0JlKDUwKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgdGhyb3cgTm90Rm91bmRFeGNlcHRpb24gaWYgY291cnNlIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgamVzdC5zcHlPbihjb3Vyc2VSZXBvc2l0b3J5LCAnZmluZE9uZScpLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgIHNlcnZpY2UuZ2V0Q291cnNlUHJvZ3Jlc3MoJ3VzZXIxJywgJ2NvdXJzZTEnKSxcclxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coTm90Rm91bmRFeGNlcHRpb24pO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdnZXRVc2VyUHJvZ3Jlc3MnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiB1c2VyIHByb2dyZXNzIGFjcm9zcyBhbGwgY291cnNlcycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja1Byb2dyZXNzID0gW1xyXG4gICAgICAgIHtcclxuICAgICAgICAgIC4uLm1vY2tVc2VyUHJvZ3Jlc3MsXHJcbiAgICAgICAgICBjb3Vyc2U6IHsgaWQ6ICdjb3Vyc2UxJywgdGl0bGU6ICdDb3Vyc2UgMScgfSxcclxuICAgICAgICAgIGxhc3RBY2Nlc3NlZEF0OiBuZXcgRGF0ZSgpLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF07XHJcblxyXG4gICAgICBqZXN0LnNweU9uKHByb2dyZXNzUmVwb3NpdG9yeSwgJ2ZpbmQnKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrUHJvZ3Jlc3MgYXMgYW55KTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZ2V0VXNlclByb2dyZXNzKCd1c2VyMScpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZURlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlTGVuZ3RoKDEpO1xyXG4gICAgICBleHBlY3QocmVzdWx0WzBdLmNvdXJzZUlkKS50b0JlKCdjb3Vyc2UxJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ3N5bmNQcm9ncmVzcycsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgc3luYyBwcm9ncmVzcyBmb3IgYWxsIG1vZHVsZXMgaW4gYSBjb3Vyc2UnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGplc3Quc3B5T24oY291cnNlUmVwb3NpdG9yeSwgJ2ZpbmRPbmUnKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrQ291cnNlIGFzIGFueSk7XHJcbiAgICAgIGplc3Quc3B5T24obW9kdWxlUmVwb3NpdG9yeSwgJ2ZpbmRPbmUnKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrQ291cnNlLm1vZHVsZXNbMF0gYXMgYW55KTtcclxuICAgICAgamVzdC5zcHlPbihwcm9ncmVzc1JlcG9zaXRvcnksICdmaW5kJykubW9ja1Jlc29sdmVkVmFsdWUoW10pO1xyXG4gICAgICBqZXN0LnNweU9uKHByb2dyZXNzUmVwb3NpdG9yeSwgJ3NhdmUnKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSBhcyBhbnkpO1xyXG5cclxuICAgICAgYXdhaXQgc2VydmljZS5zeW5jUHJvZ3Jlc3MoJ3VzZXIxJywgJ2NvdXJzZTEnKTtcclxuXHJcbiAgICAgIGV4cGVjdChtb2R1bGVSZXBvc2l0b3J5LmZpbmRPbmUpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgZXhwZWN0KHByb2dyZXNzUmVwb3NpdG9yeS5zYXZlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHRocm93IE5vdEZvdW5kRXhjZXB0aW9uIGlmIGNvdXJzZSBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGplc3Quc3B5T24oY291cnNlUmVwb3NpdG9yeSwgJ2ZpbmRPbmUnKS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcclxuXHJcbiAgICAgIGF3YWl0IGV4cGVjdChcclxuICAgICAgICBzZXJ2aWNlLnN5bmNQcm9ncmVzcygndXNlcjEnLCAnY291cnNlMScpLFxyXG4gICAgICApLnJlamVjdHMudG9UaHJvdyhOb3RGb3VuZEV4Y2VwdGlvbik7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7ICJdLCJ2ZXJzaW9uIjozfQ==