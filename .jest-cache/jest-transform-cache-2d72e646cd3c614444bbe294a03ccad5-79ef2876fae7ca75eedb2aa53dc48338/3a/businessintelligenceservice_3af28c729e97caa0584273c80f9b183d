813f6c863b2c4f31200182110aa9f804
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var BusinessIntelligenceService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.BusinessIntelligenceService = void 0;
const common_1 = require("@nestjs/common");
let BusinessIntelligenceService = BusinessIntelligenceService_1 = class BusinessIntelligenceService {
    constructor(dataWarehouseService, dataCollectionService) {
        this.dataWarehouseService = dataWarehouseService;
        this.dataCollectionService = dataCollectionService;
        this.logger = new common_1.Logger(BusinessIntelligenceService_1.name);
    }
    async executeQuery(query) {
        try {
            const results = {
                data: [],
                summary: {
                    totalRecords: 0,
                    timeRange: query.timeRange,
                    aggregations: {},
                },
            };
            // Get metrics data
            for (const metricName of query.metrics) {
                const metrics = await this.dataWarehouseService.getMetrics({
                    metricName,
                    startDate: query.timeRange.start,
                    endDate: query.timeRange.end,
                    granularity: query.granularity,
                    limit: query.limit,
                });
                // Process and combine results
                for (const metric of metrics) {
                    const existingDataPoint = results.data.find((dp) => dp.timestamp.getTime() === metric.timestamp.getTime());
                    if (existingDataPoint) {
                        existingDataPoint.metrics[metricName] = metric.value;
                    }
                    else {
                        results.data.push({
                            timestamp: metric.timestamp,
                            dimensions: metric.dimensions,
                            metrics: { [metricName]: metric.value },
                        });
                    }
                }
                // Calculate aggregations
                const totalValue = metrics.reduce((sum, m) => sum + m.value, 0);
                results.summary.aggregations[`${metricName}_total`] = totalValue;
                results.summary.aggregations[`${metricName}_avg`] = metrics.length > 0 ? totalValue / metrics.length : 0;
            }
            results.summary.totalRecords = results.data.length;
            // Sort by timestamp
            results.data.sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime());
            return results;
        }
        catch (error) {
            this.logger.error(`Failed to execute analytics query: ${error.message}`, error.stack);
            throw error;
        }
    }
    async getUserAnalytics(userId, timeRange) {
        const events = await this.dataCollectionService.getEvents({
            userId,
            startDate: timeRange.start,
            endDate: timeRange.end,
        });
        const sessionCount = new Set(events.events.map((e) => e.sessionId).filter(Boolean)).size;
        const eventsByType = events.events.reduce((acc, event) => {
            acc[event.eventType] = (acc[event.eventType] || 0) + 1;
            return acc;
        }, {});
        return {
            userId,
            timeRange,
            totalEvents: events.total,
            sessionCount,
            eventsByType,
            firstEvent: events.events[events.events.length - 1]?.timestamp,
            lastEvent: events.events[0]?.timestamp,
        };
    }
    async getTopMetrics(metricName, dimension, timeRange, limit = 10) {
        const metrics = await this.dataWarehouseService.getMetrics({
            metricName,
            startDate: timeRange.start,
            endDate: timeRange.end,
        });
        const aggregated = metrics.reduce((acc, metric) => {
            const dimensionValue = metric.dimensions[dimension];
            if (dimensionValue) {
                acc[dimensionValue] = (acc[dimensionValue] || 0) + metric.value;
            }
            return acc;
        }, {});
        return Object.entries(aggregated)
            .sort(([, a], [, b]) => b - a)
            .slice(0, limit)
            .map(([name, value]) => ({ name, value }));
    }
    async getFunnelAnalysis(steps, timeRange) {
        const funnelData = [];
        for (let i = 0; i < steps.length; i++) {
            const stepEvents = await this.dataCollectionService.getEvents({
                startDate: timeRange.start,
                endDate: timeRange.end,
            });
            const stepCount = stepEvents.events.filter((event) => event.eventName === steps[i]).length;
            const conversionRate = i === 0 ? 100 : (stepCount / funnelData[0].count) * 100;
            funnelData.push({
                step: steps[i],
                count: stepCount,
                conversionRate,
                dropOffRate: i === 0 ? 0 : 100 - conversionRate,
            });
        }
        return funnelData;
    }
};
exports.BusinessIntelligenceService = BusinessIntelligenceService;
exports.BusinessIntelligenceService = BusinessIntelligenceService = BusinessIntelligenceService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [Object, Object])
], BusinessIntelligenceService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxhbmFseXRpY1xcc2VydmljZXNcXGJ1c2luZXNzLWludGVsbGlnZW5jZS5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBbUQ7QUFpQzVDLElBQU0sMkJBQTJCLG1DQUFqQyxNQUFNLDJCQUEyQjtJQUd0QyxZQUNtQixvQkFBMEMsRUFDMUMscUJBQTRDO1FBRDVDLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDMUMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF1QjtRQUo5QyxXQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsNkJBQTJCLENBQUMsSUFBSSxDQUFDLENBQUE7SUFLbkUsQ0FBQztJQUVKLEtBQUssQ0FBQyxZQUFZLENBQUMsS0FBcUI7UUFDdEMsSUFBSSxDQUFDO1lBQ0gsTUFBTSxPQUFPLEdBQW9CO2dCQUMvQixJQUFJLEVBQUUsRUFBRTtnQkFDUixPQUFPLEVBQUU7b0JBQ1AsWUFBWSxFQUFFLENBQUM7b0JBQ2YsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTO29CQUMxQixZQUFZLEVBQUUsRUFBRTtpQkFDakI7YUFDRixDQUFBO1lBRUQsbUJBQW1CO1lBQ25CLEtBQUssTUFBTSxVQUFVLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUN2QyxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLENBQUM7b0JBQ3pELFVBQVU7b0JBQ1YsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSztvQkFDaEMsT0FBTyxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRztvQkFDNUIsV0FBVyxFQUFFLEtBQUssQ0FBQyxXQUFXO29CQUM5QixLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7aUJBQ25CLENBQUMsQ0FBQTtnQkFFRiw4QkFBOEI7Z0JBQzlCLEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxF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S0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLGNBQWM7YUFDaEQsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUVELE9BQU8sVUFBVSxDQUFBO0lBQ25CLENBQUM7Q0FDRixDQUFBO0FBeklZLGtFQUEyQjtzQ0FBM0IsMkJBQTJCO0lBRHZDLElBQUEsbUJBQVUsR0FBRTs7R0FDQSwyQkFBMkIsQ0F5SXZDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZy1la29oXFxEZXNrdG9wXFxTdHJlbGxlck1pbmRzLUJhY2tlbmRcXHNyY1xcYW5hbHl0aWNcXHNlcnZpY2VzXFxidXNpbmVzcy1pbnRlbGxpZ2VuY2Uuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIgfSBmcm9tIFwiQG5lc3Rqcy9jb21tb25cIlxyXG5pbXBvcnQgdHlwZSB7IERhdGFXYXJlaG91c2VTZXJ2aWNlIH0gZnJvbSBcIi4vZGF0YS13YXJlaG91c2Uuc2VydmljZVwiXHJcbmltcG9ydCB0eXBlIHsgRGF0YUNvbGxlY3Rpb25TZXJ2aWNlIH0gZnJvbSBcIi4vZGF0YS1jb2xsZWN0aW9uLnNlcnZpY2VcIlxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBBbmFseXRpY3NRdWVyeSB7XHJcbiAgbWV0cmljczogc3RyaW5nW11cclxuICBkaW1lbnNpb25zPzogc3RyaW5nW11cclxuICBmaWx0ZXJzPzogUmVjb3JkPHN0cmluZywgYW55PlxyXG4gIHRpbWVSYW5nZToge1xyXG4gICAgc3RhcnQ6IERhdGVcclxuICAgIGVuZDogRGF0ZVxyXG4gIH1cclxuICBncmFudWxhcml0eT86IHN0cmluZ1xyXG4gIGxpbWl0PzogbnVtYmVyXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQW5hbHl0aWNzUmVzdWx0IHtcclxuICBkYXRhOiBBcnJheTx7XHJcbiAgICB0aW1lc3RhbXA6IERhdGVcclxuICAgIGRpbWVuc2lvbnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cclxuICAgIG1ldHJpY3M6IFJlY29yZDxzdHJpbmcsIG51bWJlcj5cclxuICB9PlxyXG4gIHN1bW1hcnk6IHtcclxuICAgIHRvdGFsUmVjb3JkczogbnVtYmVyXHJcbiAgICB0aW1lUmFuZ2U6IHtcclxuICAgICAgc3RhcnQ6IERhdGVcclxuICAgICAgZW5kOiBEYXRlXHJcbiAgICB9XHJcbiAgICBhZ2dyZWdhdGlvbnM6IFJlY29yZDxzdHJpbmcsIG51bWJlcj5cclxuICB9XHJcbn1cclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEJ1c2luZXNzSW50ZWxsaWdlbmNlU2VydmljZSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEJ1c2luZXNzSW50ZWxsaWdlbmNlU2VydmljZS5uYW1lKVxyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGF0YVdhcmVob3VzZVNlcnZpY2U6IERhdGFXYXJlaG91c2VTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBkYXRhQ29sbGVjdGlvblNlcnZpY2U6IERhdGFDb2xsZWN0aW9uU2VydmljZSxcclxuICApIHt9XHJcblxyXG4gIGFzeW5jIGV4ZWN1dGVRdWVyeShxdWVyeTogQW5hbHl0aWNzUXVlcnkpOiBQcm9taXNlPEFuYWx5dGljc1Jlc3VsdD4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcmVzdWx0czogQW5hbHl0aWNzUmVzdWx0ID0ge1xyXG4gICAgICAgIGRhdGE6IFtdLFxyXG4gICAgICAgIHN1bW1hcnk6IHtcclxuICAgICAgICAgIHRvdGFsUmVjb3JkczogMCxcclxuICAgICAgICAgIHRpbWVSYW5nZTogcXVlcnkudGltZVJhbmdlLFxyXG4gICAgICAgICAgYWdncmVnYXRpb25zOiB7fSxcclxuICAgICAgICB9LFxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBHZXQgbWV0cmljcyBkYXRhXHJcbiAgICAgIGZvciAoY29uc3QgbWV0cmljTmFtZSBvZiBxdWVyeS5tZXRyaWNzKSB7XHJcbiAgICAgICAgY29uc3QgbWV0cmljcyA9IGF3YWl0IHRoaXMuZGF0YVdhcmVob3VzZVNlcnZpY2UuZ2V0TWV0cmljcyh7XHJcbiAgICAgICAgICBtZXRyaWNOYW1lLFxyXG4gICAgICAgICAgc3RhcnREYXRlOiBxdWVyeS50aW1lUmFuZ2Uuc3RhcnQsXHJcbiAgICAgICAgICBlbmREYXRlOiBxdWVyeS50aW1lUmFuZ2UuZW5kLFxyXG4gICAgICAgICAgZ3JhbnVsYXJpdHk6IHF1ZXJ5LmdyYW51bGFyaXR5LFxyXG4gICAgICAgICAgbGltaXQ6IHF1ZXJ5LmxpbWl0LFxyXG4gICAgICAgIH0pXHJcblxyXG4gICAgICAgIC8vIFByb2Nlc3MgYW5kIGNvbWJpbmUgcmVzdWx0c1xyXG4gICAgICAgIGZvciAoY29uc3QgbWV0cmljIG9mIG1ldHJpY3MpIHtcclxuICAgICAgICAgIGNvbnN0IGV4aXN0aW5nRGF0YVBvaW50ID0gcmVzdWx0cy5kYXRhLmZpbmQoKGRwKSA9PiBkcC50aW1lc3RhbXAuZ2V0VGltZSgpID09PSBtZXRyaWMudGltZXN0YW1wLmdldFRpbWUoKSlcclxuXHJcbiAgICAgICAgICBpZiAoZXhpc3RpbmdEYXRhUG9pbnQpIHtcclxuICAgICAgICAgICAgZXhpc3RpbmdEYXRhUG9pbnQubWV0cmljc1ttZXRyaWNOYW1lXSA9IG1ldHJpYy52YWx1ZVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVzdWx0cy5kYXRhLnB1c2goe1xyXG4gICAgICAgICAgICAgIHRpbWVzdGFtcDogbWV0cmljLnRpbWVzdGFtcCxcclxuICAgICAgICAgICAgICBkaW1lbnNpb25zOiBtZXRyaWMuZGltZW5zaW9ucyxcclxuICAgICAgICAgICAgICBtZXRyaWNzOiB7IFttZXRyaWNOYW1lXTogbWV0cmljLnZhbHVlIH0sXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBDYWxjdWxhdGUgYWdncmVnYXRpb25zXHJcbiAgICAgICAgY29uc3QgdG90YWxWYWx1ZSA9IG1ldHJpY3MucmVkdWNlKChzdW0sIG0pID0+IHN1bSArIG0udmFsdWUsIDApXHJcbiAgICAgICAgcmVzdWx0cy5zdW1tYXJ5LmFnZ3JlZ2F0aW9uc1tgJHttZXRyaWNOYW1lfV90b3RhbGBdID0gdG90YWxWYWx1ZVxyXG4gICAgICAgIHJlc3VsdHMuc3VtbWFyeS5hZ2dyZWdhdGlvbnNbYCR7bWV0cmljTmFtZX1fYXZnYF0gPSBtZXRyaWNzLmxlbmd0aCA+IDAgPyB0b3RhbFZhbHVlIC8gbWV0cmljcy5sZW5ndGggOiAwXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJlc3VsdHMuc3VtbWFyeS50b3RhbFJlY29yZHMgPSByZXN1bHRzLmRhdGEubGVuZ3RoXHJcblxyXG4gICAgICAvLyBTb3J0IGJ5IHRpbWVzdGFtcFxyXG4gICAgICByZXN1bHRzLmRhdGEuc29ydCgoYSwgYikgPT4gYS50aW1lc3RhbXAuZ2V0VGltZSgpIC0gYi50aW1lc3RhbXAuZ2V0VGltZSgpKVxyXG5cclxuICAgICAgcmV0dXJuIHJlc3VsdHNcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gZXhlY3V0ZSBhbmFseXRpY3MgcXVlcnk6ICR7ZXJyb3IubWVzc2FnZX1gLCBlcnJvci5zdGFjaylcclxuICAgICAgdGhyb3cgZXJyb3JcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFVzZXJBbmFseXRpY3ModXNlcklkOiBzdHJpbmcsIHRpbWVSYW5nZTogeyBzdGFydDogRGF0ZTsgZW5kOiBEYXRlIH0pIHtcclxuICAgIGNvbnN0IGV2ZW50cyA9IGF3YWl0IHRoaXMuZGF0YUNvbGxlY3Rpb25TZXJ2aWNlLmdldEV2ZW50cyh7XHJcbiAgICAgIHVzZXJJZCxcclxuICAgICAgc3RhcnREYXRlOiB0aW1lUmFuZ2Uuc3RhcnQsXHJcbiAgICAgIGVuZERhdGU6IHRpbWVSYW5nZS5lbmQsXHJcbiAgICB9KVxyXG5cclxuICAgIGNvbnN0IHNlc3Npb25Db3VudCA9IG5ldyBTZXQoZXZlbnRzLmV2ZW50cy5tYXAoKGUpID0+IGUuc2Vzc2lvbklkKS5maWx0ZXIoQm9vbGVhbikpLnNpemVcclxuXHJcbiAgICBjb25zdCBldmVudHNCeVR5cGUgPSBldmVudHMuZXZlbnRzLnJlZHVjZShcclxuICAgICAgKGFjYywgZXZlbnQpID0+IHtcclxuICAgICAgICBhY2NbZXZlbnQuZXZlbnRUeXBlXSA9IChhY2NbZXZlbnQuZXZlbnRUeXBlXSB8fCAwKSArIDFcclxuICAgICAgICByZXR1cm4gYWNjXHJcbiAgICAgIH0sXHJcbiAgICAgIHt9IGFzIFJlY29yZDxzdHJpbmcsIG51bWJlcj4sXHJcbiAgICApXHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdXNlcklkLFxyXG4gICAgICB0aW1lUmFuZ2UsXHJcbiAgICAgIHRvdGFsRXZlbnRzOiBldmVudHMudG90YWwsXHJcbiAgICAgIHNlc3Npb25Db3VudCxcclxuICAgICAgZXZlbnRzQnlUeXBlLFxyXG4gICAgICBmaXJzdEV2ZW50OiBldmVudHMuZXZlbnRzW2V2ZW50cy5ldmVudHMubGVuZ3RoIC0gMV0/LnRpbWVzdGFtcCxcclxuICAgICAgbGFzdEV2ZW50OiBldmVudHMuZXZlbnRzWzBdPy50aW1lc3RhbXAsXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRUb3BNZXRyaWNzKG1ldHJpY05hbWU6IHN0cmluZywgZGltZW5zaW9uOiBzdHJpbmcsIHRpbWVSYW5nZTogeyBzdGFydDogRGF0ZTsgZW5kOiBEYXRlIH0sIGxpbWl0ID0gMTApIHtcclxuICAgIGNvbnN0IG1ldHJpY3MgPSBhd2FpdCB0aGlzLmRhdGFXYXJlaG91c2VTZXJ2aWNlLmdldE1ldHJpY3Moe1xyXG4gICAgICBtZXRyaWNOYW1lLFxyXG4gICAgICBzdGFydERhdGU6IHRpbWVSYW5nZS5zdGFydCxcclxuICAgICAgZW5kRGF0ZTogdGltZVJhbmdlLmVuZCxcclxuICAgIH0pXHJcblxyXG4gICAgY29uc3QgYWdncmVnYXRlZCA9IG1ldHJpY3MucmVkdWNlKFxyXG4gICAgICAoYWNjLCBtZXRyaWMpID0+IHtcclxuICAgICAgICBjb25zdCBkaW1lbnNpb25WYWx1ZSA9IG1ldHJpYy5kaW1lbnNpb25zW2RpbWVuc2lvbl1cclxuICAgICAgICBpZiAoZGltZW5zaW9uVmFsdWUpIHtcclxuICAgICAgICAgIGFjY1tkaW1lbnNpb25WYWx1ZV0gPSAoYWNjW2RpbWVuc2lvblZhbHVlXSB8fCAwKSArIG1ldHJpYy52YWx1ZVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYWNjXHJcbiAgICAgIH0sXHJcbiAgICAgIHt9IGFzIFJlY29yZDxzdHJpbmcsIG51bWJlcj4sXHJcbiAgICApXHJcblxyXG4gICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKGFnZ3JlZ2F0ZWQpXHJcbiAgICAgIC5zb3J0KChbLCBhXSwgWywgYl0pID0+IGIgLSBhKVxyXG4gICAgICAuc2xpY2UoMCwgbGltaXQpXHJcbiAgICAgIC5tYXAoKFtuYW1lLCB2YWx1ZV0pID0+ICh7IG5hbWUsIHZhbHVlIH0pKVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0RnVubmVsQW5hbHlzaXMoc3RlcHM6IHN0cmluZ1tdLCB0aW1lUmFuZ2U6IHsgc3RhcnQ6IERhdGU7IGVuZDogRGF0ZSB9KSB7XHJcbiAgICBjb25zdCBmdW5uZWxEYXRhID0gW11cclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZXBzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGNvbnN0IHN0ZXBFdmVudHMgPSBhd2FpdCB0aGlzLmRhdGFDb2xsZWN0aW9uU2VydmljZS5nZXRFdmVudHMoe1xyXG4gICAgICAgIHN0YXJ0RGF0ZTogdGltZVJhbmdlLnN0YXJ0LFxyXG4gICAgICAgIGVuZERhdGU6IHRpbWVSYW5nZS5lbmQsXHJcbiAgICAgIH0pXHJcblxyXG4gICAgICBjb25zdCBzdGVwQ291bnQgPSBzdGVwRXZlbnRzLmV2ZW50cy5maWx0ZXIoKGV2ZW50KSA9PiBldmVudC5ldmVudE5hbWUgPT09IHN0ZXBzW2ldKS5sZW5ndGhcclxuXHJcbiAgICAgIGNvbnN0IGNvbnZlcnNpb25SYXRlID0gaSA9PT0gMCA/IDEwMCA6IChzdGVwQ291bnQgLyBmdW5uZWxEYXRhWzBdLmNvdW50KSAqIDEwMFxyXG5cclxuICAgICAgZnVubmVsRGF0YS5wdXNoKHtcclxuICAgICAgICBzdGVwOiBzdGVwc1tpXSxcclxuICAgICAgICBjb3VudDogc3RlcENvdW50LFxyXG4gICAgICAgIGNvbnZlcnNpb25SYXRlLFxyXG4gICAgICAgIGRyb3BPZmZSYXRlOiBpID09PSAwID8gMCA6IDEwMCAtIGNvbnZlcnNpb25SYXRlLFxyXG4gICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBmdW5uZWxEYXRhXHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==