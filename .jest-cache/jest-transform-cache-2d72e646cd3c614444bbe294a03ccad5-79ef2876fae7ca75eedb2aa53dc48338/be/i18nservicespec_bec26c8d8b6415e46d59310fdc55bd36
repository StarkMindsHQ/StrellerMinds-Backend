98340d30c0ab23f62f204a7e4afa63de
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const testing_1 = require("@nestjs/testing");
const typeorm_1 = require("@nestjs/typeorm");
const nestjs_i18n_1 = require("nestjs-i18n");
const i18n_service_1 = require("../services/i18n.service");
const translation_service_1 = require("../services/translation.service");
const locale_service_1 = require("../services/locale.service");
const translation_entity_1 = require("../entities/translation.entity");
describe("I18nService", () => {
    let service;
    let translationRepository;
    let nestI18nService;
    let translationService;
    let localeService;
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                i18n_service_1.I18nService,
                {
                    provide: (0, typeorm_1.getRepositoryToken)(translation_entity_1.Translation),
                    useValue: {
                        findOne: globals_1.jest.fn(),
                        find: globals_1.jest.fn(),
                        save: globals_1.jest.fn(),
                        create: globals_1.jest.fn(),
                    },
                },
                {
                    provide: nestjs_i18n_1.I18nService,
                    useValue: {
                        translate: globals_1.jest.fn(),
                    },
                },
                {
                    provide: translation_service_1.TranslationService,
                    useValue: {
                        getTranslations: globals_1.jest.fn(),
                    },
                },
                {
                    provide: locale_service_1.LocaleService,
                    useValue: {
                        getUserLocale: globals_1.jest.fn(),
                        setUserLocale: globals_1.jest.fn(),
                        getSupportedLocales: globals_1.jest.fn(),
                    },
                },
            ],
        }).compile();
        service = module.get(i18n_service_1.I18nService);
        translationRepository = module.get((0, typeorm_1.getRepositoryToken)(translation_entity_1.Translation));
        nestI18nService = module.get(nestjs_i18n_1.I18nService);
        translationService = module.get(translation_service_1.TranslationService);
        localeService = module.get(locale_service_1.LocaleService);
    });
    it("should be defined", () => {
        expect(service).toBeDefined();
    });
    describe("translate", () => {
        it("should return translation from database", async () => {
            const mockTranslation = {
                id: "1",
                key: "hello",
                locale: "en",
                namespace: "common",
                value: "Hello World",
                status: "published",
            };
            translationRepository.findOne.mockResolvedValue(mockTranslation);
            const result = await service.translate("hello", { locale: "en" });
            expect(result).toBe("Hello World");
            expect(translationRepository.findOne).toHaveBeenCalledWith({
                where: {
                    key: "hello",
                    locale: "en",
                    namespace: "common",
                    status: "published",
                },
            });
        });
        it("should fallback to file-based translation", async () => {
            translationRepository.findOne.mockResolvedValue(null);
            nestI18nService.translate.mockResolvedValue("Hello from file");
            const result = await service.translate("hello", { locale: "en" });
            expect(result).toBe("Hello from file");
            expect(nestI18nService.translate).toHaveBeenCalledWith("common.hello", {
                lang: "en",
                args: undefined,
                defaultValue: undefined,
            });
        });
        it("should interpolate variables in translation", async () => {
            const mockTranslation = {
                id: "1",
                key: "welcome",
                locale: "en",
                namespace: "common",
                value: "Welcome {{name}}!",
                status: "published",
            };
            translationRepository.findOne.mockResolvedValue(mockTranslation);
            const result = await service.translate("welcome", {
                locale: "en",
                args: { name: "John" },
            });
            expect(result).toBe("Welcome John!");
        });
        it("should return default value when translation not found", async () => {
            translationRepository.findOne.mockResolvedValue(null);
            nestI18nService.translate.mockResolvedValue("welcome");
            const result = await service.translate("welcome", {
                locale: "en",
                defaultValue: "Default Welcome",
            });
            expect(result).toBe("Default Welcome");
        });
    });
    describe("translateMultiple", () => {
        it("should translate multiple keys", async () => {
            const mockTranslations = [
                {
                    id: "1",
                    key: "hello",
                    locale: "en",
                    namespace: "common",
                    value: "Hello",
                    status: "published",
                },
                {
                    id: "2",
                    key: "goodbye",
                    locale: "en",
                    namespace: "common",
                    value: "Goodbye",
                    status: "published",
                },
            ];
            translationRepository.findOne
                .mockResolvedValueOnce(mockTranslations[0])
                .mockResolvedValueOnce(mockTranslations[1]);
            const result = await service.translateMultiple(["hello", "goodbye"], { locale: "en" });
            expect(result).toEqual({
                hello: "Hello",
                goodbye: "Goodbye",
            });
        });
    });
    describe("detectLocaleFromRequest", () => {
        it("should detect locale from query parameter", async () => {
            const request = {
                query: { lang: "fr" },
                headers: {},
            };
            const result = await service.detectLocaleFromRequest(request);
            expect(result).toBe("fr");
        });
        it("should detect locale from custom header", async () => {
            const request = {
                query: {},
                headers: { "x-custom-lang": "de" },
            };
            const result = await service.detectLocaleFromRequest(request);
            expect(result).toBe("de");
        });
        it("should detect locale from Accept-Language header", async () => {
            const request = {
                query: {},
                headers: { "accept-language": "es-ES,es;q=0.9,en;q=0.8" },
            };
            localeService.getSupportedLocales.mockResolvedValue([
                { code: "es-ES", status: "active" },
                { code: "en", status: "active" },
            ]);
            const result = await service.detectLocaleFromRequest(request);
            expect(result).toBe("es-ES");
        });
        it("should fallback to default locale", async () => {
            const request = {
                query: {},
                headers: {},
            };
            localeService.getSupportedLocales.mockResolvedValue([]);
            const result = await service.detectLocaleFromRequest(request);
            expect(result).toBe("en");
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxpMThuXFxfX3Rlc3RzX19cXGkxOG4uc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBSUEsMkNBQW9DO0FBSnBDLDZDQUEwRDtBQUMxRCw2Q0FBb0Q7QUFDcEQsNkNBQTREO0FBSTVELDJEQUFzRDtBQUN0RCx5RUFBb0U7QUFDcEUsK0RBQTBEO0FBQzFELHVFQUE0RDtBQUU1RCxRQUFRLENBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRTtJQUMzQixJQUFJLE9BQW9CLENBQUE7SUFDeEIsSUFBSSxxQkFBMkQsQ0FBQTtJQUMvRCxJQUFJLGVBQTZDLENBQUE7SUFDakQsSUFBSSxrQkFBbUQsQ0FBQTtJQUN2RCxJQUFJLGFBQXlDLENBQUE7SUFFN0MsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLE1BQU0sTUFBTSxHQUFrQixNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUMzRCxTQUFTLEVBQUU7Z0JBQ1QsMEJBQVc7Z0JBQ1g7b0JBQ0UsT0FBTyxFQUFFLElBQUEsNEJBQWtCLEVBQUMsZ0NBQVcsQ0FBQztvQkFDeEMsUUFBUSxFQUFFO3dCQUNSLE9BQU8sRUFBRSxjQUFJLENBQUMsRUFBRSxFQUFFO3dCQUNsQixJQUFJLEVBQUUsY0FBSSxDQUFDLEVBQUUsRUFBRTt3QkFDZixJQUFJLEVBQUUsY0FBSSxDQUFDLEVBQUUsRUFBRTt3QkFDZixNQUFNLEVBQUUsY0FBSSxDQUFDLEVBQUUsRUFBRTtxQkFDbEI7aUJBQ0Y7Z0JBQ0Q7b0JBQ0UsT0FBTyxFQUFFLHlCQUFlO29CQUN4QixRQUFRLEVBQUU7d0JBQ1IsU0FBUyxFQUFFLGNBQUksQ0FBQyxFQUFFLEVBQUU7cUJBQ3JCO2lCQUNGO2dCQUNEO29CQUNFLE9BQU8sRUFBRSx3Q0FBa0I7b0JBQzNCLFFBQVEsRUFBRTt3QkFDUixlQUFlLEVBQUUsY0FBSSxDQUFDLEVBQUUsRUFBRTtxQkFDM0I7aUJBQ0Y7Z0JBQ0Q7b0JB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QUMsQ0FBQTtZQUV2RCxNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUU3RCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzNCLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDLENBQUMsQ0FBQSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXGctZWtvaFxcRGVza3RvcFxcU3RyZWxsZXJNaW5kcy1CYWNrZW5kXFxzcmNcXGkxOG5cXF9fdGVzdHNfX1xcaTE4bi5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgdHlwZSBUZXN0aW5nTW9kdWxlIH0gZnJvbSBcIkBuZXN0anMvdGVzdGluZ1wiXHJcbmltcG9ydCB7IGdldFJlcG9zaXRvcnlUb2tlbiB9IGZyb20gXCJAbmVzdGpzL3R5cGVvcm1cIlxyXG5pbXBvcnQgeyBJMThuU2VydmljZSBhcyBOZXN0STE4blNlcnZpY2UgfSBmcm9tIFwibmVzdGpzLWkxOG5cIlxyXG5pbXBvcnQgdHlwZSB7IFJlcG9zaXRvcnkgfSBmcm9tIFwidHlwZW9ybVwiXHJcbmltcG9ydCB7IGplc3QgfSBmcm9tIFwiQGplc3QvZ2xvYmFsc1wiXHJcblxyXG5pbXBvcnQgeyBJMThuU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2aWNlcy9pMThuLnNlcnZpY2VcIlxyXG5pbXBvcnQgeyBUcmFuc2xhdGlvblNlcnZpY2UgfSBmcm9tIFwiLi4vc2VydmljZXMvdHJhbnNsYXRpb24uc2VydmljZVwiXHJcbmltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tIFwiLi4vc2VydmljZXMvbG9jYWxlLnNlcnZpY2VcIlxyXG5pbXBvcnQgeyBUcmFuc2xhdGlvbiB9IGZyb20gXCIuLi9lbnRpdGllcy90cmFuc2xhdGlvbi5lbnRpdHlcIlxyXG5cclxuZGVzY3JpYmUoXCJJMThuU2VydmljZVwiLCAoKSA9PiB7XHJcbiAgbGV0IHNlcnZpY2U6IEkxOG5TZXJ2aWNlXHJcbiAgbGV0IHRyYW5zbGF0aW9uUmVwb3NpdG9yeTogamVzdC5Nb2NrZWQ8UmVwb3NpdG9yeTxUcmFuc2xhdGlvbj4+XHJcbiAgbGV0IG5lc3RJMThuU2VydmljZTogamVzdC5Nb2NrZWQ8TmVzdEkxOG5TZXJ2aWNlPlxyXG4gIGxldCB0cmFuc2xhdGlvblNlcnZpY2U6IGplc3QuTW9ja2VkPFRyYW5zbGF0aW9uU2VydmljZT5cclxuICBsZXQgbG9jYWxlU2VydmljZTogamVzdC5Nb2NrZWQ8TG9jYWxlU2VydmljZT5cclxuXHJcbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xyXG4gICAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICBJMThuU2VydmljZSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBwcm92aWRlOiBnZXRSZXBvc2l0b3J5VG9rZW4oVHJhbnNsYXRpb24pLFxyXG4gICAgICAgICAgdXNlVmFsdWU6IHtcclxuICAgICAgICAgICAgZmluZE9uZTogamVzdC5mbigpLFxyXG4gICAgICAgICAgICBmaW5kOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICAgIHNhdmU6IGplc3QuZm4oKSxcclxuICAgICAgICAgICAgY3JlYXRlOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogTmVzdEkxOG5TZXJ2aWNlLFxyXG4gICAgICAgICAgdXNlVmFsdWU6IHtcclxuICAgICAgICAgICAgdHJhbnNsYXRlOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogVHJhbnNsYXRpb25TZXJ2aWNlLFxyXG4gICAgICAgICAgdXNlVmFsdWU6IHtcclxuICAgICAgICAgICAgZ2V0VHJhbnNsYXRpb25zOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogTG9jYWxlU2VydmljZSxcclxuICAgICAgICAgIHVzZVZhbHVlOiB7XHJcbiAgICAgICAgICAgIGdldFVzZXJMb2NhbGU6IGplc3QuZm4oKSxcclxuICAgICAgICAgICAgc2V0VXNlckxvY2FsZTogamVzdC5mbigpLFxyXG4gICAgICAgICAgICBnZXRTdXBwb3J0ZWRMb2NhbGVzOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0sXHJcbiAgICB9KS5jb21waWxlKClcclxuXHJcbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxJMThuU2VydmljZT4oSTE4blNlcnZpY2UpXHJcbiAgICB0cmFuc2xhdGlvblJlcG9zaXRvcnkgPSBtb2R1bGUuZ2V0KGdldFJlcG9zaXRvcnlUb2tlbihUcmFuc2xhdGlvbikpXHJcbiAgICBuZXN0STE4blNlcnZpY2UgPSBtb2R1bGUuZ2V0KE5lc3RJMThuU2VydmljZSlcclxuICAgIHRyYW5zbGF0aW9uU2VydmljZSA9IG1vZHVsZS5nZXQoVHJhbnNsYXRpb25TZXJ2aWNlKVxyXG4gICAgbG9jYWxlU2VydmljZSA9IG1vZHVsZS5nZXQoTG9jYWxlU2VydmljZSlcclxuICB9KVxyXG5cclxuICBpdChcInNob3VsZCBiZSBkZWZpbmVkXCIsICgpID0+IHtcclxuICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpXHJcbiAgfSlcclxuXHJcbiAgZGVzY3JpYmUoXCJ0cmFuc2xhdGVcIiwgKCkgPT4ge1xyXG4gICAgaXQoXCJzaG91bGQgcmV0dXJuIHRyYW5zbGF0aW9uIGZyb20gZGF0YWJhc2VcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrVHJhbnNsYXRpb24gPSB7XHJcbiAgICAgICAgaWQ6IFwiMVwiLFxyXG4gICAgICAgIGtleTogXCJoZWxsb1wiLFxyXG4gICAgICAgIGxvY2FsZTogXCJlblwiLFxyXG4gICAgICAgIG5hbWVzcGFjZTogXCJjb21tb25cIixcclxuICAgICAgICB2YWx1ZTogXCJIZWxsbyBXb3JsZFwiLFxyXG4gICAgICAgIHN0YXR1czogXCJwdWJsaXNoZWRcIixcclxuICAgICAgfSBhcyBUcmFuc2xhdGlvblxyXG5cclxuICAgICAgdHJhbnNsYXRpb25SZXBvc2l0b3J5LmZpbmRPbmUubW9ja1Jlc29sdmVkVmFsdWUobW9ja1RyYW5zbGF0aW9uKVxyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS50cmFuc2xhdGUoXCJoZWxsb1wiLCB7IGxvY2FsZTogXCJlblwiIH0pXHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKFwiSGVsbG8gV29ybGRcIilcclxuICAgICAgZXhwZWN0KHRyYW5zbGF0aW9uUmVwb3NpdG9yeS5maW5kT25lKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XHJcbiAgICAgICAgd2hlcmU6IHtcclxuICAgICAgICAgIGtleTogXCJoZWxsb1wiLFxyXG4gICAgICAgICAgbG9jYWxlOiBcImVuXCIsXHJcbiAgICAgICAgICBuYW1lc3BhY2U6IFwiY29tbW9uXCIsXHJcbiAgICAgICAgICBzdGF0dXM6IFwicHVibGlzaGVkXCIsXHJcbiAgICAgICAgfSxcclxuICAgICAgfSlcclxuICAgIH0pXHJcblxyXG4gICAgaXQoXCJzaG91bGQgZmFsbGJhY2sgdG8gZmlsZS1iYXNlZCB0cmFuc2xhdGlvblwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIHRyYW5zbGF0aW9uUmVwb3NpdG9yeS5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpXHJcbiAgICAgIG5lc3RJMThuU2VydmljZS50cmFuc2xhdGUubW9ja1Jlc29sdmVkVmFsdWUoXCJIZWxsbyBmcm9tIGZpbGVcIilcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UudHJhbnNsYXRlKFwiaGVsbG9cIiwgeyBsb2NhbGU6IFwiZW5cIiB9KVxyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShcIkhlbGxvIGZyb20gZmlsZVwiKVxyXG4gICAgICBleHBlY3QobmVzdEkxOG5TZXJ2aWNlLnRyYW5zbGF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXCJjb21tb24uaGVsbG9cIiwge1xyXG4gICAgICAgIGxhbmc6IFwiZW5cIixcclxuICAgICAgICBhcmdzOiB1bmRlZmluZWQsXHJcbiAgICAgICAgZGVmYXVsdFZhbHVlOiB1bmRlZmluZWQsXHJcbiAgICAgIH0pXHJcbiAgICB9KVxyXG5cclxuICAgIGl0KFwic2hvdWxkIGludGVycG9sYXRlIHZhcmlhYmxlcyBpbiB0cmFuc2xhdGlvblwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1vY2tUcmFuc2xhdGlvbiA9IHtcclxuICAgICAgICBpZDogXCIxXCIsXHJcbiAgICAgICAga2V5OiBcIndlbGNvbWVcIixcclxuICAgICAgICBsb2NhbGU6IFwiZW5cIixcclxuICAgICAgICBuYW1lc3BhY2U6IFwiY29tbW9uXCIsXHJcbiAgICAgICAgdmFsdWU6IFwiV2VsY29tZSB7e25hbWV9fSFcIixcclxuICAgICAgICBzdGF0dXM6IFwicHVibGlzaGVkXCIsXHJcbiAgICAgIH0gYXMgVHJhbnNsYXRpb25cclxuXHJcbiAgICAgIHRyYW5zbGF0aW9uUmVwb3NpdG9yeS5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tUcmFuc2xhdGlvbilcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UudHJhbnNsYXRlKFwid2VsY29tZVwiLCB7XHJcbiAgICAgICAgbG9jYWxlOiBcImVuXCIsXHJcbiAgICAgICAgYXJnczogeyBuYW1lOiBcIkpvaG5cIiB9LFxyXG4gICAgICB9KVxyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShcIldlbGNvbWUgSm9obiFcIilcclxuICAgIH0pXHJcblxyXG4gICAgaXQoXCJzaG91bGQgcmV0dXJuIGRlZmF1bHQgdmFsdWUgd2hlbiB0cmFuc2xhdGlvbiBub3QgZm91bmRcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICB0cmFuc2xhdGlvblJlcG9zaXRvcnkuZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKVxyXG4gICAgICBuZXN0STE4blNlcnZpY2UudHJhbnNsYXRlLm1vY2tSZXNvbHZlZFZhbHVlKFwid2VsY29tZVwiKVxyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS50cmFuc2xhdGUoXCJ3ZWxjb21lXCIsIHtcclxuICAgICAgICBsb2NhbGU6IFwiZW5cIixcclxuICAgICAgICBkZWZhdWx0VmFsdWU6IFwiRGVmYXVsdCBXZWxjb21lXCIsXHJcbiAgICAgIH0pXHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKFwiRGVmYXVsdCBXZWxjb21lXCIpXHJcbiAgICB9KVxyXG4gIH0pXHJcblxyXG4gIGRlc2NyaWJlKFwidHJhbnNsYXRlTXVsdGlwbGVcIiwgKCkgPT4ge1xyXG4gICAgaXQoXCJzaG91bGQgdHJhbnNsYXRlIG11bHRpcGxlIGtleXNcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrVHJhbnNsYXRpb25zID0gW1xyXG4gICAgICAgIHtcclxuICAgICAgICAgIGlkOiBcIjFcIixcclxuICAgICAgICAgIGtleTogXCJoZWxsb1wiLFxyXG4gICAgICAgICAgbG9jYWxlOiBcImVuXCIsXHJcbiAgICAgICAgICBuYW1lc3BhY2U6IFwiY29tbW9uXCIsXHJcbiAgICAgICAgICB2YWx1ZTogXCJIZWxsb1wiLFxyXG4gICAgICAgICAgc3RhdHVzOiBcInB1Ymxpc2hlZFwiLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgaWQ6IFwiMlwiLFxyXG4gICAgICAgICAga2V5OiBcImdvb2RieWVcIixcclxuICAgICAgICAgIGxvY2FsZTogXCJlblwiLFxyXG4gICAgICAgICAgbmFtZXNwYWNlOiBcImNvbW1vblwiLFxyXG4gICAgICAgICAgdmFsdWU6IFwiR29vZGJ5ZVwiLFxyXG4gICAgICAgICAgc3RhdHVzOiBcInB1Ymxpc2hlZFwiLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0gYXMgVHJhbnNsYXRpb25bXVxyXG5cclxuICAgICAgdHJhbnNsYXRpb25SZXBvc2l0b3J5LmZpbmRPbmVcclxuICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWVPbmNlKG1vY2tUcmFuc2xhdGlvbnNbMF0pXHJcbiAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlT25jZShtb2NrVHJhbnNsYXRpb25zWzFdKVxyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS50cmFuc2xhdGVNdWx0aXBsZShbXCJoZWxsb1wiLCBcImdvb2RieWVcIl0sIHsgbG9jYWxlOiBcImVuXCIgfSlcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoe1xyXG4gICAgICAgIGhlbGxvOiBcIkhlbGxvXCIsXHJcbiAgICAgICAgZ29vZGJ5ZTogXCJHb29kYnllXCIsXHJcbiAgICAgIH0pXHJcbiAgICB9KVxyXG4gIH0pXHJcblxyXG4gIGRlc2NyaWJlKFwiZGV0ZWN0TG9jYWxlRnJvbVJlcXVlc3RcIiwgKCkgPT4ge1xyXG4gICAgaXQoXCJzaG91bGQgZGV0ZWN0IGxvY2FsZSBmcm9tIHF1ZXJ5IHBhcmFtZXRlclwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB7XHJcbiAgICAgICAgcXVlcnk6IHsgbGFuZzogXCJmclwiIH0sXHJcbiAgICAgICAgaGVhZGVyczoge30sXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZGV0ZWN0TG9jYWxlRnJvbVJlcXVlc3QocmVxdWVzdClcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoXCJmclwiKVxyXG4gICAgfSlcclxuXHJcbiAgICBpdChcInNob3VsZCBkZXRlY3QgbG9jYWxlIGZyb20gY3VzdG9tIGhlYWRlclwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB7XHJcbiAgICAgICAgcXVlcnk6IHt9LFxyXG4gICAgICAgIGhlYWRlcnM6IHsgXCJ4LWN1c3RvbS1sYW5nXCI6IFwiZGVcIiB9LFxyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmRldGVjdExvY2FsZUZyb21SZXF1ZXN0KHJlcXVlc3QpXHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKFwiZGVcIilcclxuICAgIH0pXHJcblxyXG4gICAgaXQoXCJzaG91bGQgZGV0ZWN0IGxvY2FsZSBmcm9tIEFjY2VwdC1MYW5ndWFnZSBoZWFkZXJcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCByZXF1ZXN0ID0ge1xyXG4gICAgICAgIHF1ZXJ5OiB7fSxcclxuICAgICAgICBoZWFkZXJzOiB7IFwiYWNjZXB0LWxhbmd1YWdlXCI6IFwiZXMtRVMsZXM7cT0wLjksZW47cT0wLjhcIiB9LFxyXG4gICAgICB9XHJcblxyXG4gICAgICBsb2NhbGVTZXJ2aWNlLmdldFN1cHBvcnRlZExvY2FsZXMubW9ja1Jlc29sdmVkVmFsdWUoW1xyXG4gICAgICAgIHsgY29kZTogXCJlcy1FU1wiLCBzdGF0dXM6IFwiYWN0aXZlXCIgfSBhcyBhbnksXHJcbiAgICAgICAgeyBjb2RlOiBcImVuXCIsIHN0YXR1czogXCJhY3RpdmVcIiB9IGFzIGFueSxcclxuICAgICAgXSlcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZGV0ZWN0TG9jYWxlRnJvbVJlcXVlc3QocmVxdWVzdClcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoXCJlcy1FU1wiKVxyXG4gICAgfSlcclxuXHJcbiAgICBpdChcInNob3VsZCBmYWxsYmFjayB0byBkZWZhdWx0IGxvY2FsZVwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSB7XHJcbiAgICAgICAgcXVlcnk6IHt9LFxyXG4gICAgICAgIGhlYWRlcnM6IHt9LFxyXG4gICAgICB9XHJcblxyXG4gICAgICBsb2NhbGVTZXJ2aWNlLmdldFN1cHBvcnRlZExvY2FsZXMubW9ja1Jlc29sdmVkVmFsdWUoW10pXHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmRldGVjdExvY2FsZUZyb21SZXF1ZXN0KHJlcXVlc3QpXHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKFwiZW5cIilcclxuICAgIH0pXHJcbiAgfSlcclxufSlcclxuIl0sInZlcnNpb24iOjN9