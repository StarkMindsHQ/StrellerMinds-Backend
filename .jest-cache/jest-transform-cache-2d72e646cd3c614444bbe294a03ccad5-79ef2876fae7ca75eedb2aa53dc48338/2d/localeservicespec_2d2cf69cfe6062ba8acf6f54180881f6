0c6177d46605202aef0ec7660cf20cf5
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const testing_1 = require("@nestjs/testing");
const typeorm_1 = require("@nestjs/typeorm");
const locale_service_1 = require("../services/locale.service");
const user_locale_entity_1 = require("../entities/user-locale.entity");
const locale_metadata_entity_1 = require("../entities/locale-metadata.entity");
describe("LocaleService", () => {
    let service;
    let userLocaleRepository;
    let localeMetadataRepository;
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                locale_service_1.LocaleService,
                {
                    provide: (0, typeorm_1.getRepositoryToken)(user_locale_entity_1.UserLocale),
                    useValue: {
                        findOne: globals_1.jest.fn(),
                        save: globals_1.jest.fn(),
                        create: globals_1.jest.fn(),
                        update: globals_1.jest.fn(),
                    },
                },
                {
                    provide: (0, typeorm_1.getRepositoryToken)(locale_metadata_entity_1.LocaleMetadata),
                    useValue: {
                        findOne: globals_1.jest.fn(),
                        find: globals_1.jest.fn(),
                        save: globals_1.jest.fn(),
                        create: globals_1.jest.fn(),
                        update: globals_1.jest.fn(),
                    },
                },
            ],
        }).compile();
        service = module.get(locale_service_1.LocaleService);
        userLocaleRepository = module.get((0, typeorm_1.getRepositoryToken)(user_locale_entity_1.UserLocale));
        localeMetadataRepository = module.get((0, typeorm_1.getRepositoryToken)(locale_metadata_entity_1.LocaleMetadata));
    });
    it("should be defined", () => {
        expect(service).toBeDefined();
    });
    describe("getUserLocale", () => {
        it("should return user locale if exists", async () => {
            const mockUserLocale = {
                id: "1",
                userId: "user1",
                locale: "fr",
                isActive: true,
            };
            userLocaleRepository.findOne.mockResolvedValue(mockUserLocale);
            const result = await service.getUserLocale("user1");
            expect(result).toBe("fr");
            expect(userLocaleRepository.update).toHaveBeenCalledWith("1", {
                lastUsedAt: expect.any(Date),
            });
        });
        it("should return default locale if user locale not found", async () => {
            userLocaleRepository.findOne.mockResolvedValue(null);
            const result = await service.getUserLocale("user1");
            expect(result).toBe("en");
        });
    });
    describe("setUserLocale", () => {
        it("should create new user locale", async () => {
            const mockLocaleMetadata = {
                code: "fr",
                status: locale_metadata_entity_1.LocaleStatus.ACTIVE,
                fallbackLocales: ["en"],
            };
            userLocaleRepository.findOne.mockResolvedValue(null);
            localeMetadataRepository.findOne.mockResolvedValue(mockLocaleMetadata);
            userLocaleRepository.create.mockReturnValue({});
            userLocaleRepository.save.mockResolvedValue({
                id: "1",
                userId: "user1",
                locale: "fr",
            });
            const result = await service.setUserLocale("user1", "fr");
            expect(result.locale).toBe("fr");
            expect(userLocaleRepository.create).toHaveBeenCalledWith({
                userId: "user1",
                locale: "fr",
                source: user_locale_entity_1.LocaleSource.USER_PREFERENCE,
                fallbackLocales: ["en"],
                lastUsedAt: expect.any(Date),
            });
        });
        it("should throw error for unsupported locale", async () => {
            localeMetadataRepository.findOne.mockResolvedValue(null);
            await expect(service.setUserLocale("user1", "invalid")).rejects.toThrow("Locale invalid is not supported or active");
        });
    });
    describe("detectLocaleFromGeoLocation", () => {
        it("should return locale for known country", async () => {
            const mockLocaleMetadata = {
                code: "fr-FR",
                status: locale_metadata_entity_1.LocaleStatus.ACTIVE,
            };
            localeMetadataRepository.findOne.mockResolvedValue(mockLocaleMetadata);
            const result = await service.detectLocaleFromGeoLocation("FR");
            expect(result).toBe("fr-FR");
        });
        it("should return default locale for unknown country", async () => {
            const result = await service.detectLocaleFromGeoLocation("XX");
            expect(result).toBe("en");
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxpMThuXFxfX3Rlc3RzX19cXGxvY2FsZS5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFHQSwyQ0FBb0M7QUFIcEMsNkNBQTBEO0FBQzFELDZDQUFvRDtBQUlwRCwrREFBMEQ7QUFDMUQsdUVBQXlFO0FBQ3pFLCtFQUFpRjtBQUVqRixRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtJQUM3QixJQUFJLE9BQXNCLENBQUE7SUFDMUIsSUFBSSxvQkFBeUQsQ0FBQTtJQUM3RCxJQUFJLHdCQUFpRSxDQUFBO0lBRXJFLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFO2dCQUNULDhCQUFhO2dCQUNiO29CQUNFLE9BQU8sRUFBRSxJQUFBLDRCQUFrQixFQUFDLCtCQUFVLENBQUM7b0JBQ3ZDLFFBQVEsRUFBRTt3QkFDUixPQUFPLEVBQUUsY0FBSSxDQUFDLEVBQUUsRUFBRTt3QkFDbEIsSUFBSSxFQUFFLGNBQUksQ0FBQyxFQUFFLEVBQUU7d0JBQ2YsTUFBTSxFQUFFLGNBQUksQ0FBQyxFQUFFLEVBQUU7d0JBQ2pCLE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxFQUFFO3FCQUNsQjtpQkFDRjtnQkFDRDtvQkFDRSxPQUFPLEVBQUUsSUFBQSw0QkFBa0IsRUFBQyx1Q0FBYyxDQUFDO29CQUMzQyxRQUFRLEVBQUU7d0JBQ1IsT0FBTyxFQUFFLGNBQUksQ0FBQyxFQUFFLEVBQUU7d0JBQ2xCLElBQUksRUFBRSxjQUFJLENBQUMsRUFBRSxFQUFFO3dCQUNmLElBQUksRUFBRSxjQUFJLENBQUMsRUFBRSxFQUFFO3dCQUNmLE1BQU0sRUFBRSxjQUFJLENBQUMsRUFBRSxFQUFFO3dCQUNqQixNQUFNLEVBQUUsY0FBSSxDQUFDLEVBQUUsRUFBRTtxQkFDbEI7aUJBQ0Y7YUFD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QyxDQUFBO1lBRTlELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDM0IsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMsQ0FBQyxDQUFBIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZy1la29oXFxEZXNrdG9wXFxTdHJlbGxlck1pbmRzLUJhY2tlbmRcXHNyY1xcaTE4blxcX190ZXN0c19fXFxsb2NhbGUuc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIHR5cGUgVGVzdGluZ01vZHVsZSB9IGZyb20gXCJAbmVzdGpzL3Rlc3RpbmdcIlxyXG5pbXBvcnQgeyBnZXRSZXBvc2l0b3J5VG9rZW4gfSBmcm9tIFwiQG5lc3Rqcy90eXBlb3JtXCJcclxuaW1wb3J0IHR5cGUgeyBSZXBvc2l0b3J5IH0gZnJvbSBcInR5cGVvcm1cIlxyXG5pbXBvcnQgeyBqZXN0IH0gZnJvbSBcIkBqZXN0L2dsb2JhbHNcIlxyXG5cclxuaW1wb3J0IHsgTG9jYWxlU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2aWNlcy9sb2NhbGUuc2VydmljZVwiXHJcbmltcG9ydCB7IFVzZXJMb2NhbGUsIExvY2FsZVNvdXJjZSB9IGZyb20gXCIuLi9lbnRpdGllcy91c2VyLWxvY2FsZS5lbnRpdHlcIlxyXG5pbXBvcnQgeyBMb2NhbGVNZXRhZGF0YSwgTG9jYWxlU3RhdHVzIH0gZnJvbSBcIi4uL2VudGl0aWVzL2xvY2FsZS1tZXRhZGF0YS5lbnRpdHlcIlxyXG5cclxuZGVzY3JpYmUoXCJMb2NhbGVTZXJ2aWNlXCIsICgpID0+IHtcclxuICBsZXQgc2VydmljZTogTG9jYWxlU2VydmljZVxyXG4gIGxldCB1c2VyTG9jYWxlUmVwb3NpdG9yeTogamVzdC5Nb2NrZWQ8UmVwb3NpdG9yeTxVc2VyTG9jYWxlPj5cclxuICBsZXQgbG9jYWxlTWV0YWRhdGFSZXBvc2l0b3J5OiBqZXN0Lk1vY2tlZDxSZXBvc2l0b3J5PExvY2FsZU1ldGFkYXRhPj5cclxuXHJcbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xyXG4gICAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICBMb2NhbGVTZXJ2aWNlLFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIHByb3ZpZGU6IGdldFJlcG9zaXRvcnlUb2tlbihVc2VyTG9jYWxlKSxcclxuICAgICAgICAgIHVzZVZhbHVlOiB7XHJcbiAgICAgICAgICAgIGZpbmRPbmU6IGplc3QuZm4oKSxcclxuICAgICAgICAgICAgc2F2ZTogamVzdC5mbigpLFxyXG4gICAgICAgICAgICBjcmVhdGU6IGplc3QuZm4oKSxcclxuICAgICAgICAgICAgdXBkYXRlOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogZ2V0UmVwb3NpdG9yeVRva2VuKExvY2FsZU1ldGFkYXRhKSxcclxuICAgICAgICAgIHVzZVZhbHVlOiB7XHJcbiAgICAgICAgICAgIGZpbmRPbmU6IGplc3QuZm4oKSxcclxuICAgICAgICAgICAgZmluZDogamVzdC5mbigpLFxyXG4gICAgICAgICAgICBzYXZlOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICAgIGNyZWF0ZTogamVzdC5mbigpLFxyXG4gICAgICAgICAgICB1cGRhdGU6IGplc3QuZm4oKSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgXSxcclxuICAgIH0pLmNvbXBpbGUoKVxyXG5cclxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PExvY2FsZVNlcnZpY2U+KExvY2FsZVNlcnZpY2UpXHJcbiAgICB1c2VyTG9jYWxlUmVwb3NpdG9yeSA9IG1vZHVsZS5nZXQoZ2V0UmVwb3NpdG9yeVRva2VuKFVzZXJMb2NhbGUpKVxyXG4gICAgbG9jYWxlTWV0YWRhdGFSZXBvc2l0b3J5ID0gbW9kdWxlLmdldChnZXRSZXBvc2l0b3J5VG9rZW4oTG9jYWxlTWV0YWRhdGEpKVxyXG4gIH0pXHJcblxyXG4gIGl0KFwic2hvdWxkIGJlIGRlZmluZWRcIiwgKCkgPT4ge1xyXG4gICAgZXhwZWN0KHNlcnZpY2UpLnRvQmVEZWZpbmVkKClcclxuICB9KVxyXG5cclxuICBkZXNjcmliZShcImdldFVzZXJMb2NhbGVcIiwgKCkgPT4ge1xyXG4gICAgaXQoXCJzaG91bGQgcmV0dXJuIHVzZXIgbG9jYWxlIGlmIGV4aXN0c1wiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1vY2tVc2VyTG9jYWxlID0ge1xyXG4gICAgICAgIGlkOiBcIjFcIixcclxuICAgICAgICB1c2VySWQ6IFwidXNlcjFcIixcclxuICAgICAgICBsb2NhbGU6IFwiZnJcIixcclxuICAgICAgICBpc0FjdGl2ZTogdHJ1ZSxcclxuICAgICAgfSBhcyBVc2VyTG9jYWxlXHJcblxyXG4gICAgICB1c2VyTG9jYWxlUmVwb3NpdG9yeS5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc2VyTG9jYWxlKVxyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5nZXRVc2VyTG9jYWxlKFwidXNlcjFcIilcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoXCJmclwiKVxyXG4gICAgICBleHBlY3QodXNlckxvY2FsZVJlcG9zaXRvcnkudXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcIjFcIiwge1xyXG4gICAgICAgIGxhc3RVc2VkQXQ6IGV4cGVjdC5hbnkoRGF0ZSksXHJcbiAgICAgIH0pXHJcbiAgICB9KVxyXG5cclxuICAgIGl0KFwic2hvdWxkIHJldHVybiBkZWZhdWx0IGxvY2FsZSBpZiB1c2VyIGxvY2FsZSBub3QgZm91bmRcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICB1c2VyTG9jYWxlUmVwb3NpdG9yeS5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpXHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmdldFVzZXJMb2NhbGUoXCJ1c2VyMVwiKVxyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShcImVuXCIpXHJcbiAgICB9KVxyXG4gIH0pXHJcblxyXG4gIGRlc2NyaWJlKFwic2V0VXNlckxvY2FsZVwiLCAoKSA9PiB7XHJcbiAgICBpdChcInNob3VsZCBjcmVhdGUgbmV3IHVzZXIgbG9jYWxlXCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbW9ja0xvY2FsZU1ldGFkYXRhID0ge1xyXG4gICAgICAgIGNvZGU6IFwiZnJcIixcclxuICAgICAgICBzdGF0dXM6IExvY2FsZVN0YXR1cy5BQ1RJVkUsXHJcbiAgICAgICAgZmFsbGJhY2tMb2NhbGVzOiBbXCJlblwiXSxcclxuICAgICAgfSBhcyBMb2NhbGVNZXRhZGF0YVxyXG5cclxuICAgICAgdXNlckxvY2FsZVJlcG9zaXRvcnkuZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKVxyXG4gICAgICBsb2NhbGVNZXRhZGF0YVJlcG9zaXRvcnkuZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrTG9jYWxlTWV0YWRhdGEpXHJcbiAgICAgIHVzZXJMb2NhbGVSZXBvc2l0b3J5LmNyZWF0ZS5tb2NrUmV0dXJuVmFsdWUoe30gYXMgYW55KVxyXG4gICAgICB1c2VyTG9jYWxlUmVwb3NpdG9yeS5zYXZlLm1vY2tSZXNvbHZlZFZhbHVlKHtcclxuICAgICAgICBpZDogXCIxXCIsXHJcbiAgICAgICAgdXNlcklkOiBcInVzZXIxXCIsXHJcbiAgICAgICAgbG9jYWxlOiBcImZyXCIsXHJcbiAgICAgIH0gYXMgYW55KVxyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5zZXRVc2VyTG9jYWxlKFwidXNlcjFcIiwgXCJmclwiKVxyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5sb2NhbGUpLnRvQmUoXCJmclwiKVxyXG4gICAgICBleHBlY3QodXNlckxvY2FsZVJlcG9zaXRvcnkuY3JlYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XHJcbiAgICAgICAgdXNlcklkOiBcInVzZXIxXCIsXHJcbiAgICAgICAgbG9jYWxlOiBcImZyXCIsXHJcbiAgICAgICAgc291cmNlOiBMb2NhbGVTb3VyY2UuVVNFUl9QUkVGRVJFTkNFLFxyXG4gICAgICAgIGZhbGxiYWNrTG9jYWxlczogW1wiZW5cIl0sXHJcbiAgICAgICAgbGFzdFVzZWRBdDogZXhwZWN0LmFueShEYXRlKSxcclxuICAgICAgfSlcclxuICAgIH0pXHJcblxyXG4gICAgaXQoXCJzaG91bGQgdGhyb3cgZXJyb3IgZm9yIHVuc3VwcG9ydGVkIGxvY2FsZVwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGxvY2FsZU1ldGFkYXRhUmVwb3NpdG9yeS5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpXHJcblxyXG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5zZXRVc2VyTG9jYWxlKFwidXNlcjFcIiwgXCJpbnZhbGlkXCIpKS5yZWplY3RzLnRvVGhyb3coXHJcbiAgICAgICAgXCJMb2NhbGUgaW52YWxpZCBpcyBub3Qgc3VwcG9ydGVkIG9yIGFjdGl2ZVwiLFxyXG4gICAgICApXHJcbiAgICB9KVxyXG4gIH0pXHJcblxyXG4gIGRlc2NyaWJlKFwiZGV0ZWN0TG9jYWxlRnJvbUdlb0xvY2F0aW9uXCIsICgpID0+IHtcclxuICAgIGl0KFwic2hvdWxkIHJldHVybiBsb2NhbGUgZm9yIGtub3duIGNvdW50cnlcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrTG9jYWxlTWV0YWRhdGEgPSB7XHJcbiAgICAgICAgY29kZTogXCJmci1GUlwiLFxyXG4gICAgICAgIHN0YXR1czogTG9jYWxlU3RhdHVzLkFDVElWRSxcclxuICAgICAgfSBhcyBMb2NhbGVNZXRhZGF0YVxyXG5cclxuICAgICAgbG9jYWxlTWV0YWRhdGFSZXBvc2l0b3J5LmZpbmRPbmUubW9ja1Jlc29sdmVkVmFsdWUobW9ja0xvY2FsZU1ldGFkYXRhKVxyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5kZXRlY3RMb2NhbGVGcm9tR2VvTG9jYXRpb24oXCJGUlwiKVxyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShcImZyLUZSXCIpXHJcbiAgICB9KVxyXG5cclxuICAgIGl0KFwic2hvdWxkIHJldHVybiBkZWZhdWx0IGxvY2FsZSBmb3IgdW5rbm93biBjb3VudHJ5XCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5kZXRlY3RMb2NhbGVGcm9tR2VvTG9jYXRpb24oXCJYWFwiKVxyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShcImVuXCIpXHJcbiAgICB9KVxyXG4gIH0pXHJcbn0pXHJcbiJdLCJ2ZXJzaW9uIjozfQ==