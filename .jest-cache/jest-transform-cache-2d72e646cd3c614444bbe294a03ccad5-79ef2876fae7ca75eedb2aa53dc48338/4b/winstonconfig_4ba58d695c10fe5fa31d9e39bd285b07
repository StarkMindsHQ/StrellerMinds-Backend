bddc9b67ecf31936948e4e371a43cf99
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.WinstonConfigService = void 0;
const winston = __importStar(require("winston"));
const DailyRotateFile = __importStar(require("winston-daily-rotate-file"));
class WinstonConfigService {
    constructor(configService) {
        this.configService = configService;
        this.config = {
            level: this.configService.get('LOG_LEVEL', 'info'),
            format: this.configService.get('LOG_FORMAT', 'json'),
            file: {
                enabled: this.configService.get('LOG_FILE_ENABLED', true),
                path: this.configService.get('LOG_FILE_PATH', 'logs/app-%DATE%.log'),
                maxSize: this.configService.get('LOG_FILE_MAX_SIZE', '20m'),
                maxFiles: this.configService.get('LOG_FILE_MAX_FILES', 14),
            },
            console: {
                enabled: this.configService.get('LOG_CONSOLE_ENABLED', true),
                colorize: this.configService.get('LOG_CONSOLE_COLORIZE', true),
            },
            errorFile: {
                enabled: this.configService.get('LOG_ERROR_FILE_ENABLED', true),
                path: this.configService.get('LOG_ERROR_FILE_PATH', 'logs/error-%DATE%.log'),
                maxSize: this.configService.get('LOG_ERROR_FILE_MAX_SIZE', '20m'),
                maxFiles: this.configService.get('LOG_ERROR_FILE_MAX_FILES', 30),
            },
        };
    }
    createWinstonLogger() {
        const transports = [];
        // Console transport
        if (this.config.console.enabled) {
            transports.push(new winston.transports.Console({
                level: this.config.level,
                format: this.getConsoleFormat(),
            }));
        }
        // File transport for all logs
        if (this.config.file.enabled) {
            transports.push(new DailyRotateFile({
                level: this.config.level,
                filename: this.config.file.path,
                datePattern: 'YYYY-MM-DD',
                maxSize: this.config.file.maxSize,
                maxFiles: this.config.file.maxFiles,
                format: this.getFileFormat(),
                auditFile: 'logs/audit.json',
            }));
        }
        // Error file transport (only errors and above)
        if (this.config.errorFile.enabled) {
            transports.push(new DailyRotateFile({
                level: 'error',
                filename: this.config.errorFile.path,
                datePattern: 'YYYY-MM-DD',
                maxSize: this.config.errorFile.maxSize,
                maxFiles: this.config.errorFile.maxFiles,
                format: this.getFileFormat(),
                auditFile: 'logs/error-audit.json',
            }));
        }
        return winston.createLogger({
            level: this.config.level,
            format: this.getBaseFormat(),
            transports,
            exitOnError: false,
            handleExceptions: true,
            handleRejections: true,
        });
    }
    getBaseFormat() {
        return winston.format.combine(winston.format.timestamp({
            format: 'YYYY-MM-DD HH:mm:ss.SSS',
        }), winston.format.errors({ stack: true }), winston.format.metadata({
            fillExcept: ['message', 'level', 'timestamp', 'label'],
        }));
    }
    getConsoleFormat() {
        const formats = [this.getBaseFormat()];
        if (this.config.console.colorize) {
            formats.push(winston.format.colorize({ all: true }));
        }
        if (this.config.format === 'json') {
            formats.push(winston.format.json());
        }
        else {
            formats.push(winston.format.printf(({ timestamp, level, message, metadata, stack }) => {
                let log = `${timestamp} [${level}] ${message}`;
                if (metadata && Object.keys(metadata).length > 0) {
                    log += ` ${JSON.stringify(metadata)}`;
                }
                if (stack) {
                    log += `\n${stack}`;
                }
                return log;
            }));
        }
        return winston.format.combine(...formats);
    }
    getFileFormat() {
        return winston.format.combine(this.getBaseFormat(), winston.format.json());
    }
}
exports.WinstonConfigService = WinstonConfigService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxjb21tb25cXGxvZ2dpbmdcXHdpbnN0b24uY29uZmlnLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGlEQUFtQztBQUNuQywyRUFBNkQ7QUF3QjdELE1BQWEsb0JBQW9CO0lBRy9CLFlBQTZCLGFBQTRCO1FBQTVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQ3ZELElBQUksQ0FBQyxNQUFNLEdBQUc7WUFDWixLQUFLLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQVMsV0FBVyxFQUFFLE1BQU0sQ0FBQztZQUMxRCxNQUFNLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQWtCLFlBQVksRUFBRSxNQUFNLENBQUM7WUFDckUsSUFBSSxFQUFFO2dCQUNKLE9BQU8sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBVSxrQkFBa0IsRUFBRSxJQUFJLENBQUM7Z0JBQ2xFLElBQUksRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBUyxlQUFlLEVBQUUscUJBQXFCLENBQUM7Z0JBQzVFLE9BQU8sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBUyxtQkFBbUIsRUFBRSxLQUFLLENBQUM7Z0JBQ25FLFFBQVEsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBUyxvQkFBb0IsRUFBRSxFQUFFLENBQUM7YUFDbkU7WUFDRCxPQUFPLEVBQUU7Z0JBQ1AsT0FBTyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFVLHFCQUFxQixFQUFFLElBQUksQ0FBQztnQkFDckUsUUFBUSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFVLHNCQUFzQixFQUFFLElBQUksQ0FBQzthQUN4RTtZQUNELFNBQVMsRUFBRTtnQkFDVCxPQUFPLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FB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LENBQUM7WUFDYixDQUFDLENBQUMsQ0FDSCxDQUFDO1FBQ0osQ0FBQztRQUVELE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxPQUFPLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRU8sYUFBYTtRQUNuQixPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUMzQixJQUFJLENBQUMsYUFBYSxFQUFFLEVBQ3BCLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQ3RCLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUEvSEQsb0RBK0hDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZy1la29oXFxEZXNrdG9wXFxTdHJlbGxlck1pbmRzLUJhY2tlbmRcXHNyY1xcY29tbW9uXFxsb2dnaW5nXFx3aW5zdG9uLmNvbmZpZy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB3aW5zdG9uIGZyb20gJ3dpbnN0b24nO1xyXG5pbXBvcnQgKiBhcyBEYWlseVJvdGF0ZUZpbGUgZnJvbSAnd2luc3Rvbi1kYWlseS1yb3RhdGUtZmlsZSc7XHJcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIExvZ2dpbmdDb25maWcge1xyXG4gIGxldmVsOiBzdHJpbmc7XHJcbiAgZm9ybWF0OiAnanNvbicgfCAndGV4dCc7XHJcbiAgZmlsZToge1xyXG4gICAgZW5hYmxlZDogYm9vbGVhbjtcclxuICAgIHBhdGg6IHN0cmluZztcclxuICAgIG1heFNpemU6IHN0cmluZztcclxuICAgIG1heEZpbGVzOiBudW1iZXI7XHJcbiAgfTtcclxuICBjb25zb2xlOiB7XHJcbiAgICBlbmFibGVkOiBib29sZWFuO1xyXG4gICAgY29sb3JpemU6IGJvb2xlYW47XHJcbiAgfTtcclxuICBlcnJvckZpbGU6IHtcclxuICAgIGVuYWJsZWQ6IGJvb2xlYW47XHJcbiAgICBwYXRoOiBzdHJpbmc7XHJcbiAgICBtYXhTaXplOiBzdHJpbmc7XHJcbiAgICBtYXhGaWxlczogbnVtYmVyO1xyXG4gIH07XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBXaW5zdG9uQ29uZmlnU2VydmljZSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBjb25maWc6IExvZ2dpbmdDb25maWc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSkge1xyXG4gICAgdGhpcy5jb25maWcgPSB7XHJcbiAgICAgIGxldmVsOiB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0xPR19MRVZFTCcsICdpbmZvJyksXHJcbiAgICAgIGZvcm1hdDogdGhpcy5jb25maWdTZXJ2aWNlLmdldDwnanNvbicgfCAndGV4dCc+KCdMT0dfRk9STUFUJywgJ2pzb24nKSxcclxuICAgICAgZmlsZToge1xyXG4gICAgICAgIGVuYWJsZWQ6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8Ym9vbGVhbj4oJ0xPR19GSUxFX0VOQUJMRUQnLCB0cnVlKSxcclxuICAgICAgICBwYXRoOiB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0xPR19GSUxFX1BBVEgnLCAnbG9ncy9hcHAtJURBVEUlLmxvZycpLFxyXG4gICAgICAgIG1heFNpemU6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignTE9HX0ZJTEVfTUFYX1NJWkUnLCAnMjBtJyksXHJcbiAgICAgICAgbWF4RmlsZXM6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPignTE9HX0ZJTEVfTUFYX0ZJTEVTJywgMTQpLFxyXG4gICAgICB9LFxyXG4gICAgICBjb25zb2xlOiB7XHJcbiAgICAgICAgZW5hYmxlZDogdGhpcy5jb25maWdTZXJ2aWNlLmdldDxib29sZWFuPignTE9HX0NPTlNPTEVfRU5BQkxFRCcsIHRydWUpLFxyXG4gICAgICAgIGNvbG9yaXplOiB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PGJvb2xlYW4+KCdMT0dfQ09OU09MRV9DT0xPUklaRScsIHRydWUpLFxyXG4gICAgICB9LFxyXG4gICAgICBlcnJvckZpbGU6IHtcclxuICAgICAgICBlbmFibGVkOiB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PGJvb2xlYW4+KCdMT0dfRVJST1JfRklMRV9FTkFCTEVEJywgdHJ1ZSksXHJcbiAgICAgICAgcGF0aDogdGhpcy5jb25maWdTZXJ2aWNlLmdldDxzdHJpbmc+KCdMT0dfRVJST1JfRklMRV9QQVRIJywgJ2xvZ3MvZXJyb3ItJURBVEUlLmxvZycpLFxyXG4gICAgICAgIG1heFNpemU6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignTE9HX0VSUk9SX0ZJTEVfTUFYX1NJWkUnLCAnMjBtJyksXHJcbiAgICAgICAgbWF4RmlsZXM6IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8bnVtYmVyPignTE9HX0VSUk9SX0ZJTEVfTUFYX0ZJTEVTJywgMzApLFxyXG4gICAgICB9LFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGNyZWF0ZVdpbnN0b25Mb2dnZXIoKTogd2luc3Rvbi5Mb2dnZXIge1xyXG4gICAgY29uc3QgdHJhbnNwb3J0czogd2luc3Rvbi50cmFuc3BvcnRbXSA9IFtdO1xyXG5cclxuICAgIC8vIENvbnNvbGUgdHJhbnNwb3J0XHJcbiAgICBpZiAodGhpcy5jb25maWcuY29uc29sZS5lbmFibGVkKSB7XHJcbiAgICAgIHRyYW5zcG9ydHMucHVzaChcclxuICAgICAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUoe1xyXG4gICAgICAgICAgbGV2ZWw6IHRoaXMuY29uZmlnLmxldmVsLFxyXG4gICAgICAgICAgZm9ybWF0OiB0aGlzLmdldENvbnNvbGVGb3JtYXQoKSxcclxuICAgICAgICB9KSxcclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBGaWxlIHRyYW5zcG9ydCBmb3IgYWxsIGxvZ3NcclxuICAgIGlmICh0aGlzLmNvbmZpZy5maWxlLmVuYWJsZWQpIHtcclxuICAgICAgdHJhbnNwb3J0cy5wdXNoKFxyXG4gICAgICAgIG5ldyBEYWlseVJvdGF0ZUZpbGUoe1xyXG4gICAgICAgICAgbGV2ZWw6IHRoaXMuY29uZmlnLmxldmVsLFxyXG4gICAgICAgICAgZmlsZW5hbWU6IHRoaXMuY29uZmlnLmZpbGUucGF0aCxcclxuICAgICAgICAgIGRhdGVQYXR0ZXJuOiAnWVlZWS1NTS1ERCcsXHJcbiAgICAgICAgICBtYXhTaXplOiB0aGlzLmNvbmZpZy5maWxlLm1heFNpemUsXHJcbiAgICAgICAgICBtYXhGaWxlczogdGhpcy5jb25maWcuZmlsZS5tYXhGaWxlcyxcclxuICAgICAgICAgIGZvcm1hdDogdGhpcy5nZXRGaWxlRm9ybWF0KCksXHJcbiAgICAgICAgICBhdWRpdEZpbGU6ICdsb2dzL2F1ZGl0Lmpzb24nLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEVycm9yIGZpbGUgdHJhbnNwb3J0IChvbmx5IGVycm9ycyBhbmQgYWJvdmUpXHJcbiAgICBpZiAodGhpcy5jb25maWcuZXJyb3JGaWxlLmVuYWJsZWQpIHtcclxuICAgICAgdHJhbnNwb3J0cy5wdXNoKFxyXG4gICAgICAgIG5ldyBEYWlseVJvdGF0ZUZpbGUoe1xyXG4gICAgICAgICAgbGV2ZWw6ICdlcnJvcicsXHJcbiAgICAgICAgICBmaWxlbmFtZTogdGhpcy5jb25maWcuZXJyb3JGaWxlLnBhdGgsXHJcbiAgICAgICAgICBkYXRlUGF0dGVybjogJ1lZWVktTU0tREQnLFxyXG4gICAgICAgICAgbWF4U2l6ZTogdGhpcy5jb25maWcuZXJyb3JGaWxlLm1heFNpemUsXHJcbiAgICAgICAgICBtYXhGaWxlczogdGhpcy5jb25maWcuZXJyb3JGaWxlLm1heEZpbGVzLFxyXG4gICAgICAgICAgZm9ybWF0OiB0aGlzLmdldEZpbGVGb3JtYXQoKSxcclxuICAgICAgICAgIGF1ZGl0RmlsZTogJ2xvZ3MvZXJyb3ItYXVkaXQuanNvbicsXHJcbiAgICAgICAgfSksXHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHdpbnN0b24uY3JlYXRlTG9nZ2VyKHtcclxuICAgICAgbGV2ZWw6IHRoaXMuY29uZmlnLmxldmVsLFxyXG4gICAgICBmb3JtYXQ6IHRoaXMuZ2V0QmFzZUZvcm1hdCgpLFxyXG4gICAgICB0cmFuc3BvcnRzLFxyXG4gICAgICBleGl0T25FcnJvcjogZmFsc2UsXHJcbiAgICAgIGhhbmRsZUV4Y2VwdGlvbnM6IHRydWUsXHJcbiAgICAgIGhhbmRsZVJlamVjdGlvbnM6IHRydWUsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0QmFzZUZvcm1hdCgpOiB3aW5zdG9uLkxvZ2Zvcm0uRm9ybWF0IHtcclxuICAgIHJldHVybiB3aW5zdG9uLmZvcm1hdC5jb21iaW5lKFxyXG4gICAgICB3aW5zdG9uLmZvcm1hdC50aW1lc3RhbXAoe1xyXG4gICAgICAgIGZvcm1hdDogJ1lZWVktTU0tREQgSEg6bW06c3MuU1NTJyxcclxuICAgICAgfSksXHJcbiAgICAgIHdpbnN0b24uZm9ybWF0LmVycm9ycyh7IHN0YWNrOiB0cnVlIH0pLFxyXG4gICAgICB3aW5zdG9uLmZvcm1hdC5tZXRhZGF0YSh7XHJcbiAgICAgICAgZmlsbEV4Y2VwdDogWydtZXNzYWdlJywgJ2xldmVsJywgJ3RpbWVzdGFtcCcsICdsYWJlbCddLFxyXG4gICAgICB9KSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldENvbnNvbGVGb3JtYXQoKTogd2luc3Rvbi5Mb2dmb3JtLkZvcm1hdCB7XHJcbiAgICBjb25zdCBmb3JtYXRzID0gW3RoaXMuZ2V0QmFzZUZvcm1hdCgpXTtcclxuXHJcbiAgICBpZiAodGhpcy5jb25maWcuY29uc29sZS5jb2xvcml6ZSkge1xyXG4gICAgICBmb3JtYXRzLnB1c2god2luc3Rvbi5mb3JtYXQuY29sb3JpemUoeyBhbGw6IHRydWUgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmNvbmZpZy5mb3JtYXQgPT09ICdqc29uJykge1xyXG4gICAgICBmb3JtYXRzLnB1c2god2luc3Rvbi5mb3JtYXQuanNvbigpKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGZvcm1hdHMucHVzaChcclxuICAgICAgICB3aW5zdG9uLmZvcm1hdC5wcmludGYoKHsgdGltZXN0YW1wLCBsZXZlbCwgbWVzc2FnZSwgbWV0YWRhdGEsIHN0YWNrIH0pID0+IHtcclxuICAgICAgICAgIGxldCBsb2cgPSBgJHt0aW1lc3RhbXB9IFske2xldmVsfV0gJHttZXNzYWdlfWA7XHJcbiAgICAgICAgICBcclxuICAgICAgICAgIGlmIChtZXRhZGF0YSAmJiBPYmplY3Qua2V5cyhtZXRhZGF0YSkubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBsb2cgKz0gYCAke0pTT04uc3RyaW5naWZ5KG1ldGFkYXRhKX1gO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgXHJcbiAgICAgICAgICBpZiAoc3RhY2spIHtcclxuICAgICAgICAgICAgbG9nICs9IGBcXG4ke3N0YWNrfWA7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBcclxuICAgICAgICAgIHJldHVybiBsb2c7XHJcbiAgICAgICAgfSksXHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHdpbnN0b24uZm9ybWF0LmNvbWJpbmUoLi4uZm9ybWF0cyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEZpbGVGb3JtYXQoKTogd2luc3Rvbi5Mb2dmb3JtLkZvcm1hdCB7XHJcbiAgICByZXR1cm4gd2luc3Rvbi5mb3JtYXQuY29tYmluZShcclxuICAgICAgdGhpcy5nZXRCYXNlRm9ybWF0KCksXHJcbiAgICAgIHdpbnN0b24uZm9ybWF0Lmpzb24oKSxcclxuICAgICk7XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==