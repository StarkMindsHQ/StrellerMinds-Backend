c9afb473cee4582d5e011d34b7bd4362
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const common_1 = require("@nestjs/common");
const global_exception_filter_1 = require("./global-exception.filter");
const nestjs_i18n_1 = require("nestjs-i18n");
const error_codes_enum_1 = require("../errors/error-codes.enum");
const custom_exception_1 = require("../errors/custom.exception");
describe('GlobalExceptionsFilter', () => {
    let filter;
    let mockI18nService;
    beforeEach(async () => {
        mockI18nService = {
            translate: jest.fn().mockImplementation((key) => Promise.resolve(`translated-${key}`)),
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                global_exception_filter_1.GlobalExceptionsFilter,
                {
                    provide: nestjs_i18n_1.I18nService,
                    useValue: mockI18nService,
                },
            ],
        }).compile();
        filter = module.get(global_exception_filter_1.GlobalExceptionsFilter);
    });
    const mockArgumentsHost = {
        switchToHttp: () => ({
            getResponse: () => ({
                status: jest.fn().mockReturnThis(),
                json: jest.fn(),
            }),
            getRequest: () => ({
                url: '/test',
                acceptsLanguages: () => 'en',
            }),
        }),
    };
    it('should handle CustomException', async () => {
        const exception = new custom_exception_1.CustomException(error_codes_enum_1.ErrorCode.NOT_FOUND, 'Resource not found', common_1.HttpStatus.NOT_FOUND);
        await filter.catch(exception, mockArgumentsHost);
        const response = mockArgumentsHost.switchToHttp().getResponse();
        expect(response.status).toHaveBeenCalledWith(common_1.HttpStatus.NOT_FOUND);
        expect(response.json).toHaveBeenCalledWith(expect.objectContaining({
            errorCode: error_codes_enum_1.ErrorCode.NOT_FOUND,
            statusCode: common_1.HttpStatus.NOT_FOUND,
            message: expect.any(String),
            timestamp: expect.any(String),
            path: '/test',
        }));
    });
    it('should handle HttpException', async () => {
        const exception = new common_1.HttpException('Test error', common_1.HttpStatus.BAD_REQUEST);
        await filter.catch(exception, mockArgumentsHost);
        const response = mockArgumentsHost.switchToHttp().getResponse();
        expect(response.status).toHaveBeenCalledWith(common_1.HttpStatus.BAD_REQUEST);
        expect(response.json).toHaveBeenCalledWith(expect.objectContaining({
            errorCode: error_codes_enum_1.ErrorCode.INTERNAL_ERROR,
            statusCode: common_1.HttpStatus.BAD_REQUEST,
            message: expect.any(String),
            timestamp: expect.any(String),
            path: '/test',
        }));
    });
    it('should handle unknown errors', async () => {
        const exception = new Error('Unknown error');
        await filter.catch(exception, mockArgumentsHost);
        const response = mockArgumentsHost.switchToHttp().getResponse();
        expect(response.status).toHaveBeenCalledWith(common_1.HttpStatus.INTERNAL_SERVER_ERROR);
        expect(response.json).toHaveBeenCalledWith(expect.objectContaining({
            errorCode: error_codes_enum_1.ErrorCode.INTERNAL_ERROR,
            statusCode: common_1.HttpStatus.INTERNAL_SERVER_ERROR,
            message: expect.any(String),
            timestamp: expect.any(String),
            path: '/test',
        }));
    });
    it('should include stack trace in development environment', async () => {
        process.env.NODE_ENV = 'development';
        const exception = new Error('Test error');
        exception.stack = 'Test stack trace';
        await filter.catch(exception, mockArgumentsHost);
        const response = mockArgumentsHost.switchToHttp().getResponse();
        expect(response.json).toHaveBeenCalledWith(expect.objectContaining({
            stack: 'Test stack trace',
        }));
    });
    it('should not include stack trace in production environment', async () => {
        process.env.NODE_ENV = 'production';
        const exception = new Error('Test error');
        exception.stack = 'Test stack trace';
        await filter.catch(exception, mockArgumentsHost);
        const response = mockArgumentsHost.switchToHttp().getResponse();
        expect(response.json).toHaveBeenCalledWith(expect.not.objectContaining({
            stack: expect.any(String),
        }));
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxjb21tb25cXGZpbHRlcnNcXGdsb2JhbC1leGNlcHRpb24uZmlsdGVyLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBc0Q7QUFDdEQsMkNBQTBFO0FBQzFFLHVFQUFtRTtBQUNuRSw2Q0FBMEM7QUFDMUMsaUVBQXVEO0FBQ3ZELGlFQUE2RDtBQUU3RCxRQUFRLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxFQUFFO0lBQ3RDLElBQUksTUFBOEIsQ0FBQztJQUNuQyxJQUFJLGVBQXFDLENBQUM7SUFFMUMsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLGVBQWUsR0FBRztZQUNoQixTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLENBQUMsR0FBVyxFQUFFLEVBQUUsQ0FDdEQsT0FBTyxDQUFDLE9BQU8sQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDLENBQ3JDO1NBQ0YsQ0FBQztRQUVGLE1BQU0sTUFBTSxHQUFrQixNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUMzRCxTQUFTLEVBQUU7Z0JBQ1QsZ0RBQXNCO2dCQUN0QjtvQkFDRSxPQUFPLEVBQUUseUJBQVc7b0JBQ3BCLFFBQVEsRUFBRSxlQUFlO2lCQUMxQjthQUNGO1NBQ0YsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWIsTUFBTSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQXlCLGdEQUFzQixDQUFDLENBQUM7SUFDdEUsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLGlCQUFpQixHQUFHO1FBQ3hCLFlBQVksRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ25CLFdBQVcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dCQUNsQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGNBQWMsRUFBRTtnQkFDbEMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFD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QUM7UUFDaEUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FDeEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQztZQUMxQixLQUFLLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7U0FDMUIsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZy1la29oXFxEZXNrdG9wXFxTdHJlbGxlck1pbmRzLUJhY2tlbmRcXHNyY1xcY29tbW9uXFxmaWx0ZXJzXFxnbG9iYWwtZXhjZXB0aW9uLmZpbHRlci5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xyXG5pbXBvcnQgeyBBcmd1bWVudHNIb3N0LCBIdHRwRXhjZXB0aW9uLCBIdHRwU3RhdHVzIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xyXG5pbXBvcnQgeyBHbG9iYWxFeGNlcHRpb25zRmlsdGVyIH0gZnJvbSAnLi9nbG9iYWwtZXhjZXB0aW9uLmZpbHRlcic7XHJcbmltcG9ydCB7IEkxOG5TZXJ2aWNlIH0gZnJvbSAnbmVzdGpzLWkxOG4nO1xyXG5pbXBvcnQgeyBFcnJvckNvZGUgfSBmcm9tICcuLi9lcnJvcnMvZXJyb3ItY29kZXMuZW51bSc7XHJcbmltcG9ydCB7IEN1c3RvbUV4Y2VwdGlvbiB9IGZyb20gJy4uL2Vycm9ycy9jdXN0b20uZXhjZXB0aW9uJztcclxuXHJcbmRlc2NyaWJlKCdHbG9iYWxFeGNlcHRpb25zRmlsdGVyJywgKCkgPT4ge1xyXG4gIGxldCBmaWx0ZXI6IEdsb2JhbEV4Y2VwdGlvbnNGaWx0ZXI7XHJcbiAgbGV0IG1vY2tJMThuU2VydmljZTogUGFydGlhbDxJMThuU2VydmljZT47XHJcblxyXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xyXG4gICAgbW9ja0kxOG5TZXJ2aWNlID0ge1xyXG4gICAgICB0cmFuc2xhdGU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKGtleTogc3RyaW5nKSA9PiBcclxuICAgICAgICBQcm9taXNlLnJlc29sdmUoYHRyYW5zbGF0ZWQtJHtrZXl9YClcclxuICAgICAgKSxcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcclxuICAgICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAgR2xvYmFsRXhjZXB0aW9uc0ZpbHRlcixcclxuICAgICAgICB7XHJcbiAgICAgICAgICBwcm92aWRlOiBJMThuU2VydmljZSxcclxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrSTE4blNlcnZpY2UsXHJcbiAgICAgICAgfSxcclxuICAgICAgXSxcclxuICAgIH0pLmNvbXBpbGUoKTtcclxuXHJcbiAgICBmaWx0ZXIgPSBtb2R1bGUuZ2V0PEdsb2JhbEV4Y2VwdGlvbnNGaWx0ZXI+KEdsb2JhbEV4Y2VwdGlvbnNGaWx0ZXIpO1xyXG4gIH0pO1xyXG5cclxuICBjb25zdCBtb2NrQXJndW1lbnRzSG9zdCA9IHtcclxuICAgIHN3aXRjaFRvSHR0cDogKCkgPT4gKHtcclxuICAgICAgZ2V0UmVzcG9uc2U6ICgpID0+ICh7XHJcbiAgICAgICAgc3RhdHVzOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcclxuICAgICAgICBqc29uOiBqZXN0LmZuKCksXHJcbiAgICAgIH0pLFxyXG4gICAgICBnZXRSZXF1ZXN0OiAoKSA9PiAoe1xyXG4gICAgICAgIHVybDogJy90ZXN0JyxcclxuICAgICAgICBhY2NlcHRzTGFuZ3VhZ2VzOiAoKSA9PiAnZW4nLFxyXG4gICAgICB9KSxcclxuICAgIH0pLFxyXG4gIH0gYXMgQXJndW1lbnRzSG9zdDtcclxuXHJcbiAgaXQoJ3Nob3VsZCBoYW5kbGUgQ3VzdG9tRXhjZXB0aW9uJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEN1c3RvbUV4Y2VwdGlvbihcclxuICAgICAgRXJyb3JDb2RlLk5PVF9GT1VORCxcclxuICAgICAgJ1Jlc291cmNlIG5vdCBmb3VuZCcsXHJcbiAgICAgIEh0dHBTdGF0dXMuTk9UX0ZPVU5EXHJcbiAgICApO1xyXG5cclxuICAgIGF3YWl0IGZpbHRlci5jYXRjaChleGNlcHRpb24sIG1vY2tBcmd1bWVudHNIb3N0KTtcclxuXHJcbiAgICBjb25zdCByZXNwb25zZSA9IG1vY2tBcmd1bWVudHNIb3N0LnN3aXRjaFRvSHR0cCgpLmdldFJlc3BvbnNlKCk7XHJcbiAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChIdHRwU3RhdHVzLk5PVF9GT1VORCk7XHJcbiAgICBleHBlY3QocmVzcG9uc2UuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICBlcnJvckNvZGU6IEVycm9yQ29kZS5OT1RfRk9VTkQsXHJcbiAgICAgICAgc3RhdHVzQ29kZTogSHR0cFN0YXR1cy5OT1RfRk9VTkQsXHJcbiAgICAgICAgbWVzc2FnZTogZXhwZWN0LmFueShTdHJpbmcpLFxyXG4gICAgICAgIHRpbWVzdGFtcDogZXhwZWN0LmFueShTdHJpbmcpLFxyXG4gICAgICAgIHBhdGg6ICcvdGVzdCcsXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIGhhbmRsZSBIdHRwRXhjZXB0aW9uJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEh0dHBFeGNlcHRpb24oJ1Rlc3QgZXJyb3InLCBIdHRwU3RhdHVzLkJBRF9SRVFVRVNUKTtcclxuXHJcbiAgICBhd2FpdCBmaWx0ZXIuY2F0Y2goZXhjZXB0aW9uLCBtb2NrQXJndW1lbnRzSG9zdCk7XHJcblxyXG4gICAgY29uc3QgcmVzcG9uc2UgPSBtb2NrQXJndW1lbnRzSG9zdC5zd2l0Y2hUb0h0dHAoKS5nZXRSZXNwb25zZSgpO1xyXG4gICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoSHR0cFN0YXR1cy5CQURfUkVRVUVTVCk7XHJcbiAgICBleHBlY3QocmVzcG9uc2UuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICBlcnJvckNvZGU6IEVycm9yQ29kZS5JTlRFUk5BTF9FUlJPUixcclxuICAgICAgICBzdGF0dXNDb2RlOiBIdHRwU3RhdHVzLkJBRF9SRVFVRVNULFxyXG4gICAgICAgIG1lc3NhZ2U6IGV4cGVjdC5hbnkoU3RyaW5nKSxcclxuICAgICAgICB0aW1lc3RhbXA6IGV4cGVjdC5hbnkoU3RyaW5nKSxcclxuICAgICAgICBwYXRoOiAnL3Rlc3QnLFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9KTtcclxuXHJcbiAgaXQoJ3Nob3VsZCBoYW5kbGUgdW5rbm93biBlcnJvcnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICBjb25zdCBleGNlcHRpb24gPSBuZXcgRXJyb3IoJ1Vua25vd24gZXJyb3InKTtcclxuXHJcbiAgICBhd2FpdCBmaWx0ZXIuY2F0Y2goZXhjZXB0aW9uLCBtb2NrQXJndW1lbnRzSG9zdCk7XHJcblxyXG4gICAgY29uc3QgcmVzcG9uc2UgPSBtb2NrQXJndW1lbnRzSG9zdC5zd2l0Y2hUb0h0dHAoKS5nZXRSZXNwb25zZSgpO1xyXG4gICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IpO1xyXG4gICAgZXhwZWN0KHJlc3BvbnNlLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgZXJyb3JDb2RlOiBFcnJvckNvZGUuSU5URVJOQUxfRVJST1IsXHJcbiAgICAgICAgc3RhdHVzQ29kZTogSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXHJcbiAgICAgICAgbWVzc2FnZTogZXhwZWN0LmFueShTdHJpbmcpLFxyXG4gICAgICAgIHRpbWVzdGFtcDogZXhwZWN0LmFueShTdHJpbmcpLFxyXG4gICAgICAgIHBhdGg6ICcvdGVzdCcsXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH0pO1xyXG5cclxuICBpdCgnc2hvdWxkIGluY2x1ZGUgc3RhY2sgdHJhY2UgaW4gZGV2ZWxvcG1lbnQgZW52aXJvbm1lbnQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9ICdkZXZlbG9wbWVudCc7XHJcbiAgICBjb25zdCBleGNlcHRpb24gPSBuZXcgRXJyb3IoJ1Rlc3QgZXJyb3InKTtcclxuICAgIGV4Y2VwdGlvbi5zdGFjayA9ICdUZXN0IHN0YWNrIHRyYWNlJztcclxuXHJcbiAgICBhd2FpdCBmaWx0ZXIuY2F0Y2goZXhjZXB0aW9uLCBtb2NrQXJndW1lbnRzSG9zdCk7XHJcblxyXG4gICAgY29uc3QgcmVzcG9uc2UgPSBtb2NrQXJndW1lbnRzSG9zdC5zd2l0Y2hUb0h0dHAoKS5nZXRSZXNwb25zZSgpO1xyXG4gICAgZXhwZWN0KHJlc3BvbnNlLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgc3RhY2s6ICdUZXN0IHN0YWNrIHRyYWNlJyxcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KCdzaG91bGQgbm90IGluY2x1ZGUgc3RhY2sgdHJhY2UgaW4gcHJvZHVjdGlvbiBlbnZpcm9ubWVudCcsIGFzeW5jICgpID0+IHtcclxuICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Byb2R1Y3Rpb24nO1xyXG4gICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEVycm9yKCdUZXN0IGVycm9yJyk7XHJcbiAgICBleGNlcHRpb24uc3RhY2sgPSAnVGVzdCBzdGFjayB0cmFjZSc7XHJcblxyXG4gICAgYXdhaXQgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgbW9ja0FyZ3VtZW50c0hvc3QpO1xyXG5cclxuICAgIGNvbnN0IHJlc3BvbnNlID0gbW9ja0FyZ3VtZW50c0hvc3Quc3dpdGNoVG9IdHRwKCkuZ2V0UmVzcG9uc2UoKTtcclxuICAgIGV4cGVjdChyZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgZXhwZWN0Lm5vdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICBzdGFjazogZXhwZWN0LmFueShTdHJpbmcpLFxyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9KTtcclxufSk7Il0sInZlcnNpb24iOjN9