9dd96b18f72c1cb5214055526b332f42
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var PushNotificationService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PushNotificationService = void 0;
const common_1 = require("@nestjs/common");
const webpush = __importStar(require("web-push"));
let PushNotificationService = PushNotificationService_1 = class PushNotificationService {
    constructor(subscriptionRepository, templateRepository, notificationQueue) {
        this.logger = new common_1.Logger(PushNotificationService_1.name);
        this.subscriptionRepository = subscriptionRepository;
        this.templateRepository = templateRepository;
        this.notificationQueue = notificationQueue;
        this.initializeWebPush();
    }
    initializeWebPush() {
        const vapidKeys = {
            publicKey: process.env.VAPID_PUBLIC_KEY,
            privateKey: process.env.VAPID_PRIVATE_KEY,
        };
        if (!vapidKeys.publicKey || !vapidKeys.privateKey) {
            this.logger.warn("VAPID keys not configured. Push notifications will not work.");
            return;
        }
        webpush.setVapidDetails(process.env.VAPID_SUBJECT || "mailto:admin@example.com", vapidKeys.publicKey, vapidKeys.privateKey);
    }
    async createSubscription(dto) {
        try {
            // Check if subscription already exists
            const existing = await this.subscriptionRepository.findOne({
                where: { endpoint: dto.subscription.endpoint },
            });
            if (existing) {
                // Update existing subscription
                existing.userId = dto.userId || existing.userId;
                existing.p256dhKey = dto.subscription.keys.p256dh;
                existing.authKey = dto.subscription.keys.auth;
                existing.userAgent = dto.userAgent || existing.userAgent;
                existing.deviceType = dto.deviceType || existing.deviceType;
                existing.preferences = dto.preferences || existing.preferences;
                existing.metadata = dto.metadata || existing.metadata;
                existing.isActive = true;
                existing.failureCount = 0;
                return await this.subscriptionRepository.save(existing);
            }
            // Create new subscription
            const subscription = this.subscriptionRepository.create({
                userId: dto.userId,
                endpoint: dto.subscription.endpoint,
                p256dhKey: dto.subscription.keys.p256dh,
                authKey: dto.subscription.keys.auth,
                userAgent: dto.userAgent,
                deviceType: dto.deviceType,
                preferences: dto.preferences,
                metadata: dto.metadata,
                isActive: true,
            });
            const saved = await this.subscriptionRepository.save(subscription);
            this.logger.log(`Created push subscription: ${saved.id}`);
            return saved;
        }
        catch (error) {
            this.logger.error(`Failed to create subscription: ${error.message}`, error.stack);
            throw error;
        }
    }
    async updateSubscription(id, updates) {
        const subscription = await this.subscriptionRepository.findOne({ where: { id } });
        if (!subscription) {
            throw new Error("Subscription not found");
        }
        Object.assign(subscription, updates);
        return await this.subscriptionRepository.save(subscription);
    }
    async deleteSubscription(id) {
        await this.subscriptionRepository.update(id, { isActive: false });
        this.logger.log(`Deactivated push subscription: ${id}`);
    }
    async sendNotification(dto) {
        try {
            let subscriptions = [];
            if (dto.subscriptionIds?.length) {
                subscriptions = await this.subscriptionRepository.find({
                    where: {
                        id: { $in: dto.subscriptionIds },
                        isActive: true,
                    },
                });
            }
            else if (dto.userIds?.length) {
                subscriptions = await this.subscriptionRepository.find({
                    where: {
                        userId: { $in: dto.userIds },
                        isActive: true,
                    },
                });
            }
            else {
                // Send to all active subscriptions (be careful with this!)
                subscriptions = await this.subscriptionRepository.find({
                    where: { isActive: true },
                    take: 1000, // Limit to prevent overwhelming
                });
            }
            if (subscriptions.length === 0) {
                return { queued: 0, errors: ["No active subscriptions found"] };
            }
            // Get notification template if specified
            let template = null;
            if (dto.templateType) {
                template = await this.templateRepository.findOne({
                    where: { type: dto.templateType, isActive: true },
                });
            }
            // Prepare notification options
            let notificationOptions;
            if (template) {
                notificationOptions = template.render(dto.variables || {});
            }
            else {
                notificationOptions = {
                    title: dto.title || "Notification",
                    body: dto.body || "",
                    ...dto.options,
                };
            }
            // Queue notifications
            const jobs = subscriptions.map((subscription) => ({
                name: "send-push-notification",
                data: {
                    subscriptionId: subscription.id,
                    subscription: subscription.getSubscriptionData(),
                    notification: notificationOptions,
                },
                opts: {
                    delay: dto.scheduleAt ? dto.scheduleAt.getTime() - Date.now() : 0,
                    attempts: 3,
                    backoff: {
                        type: "exponential",
                        delay: 2000,
                    },
                },
            }));
            await this.notificationQueue.addBulk(jobs);
            this.logger.log(`Queued ${jobs.length} push notifications`);
            return { queued: jobs.length, errors: [] };
        }
        catch (error) {
            this.logger.error(`Failed to send notifications: ${error.message}`, error.stack);
            return { queued: 0, errors: [error.message] };
        }
    }
    async sendToSubscription(subscription, notification) {
        try {
            const payload = JSON.stringify(notification);
            await webpush.sendNotification(subscription, payload);
            return true;
        }
        catch (error) {
            this.logger.error(`Failed to send push notification: ${error.message}`);
            return false;
        }
    }
    async getSubscriptions(filters) {
        const query = this.subscriptionRepository.createQueryBuilder("subscription");
        if (filters.userId) {
            query.andWhere("subscription.userId = :userId", { userId: filters.userId });
        }
        if (filters.isActive !== undefined) {
            query.andWhere("subscription.isActive = :isActive", { isActive: filters.isActive });
        }
        if (filters.deviceType) {
            query.andWhere("subscription.deviceType = :deviceType", { deviceType: filters.deviceType });
        }
        query.orderBy("subscription.createdAt", "DESC");
        if (filters.limit) {
            query.limit(filters.limit);
        }
        if (filters.offset) {
            query.offset(filters.offset);
        }
        const [subscriptions, total] = await query.getManyAndCount();
        return { subscriptions, total };
    }
    async getSubscriptionStats() {
        const [total, active] = await Promise.all([
            this.subscriptionRepository.count(),
            this.subscriptionRepository.count({ where: { isActive: true } }),
        ]);
        const deviceTypeStats = await this.subscriptionRepository
            .createQueryBuilder("subscription")
            .select("subscription.deviceType", "deviceType")
            .addSelect("COUNT(*)", "count")
            .where("subscription.isActive = :isActive", { isActive: true })
            .groupBy("subscription.deviceType")
            .getRawMany();
        const userAgentStats = await this.subscriptionRepository
            .createQueryBuilder("subscription")
            .select("subscription.userAgent", "userAgent")
            .addSelect("COUNT(*)", "count")
            .where("subscription.isActive = :isActive", { isActive: true })
            .groupBy("subscription.userAgent")
            .getRawMany();
        const byDeviceType = deviceTypeStats.reduce((acc, stat) => {
            acc[stat.deviceType || "unknown"] = Number.parseInt(stat.count);
            return acc;
        }, {});
        const byUserAgent = userAgentStats.reduce((acc, stat) => {
            acc[stat.userAgent || "unknown"] = Number.parseInt(stat.count);
            return acc;
        }, {});
        return {
            total,
            active,
            byDeviceType,
            byUserAgent,
        };
    }
};
exports.PushNotificationService = PushNotificationService;
exports.PushNotificationService = PushNotificationService = PushNotificationService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [Object, Object, Object])
], PushNotificationService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxwd2FcXHNlcnZpY2VzXFxwdXNoLW5vdGlmaWNhdGlvbi5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBbUQ7QUFHbkQsa0RBQW1DO0FBMEI1QixJQUFNLHVCQUF1QiwrQkFBN0IsTUFBTSx1QkFBdUI7SUFPbEMsWUFDRSxzQkFBb0QsRUFDcEQsa0JBQW9ELEVBQ3BELGlCQUF3QjtRQVRULFdBQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyx5QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQVdoRSxJQUFJLENBQUMsc0JBQXNCLEdBQUcsc0JBQXNCLENBQUE7UUFDcEQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLGtCQUFrQixDQUFBO1FBQzVDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQTtRQUMxQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQTtJQUMxQixDQUFDO0lBRU8saUJBQWlCO1FBQ3ZCLE1BQU0sU0FBUyxHQUFHO1lBQ2hCLFNBQVMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQjtZQUN2QyxVQUFVLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUI7U0FDMUMsQ0FBQTtRQUVELElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ2xELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLDhEQUE4RCxDQUFDLENBQUE7WUFDaEYsT0FBTTtRQUNSLENBQUM7UUFFRCxPQUFPLENBQUMsZUFBZSxDQUNyQixPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsSUFBSSwwQkFBMEIsRUFDdkQsU0FBUyxDQUFDLFNBQVMsRUFDbkIsU0FBUyxDQUFDLFVBQVUsQ0FDckIsQ0FBQTtJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsa0JBQWtCLENBQUMsR0FBMEI7UUFDakQsSUFBSSxDQUFDO1lBQ0gsdUNBQXVDO1lBQ3ZDLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLHNCQUFzQixDQUFDLE9BQU8sQ0FBQztnQkFDekQsS0FBSyxFQUFFLEVBQUUsUUFBUSxFQUFFLEdBQUcsQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFO2FBQy9DLENBQUMsQ0FBQTtZQUVGLElBQUksUUFBUSxFQUFFLENBQUM7Z0JBQ2IsK0JBQStCO2dCQUMvQixRQUFRLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQTtnQkFDL0MsUUFBUSxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUE7Z0JBQ2pELFFBQVEsQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFBO2dCQUM3QyxRQUFRLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxTQUFTLElBQUksUUFBUSxDQUFDLFNBQVMsQ0FBQTtnQkFDeEQsUUFBUSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUMsVUFBVSxJQUFJLFFBQVEsQ0FBQyxVQUFVLENBQUE7Z0JBQzNELFFBQVEsQ0FBQyxXQUFXLEdBQUcsR0FBRyxDQUFDLFdBQVcsSUFBSSxRQUFRLENBQUMsV0FBVyxDQUFBO2dCQUM5RCxRQUFRLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQTtnQkFDckQsUUFBUSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUE7Z0JBQ3hCLFFBQVEsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFBO2dCQUV6QixPQUFPLE1BQU0sSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtZQUN6RCxDQUFDO1lBRUQsMEJBQTBCO1lBQzFCLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxNQUFNLENBQUM7Z0JBQ3RELE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTTtnQkFDbEIsUUFBUSxFQUFFLEdBQUcsQ0FBQyxZQUFZLENBQUMsUUFBUTtnQkFDbkMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU07Z0JBQ3ZDLE9BQU8sRUFBRSxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJO2dCQUNuQyxTQUFTLEVBQUUsR0FBRyxDQUFDLFNBQVM7Z0JBQ3hCLFVBQVUsRUFBRSxHQUFHLENBQUMsVUFBVTtnQkFDMUIsV0FBVyxFQUFFLEdBQUcsQ0FBQyxXQUFXO2dCQUM1QixRQUFRLEVBQUUsR0FBRyxDQUFDLFFBQVE7Z0JBQ3RCLFFBQVEsRUFBRSxJQUFJO2FBQ2YsQ0FBQyxDQUFBO1lBRUYsTUFBTSxLQUFLLEdBQUcsTUFBTSxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFBO1lBQ2xFLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDhCQUE4QixLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtZQUV6RCxPQUFPLEtBQUssQ0FBQTtRQUNkLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsa0NBQWtDLEtBQUssQ0FBQyxPQUFPLEVBQUUsRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUE7WUFDakYsTUFBTSxLQUFLLENBQUE7UUFDYixDQUFDO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxrQkFBa0IsQ0FDdEIsRUFBVSxFQUNWLE9BQWlGO1FBRWpGLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUNqRixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFBO1FBQzNDLENBQUM7UUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUNwQyxPQUFPLE1BQU0sSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQTtJQUM3RCxDQUFDO0lBRUQsS0FBSyxDQUFDLGtCQUFrQixDQUFDLEVBQVU7UUFDakMsTUFBTSxJQUFJLENBQUMsc0JBQXNCLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFBO1FBQ2pFLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGtDQUFrQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBQ3pELENBQUM7SUFFRCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsR0FBd0I7UUFDN0MsSUFBSSxDQUFDO1lBQ0gsSUFBSSxhQUFhLEdBQXVCLEVBQUUsQ0FBQTtZQUUxQyxJQUFJLEdBQUcsQ0FBQyxlQUFlLEVBQUUsTUFBTSxFQUFFLENBQUM7Z0JBQ2hDLGFBQWEsR0FBRyxNQUFNLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUM7b0JBQ3JELEtBQUssRUFBRTt3QkFDTCxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLGVBQWUsRUFBUzt3QkFDdkMsUUFBUSxFQUFFLElBQUk7cUJBQ2Y7aUJBQ0YsQ0FBQyxDQUFBO1lBQ0osQ0FBQztpQkFBTSxJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUM7Z0JBQy9CLGFBQWEsR0FBRyxNQUFNLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUM7b0JBQ3JELEtBQUssRUFBRTt3QkFDTCxNQUFNLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLE9BQU8sRUFBUzt3QkFDbkMsUUFBUSxFQUFFLElBQUk7cUJBQ2Y7aUJBQ0YsQ0FBQyxDQUFBO1lBQ0osQ0FBQztpQkFBTSxDQUFDO2dCQUNOLDJEQUEyRDtnQkFDM0QsYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQztvQkFDckQsS0FBSyxFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRTtvQkFDekIsSUFBSSxFQUFFLElBQUksRUFBRSxnQ0FBZ0M7aUJBQzdDLENBQUMsQ0FBQTtZQUNKLENBQUM7WUFFRCxJQUFJLGFBQWEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQy9CLE9BQU8sRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLCtCQUErQixDQUFDLEVBQUUsQ0FBQTtZQUNqRSxDQUFDO1lBRUQseUNBQXlDO1lBQ3pDLElBQUksUUFBUSxHQUFnQyxJQUFJLENBQUE7WUFDaEQsSUFBSSxHQUFHLENBQUMsWUFBWSxFQUFFLENBQUM7Z0JBQ3JCLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUM7b0JBQy9DLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsWUFBWSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUU7aUJBQ2xELENBQUMsQ0FBQTtZQUNKLENBQUM7WUFFRCwrQkFBK0I7WUFDL0IsSUFBSSxtQkFBd0MsQ0FBQTtZQUU1QyxJQUFJLFFBQVEsRUFBRSxDQUFDO2dCQUNiLG1CQUFtQixHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsSUFBSSxFQUFFLENBQUMsQ0FBQTtZQUM1RCxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sbUJBQW1CLEdBQUc7b0JBQ3BCLEtBQUssRUFBRSxHQUFHLENBQUMsS0FBSyxJQUFJLGNBQWM7b0JBQ2xDLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxJQUFJLEVBQUU7b0JBQ3BCLEdBQUcsR0FBRyxDQUFDLE9BQU87aUJBQ2YsQ0FBQTtZQUNILENBQUM7WUFFRCxzQkFBc0I7WUFDdEIsTUFBTSxJQUFJLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDaEQsSUFBSSxFQUFFLHdCQUF3QjtnQkFDOUIsSUFBSSxFQUFFO29CQUNKLGNBQWMsRUFBRSxZQUFZLENBQUMsRUFBRTtvQkFDL0IsWUFBWSxFQUFFLFlBQVksQ0FBQyxtQkFBbUIsRUFBRTtvQkFDaEQsWUFBWSxFQUFFLG1CQUFtQjtpQkFDbEM7Z0JBQ0QsSUFBSSxFQUFFO29CQUNKLEtBQUssRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDakUsUUFBUSxFQUFFLENBQUM7b0JBQ1gsT0FBTyxFQUFFO3dCQUNQLElBQUksRUFBRSxhQUFhO3dCQUNuQixLQUFLLEVBQUUsSUFBSTtxQkFDWjtpQkFDRjthQUNGLENBQUMsQ0FBQyxDQUFBO1lBRUgsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO1lBRTFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxDQUFDLE1BQU0scUJBQXFCLENBQUMsQ0FBQTtZQUUzRCxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxDQUFBO1FBQzVDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsaUNBQWlDLEtBQUssQ0FBQyxPQUFPLEVBQUUsRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUE7WUFDaEYsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUE7UUFDL0MsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsa0JBQWtCLENBQUMsWUFBa0MsRUFBRSxZQUFpQztRQUM1RixJQUFJLENBQUM7WUFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFBO1lBQzVDLE1BQU0sT0FBTyxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQTtZQUNyRCxPQUFPLElBQUksQ0FBQTtRQUNiLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMscUNBQXFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFBO1lBQ3ZFLE9BQU8sS0FBSyxDQUFBO1FBQ2QsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsT0FNdEI7UUFDQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDLENBQUE7UUFFNUUsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDbkIsS0FBSyxDQUFDLFFBQVEsQ0FBQywrQkFBK0IsRUFBRSxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQTtRQUM3RSxDQUFDO1FBRUQsSUFBSSxPQUFPLENBQUMsUUFBUSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ25DLEtBQUssQ0FBQyxRQUFRLENBQUMsbUNBQW1DLEVBQUUsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUE7UUFDckYsQ0FBQztRQUVELElBQUksT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3ZCLEtBQUssQ0FBQyxRQUFRLENBQUMsdUNBQXVDLEVBQUUsRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUE7UUFDN0YsQ0FBQztRQUVELEtBQUssQ0FBQyxPQUFPLENBQUMsd0JBQXdCLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFFL0MsSUFBSSxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDbEIsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDNUIsQ0FBQztRQUVELElBQUksT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ25CLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQzlCLENBQUM7UUFFRCxNQUFNLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxHQUFHLE1BQU0sS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFBO1FBRTVELE9BQU8sRUFBRSxhQUFhLEVBQUUsS0FBSyxFQUFFLENBQUE7SUFDakMsQ0FBQztJQUVELEtBQUssQ0FBQyxvQkFBb0I7UUFNeEIsTUFBTSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDeEMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLEtBQUssRUFBRTtZQUNuQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxFQUFFLENBQUM7U0FDakUsQ0FBQyxDQUFBO1FBRUYsTUFBTSxlQUFlLEdBQUcsTUFBTSxJQUFJLENBQUMsc0JBQXNCO2FBQ3RELGtCQUFrQixDQUFDLGNBQWMsQ0FBQzthQUNsQyxNQUFNLENBQUMseUJBQXlCLEVBQUUsWUFBWSxDQUFDO2FBQy9DLFNBQVMsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDO2FBQzlCLEtBQUssQ0FBQyxtQ0FBbUMsRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQzthQUM5RCxPQUFPLENBQUMseUJBQXlCLENBQUM7YUFDbEMsVUFBVSxFQUFFLENBQUE7UUFFZixNQUFNLGNBQWMsR0FBRyxNQUFNLElBQUksQ0FBQyxzQkFBc0I7YUFDckQsa0JBQWtCLENBQUMsY0FBYyxDQUFDO2FBQ2xDLE1BQU0sQ0FBQyx3QkFBd0IsRUFBRSxXQUFXLENBQUM7YUFDN0MsU0FBUyxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUM7YUFDOUIsS0FBSyxDQUFDLG1DQUFtQyxFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDO2FBQzlELE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQzthQUNqQyxVQUFVLEVBQUUsQ0FBQTtRQUVmLE1BQU0sWUFBWSxHQUFHLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7WUFDeEQsR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksU0FBUyxDQUFDLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7WUFDL0QsT0FBTyxHQUFHLENBQUE7UUFDWixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFFTixNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ3RELEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLFNBQVMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQzlELE9BQU8sR0FBRyxDQUFBO1FBQ1osQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBRU4sT0FBTztZQUNMLEtBQUs7WUFDTCxNQUFNO1lBQ04sWUFBWTtZQUNaLFdBQVc7U0FDWixDQUFBO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUE5UVksMERBQXVCO2tDQUF2Qix1QkFBdUI7SUFEbkMsSUFBQSxtQkFBVSxHQUFFOztHQUNBLHVCQUF1QixDQThRbkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxwd2FcXHNlcnZpY2VzXFxwdXNoLW5vdGlmaWNhdGlvbi5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gXCJAbmVzdGpzL2NvbW1vblwiXHJcbmltcG9ydCB0eXBlIHsgUmVwb3NpdG9yeSB9IGZyb20gXCJ0eXBlb3JtXCJcclxuaW1wb3J0IHR5cGUgeyBRdWV1ZSB9IGZyb20gXCJidWxsXCJcclxuaW1wb3J0ICogYXMgd2VicHVzaCBmcm9tIFwid2ViLXB1c2hcIlxyXG5cclxuaW1wb3J0IHR5cGUgeyBQdXNoU3Vic2NyaXB0aW9uLCBQdXNoU3Vic2NyaXB0aW9uRGF0YSB9IGZyb20gXCIuLi9lbnRpdGllcy9wdXNoLXN1YnNjcmlwdGlvbi5lbnRpdHlcIlxyXG5pbXBvcnQgdHlwZSB7IE5vdGlmaWNhdGlvblRlbXBsYXRlLCBOb3RpZmljYXRpb25PcHRpb25zIH0gZnJvbSBcIi4uL2VudGl0aWVzL25vdGlmaWNhdGlvbi10ZW1wbGF0ZS5lbnRpdHlcIlxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDcmVhdGVTdWJzY3JpcHRpb25EdG8ge1xyXG4gIHVzZXJJZD86IHN0cmluZ1xyXG4gIHN1YnNjcmlwdGlvbjogUHVzaFN1YnNjcmlwdGlvbkRhdGFcclxuICB1c2VyQWdlbnQ/OiBzdHJpbmdcclxuICBkZXZpY2VUeXBlPzogc3RyaW5nXHJcbiAgcHJlZmVyZW5jZXM/OiBhbnlcclxuICBtZXRhZGF0YT86IGFueVxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFNlbmROb3RpZmljYXRpb25EdG8ge1xyXG4gIHN1YnNjcmlwdGlvbklkcz86IHN0cmluZ1tdXHJcbiAgdXNlcklkcz86IHN0cmluZ1tdXHJcbiAgdGVtcGxhdGVUeXBlPzogc3RyaW5nXHJcbiAgdGl0bGU/OiBzdHJpbmdcclxuICBib2R5Pzogc3RyaW5nXHJcbiAgb3B0aW9ucz86IFBhcnRpYWw8Tm90aWZpY2F0aW9uT3B0aW9ucz5cclxuICB2YXJpYWJsZXM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+XHJcbiAgc2NoZWR1bGVBdD86IERhdGVcclxufVxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgUHVzaE5vdGlmaWNhdGlvblNlcnZpY2Uge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihQdXNoTm90aWZpY2F0aW9uU2VydmljZS5uYW1lKVxyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IHN1YnNjcmlwdGlvblJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8UHVzaFN1YnNjcmlwdGlvbj5cclxuICBwcml2YXRlIHJlYWRvbmx5IHRlbXBsYXRlUmVwb3NpdG9yeTogUmVwb3NpdG9yeTxOb3RpZmljYXRpb25UZW1wbGF0ZT5cclxuICBwcml2YXRlIHJlYWRvbmx5IG5vdGlmaWNhdGlvblF1ZXVlOiBRdWV1ZVxyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHN1YnNjcmlwdGlvblJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8UHVzaFN1YnNjcmlwdGlvbj4sXHJcbiAgICB0ZW1wbGF0ZVJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8Tm90aWZpY2F0aW9uVGVtcGxhdGU+LFxyXG4gICAgbm90aWZpY2F0aW9uUXVldWU6IFF1ZXVlLFxyXG4gICkge1xyXG4gICAgdGhpcy5zdWJzY3JpcHRpb25SZXBvc2l0b3J5ID0gc3Vic2NyaXB0aW9uUmVwb3NpdG9yeVxyXG4gICAgdGhpcy50ZW1wbGF0ZVJlcG9zaXRvcnkgPSB0ZW1wbGF0ZVJlcG9zaXRvcnlcclxuICAgIHRoaXMubm90aWZpY2F0aW9uUXVldWUgPSBub3RpZmljYXRpb25RdWV1ZVxyXG4gICAgdGhpcy5pbml0aWFsaXplV2ViUHVzaCgpXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRpYWxpemVXZWJQdXNoKCkge1xyXG4gICAgY29uc3QgdmFwaWRLZXlzID0ge1xyXG4gICAgICBwdWJsaWNLZXk6IHByb2Nlc3MuZW52LlZBUElEX1BVQkxJQ19LRVksXHJcbiAgICAgIHByaXZhdGVLZXk6IHByb2Nlc3MuZW52LlZBUElEX1BSSVZBVEVfS0VZLFxyXG4gICAgfVxyXG5cclxuICAgIGlmICghdmFwaWRLZXlzLnB1YmxpY0tleSB8fCAhdmFwaWRLZXlzLnByaXZhdGVLZXkpIHtcclxuICAgICAgdGhpcy5sb2dnZXIud2FybihcIlZBUElEIGtleXMgbm90IGNvbmZpZ3VyZWQuIFB1c2ggbm90aWZpY2F0aW9ucyB3aWxsIG5vdCB3b3JrLlwiKVxyXG4gICAgICByZXR1cm5cclxuICAgIH1cclxuXHJcbiAgICB3ZWJwdXNoLnNldFZhcGlkRGV0YWlscyhcclxuICAgICAgcHJvY2Vzcy5lbnYuVkFQSURfU1VCSkVDVCB8fCBcIm1haWx0bzphZG1pbkBleGFtcGxlLmNvbVwiLFxyXG4gICAgICB2YXBpZEtleXMucHVibGljS2V5LFxyXG4gICAgICB2YXBpZEtleXMucHJpdmF0ZUtleSxcclxuICAgIClcclxuICB9XHJcblxyXG4gIGFzeW5jIGNyZWF0ZVN1YnNjcmlwdGlvbihkdG86IENyZWF0ZVN1YnNjcmlwdGlvbkR0byk6IFByb21pc2U8UHVzaFN1YnNjcmlwdGlvbj4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgLy8gQ2hlY2sgaWYgc3Vic2NyaXB0aW9uIGFscmVhZHkgZXhpc3RzXHJcbiAgICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgdGhpcy5zdWJzY3JpcHRpb25SZXBvc2l0b3J5LmZpbmRPbmUoe1xyXG4gICAgICAgIHdoZXJlOiB7IGVuZHBvaW50OiBkdG8uc3Vic2NyaXB0aW9uLmVuZHBvaW50IH0sXHJcbiAgICAgIH0pXHJcblxyXG4gICAgICBpZiAoZXhpc3RpbmcpIHtcclxuICAgICAgICAvLyBVcGRhdGUgZXhpc3Rpbmcgc3Vic2NyaXB0aW9uXHJcbiAgICAgICAgZXhpc3RpbmcudXNlcklkID0gZHRvLnVzZXJJZCB8fCBleGlzdGluZy51c2VySWRcclxuICAgICAgICBleGlzdGluZy5wMjU2ZGhLZXkgPSBkdG8uc3Vic2NyaXB0aW9uLmtleXMucDI1NmRoXHJcbiAgICAgICAgZXhpc3RpbmcuYXV0aEtleSA9IGR0by5zdWJzY3JpcHRpb24ua2V5cy5hdXRoXHJcbiAgICAgICAgZXhpc3RpbmcudXNlckFnZW50ID0gZHRvLnVzZXJBZ2VudCB8fCBleGlzdGluZy51c2VyQWdlbnRcclxuICAgICAgICBleGlzdGluZy5kZXZpY2VUeXBlID0gZHRvLmRldmljZVR5cGUgfHwgZXhpc3RpbmcuZGV2aWNlVHlwZVxyXG4gICAgICAgIGV4aXN0aW5nLnByZWZlcmVuY2VzID0gZHRvLnByZWZlcmVuY2VzIHx8IGV4aXN0aW5nLnByZWZlcmVuY2VzXHJcbiAgICAgICAgZXhpc3RpbmcubWV0YWRhdGEgPSBkdG8ubWV0YWRhdGEgfHwgZXhpc3RpbmcubWV0YWRhdGFcclxuICAgICAgICBleGlzdGluZy5pc0FjdGl2ZSA9IHRydWVcclxuICAgICAgICBleGlzdGluZy5mYWlsdXJlQ291bnQgPSAwXHJcblxyXG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnN1YnNjcmlwdGlvblJlcG9zaXRvcnkuc2F2ZShleGlzdGluZylcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gQ3JlYXRlIG5ldyBzdWJzY3JpcHRpb25cclxuICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy5zdWJzY3JpcHRpb25SZXBvc2l0b3J5LmNyZWF0ZSh7XHJcbiAgICAgICAgdXNlcklkOiBkdG8udXNlcklkLFxyXG4gICAgICAgIGVuZHBvaW50OiBkdG8uc3Vic2NyaXB0aW9uLmVuZHBvaW50LFxyXG4gICAgICAgIHAyNTZkaEtleTogZHRvLnN1YnNjcmlwdGlvbi5rZXlzLnAyNTZkaCxcclxuICAgICAgICBhdXRoS2V5OiBkdG8uc3Vic2NyaXB0aW9uLmtleXMuYXV0aCxcclxuICAgICAgICB1c2VyQWdlbnQ6IGR0by51c2VyQWdlbnQsXHJcbiAgICAgICAgZGV2aWNlVHlwZTogZHRvLmRldmljZVR5cGUsXHJcbiAgICAgICAgcHJlZmVyZW5jZXM6IGR0by5wcmVmZXJlbmNlcyxcclxuICAgICAgICBtZXRhZGF0YTogZHRvLm1ldGFkYXRhLFxyXG4gICAgICAgIGlzQWN0aXZlOiB0cnVlLFxyXG4gICAgICB9KVxyXG5cclxuICAgICAgY29uc3Qgc2F2ZWQgPSBhd2FpdCB0aGlzLnN1YnNjcmlwdGlvblJlcG9zaXRvcnkuc2F2ZShzdWJzY3JpcHRpb24pXHJcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgQ3JlYXRlZCBwdXNoIHN1YnNjcmlwdGlvbjogJHtzYXZlZC5pZH1gKVxyXG5cclxuICAgICAgcmV0dXJuIHNhdmVkXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIGNyZWF0ZSBzdWJzY3JpcHRpb246ICR7ZXJyb3IubWVzc2FnZX1gLCBlcnJvci5zdGFjaylcclxuICAgICAgdGhyb3cgZXJyb3JcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIHVwZGF0ZVN1YnNjcmlwdGlvbihcclxuICAgIGlkOiBzdHJpbmcsXHJcbiAgICB1cGRhdGVzOiBQYXJ0aWFsPFBpY2s8UHVzaFN1YnNjcmlwdGlvbiwgXCJwcmVmZXJlbmNlc1wiIHwgXCJpc0FjdGl2ZVwiIHwgXCJtZXRhZGF0YVwiPj4sXHJcbiAgKTogUHJvbWlzZTxQdXNoU3Vic2NyaXB0aW9uPiB7XHJcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBhd2FpdCB0aGlzLnN1YnNjcmlwdGlvblJlcG9zaXRvcnkuZmluZE9uZSh7IHdoZXJlOiB7IGlkIH0gfSlcclxuICAgIGlmICghc3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlN1YnNjcmlwdGlvbiBub3QgZm91bmRcIilcclxuICAgIH1cclxuXHJcbiAgICBPYmplY3QuYXNzaWduKHN1YnNjcmlwdGlvbiwgdXBkYXRlcylcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLnN1YnNjcmlwdGlvblJlcG9zaXRvcnkuc2F2ZShzdWJzY3JpcHRpb24pXHJcbiAgfVxyXG5cclxuICBhc3luYyBkZWxldGVTdWJzY3JpcHRpb24oaWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgdGhpcy5zdWJzY3JpcHRpb25SZXBvc2l0b3J5LnVwZGF0ZShpZCwgeyBpc0FjdGl2ZTogZmFsc2UgfSlcclxuICAgIHRoaXMubG9nZ2VyLmxvZyhgRGVhY3RpdmF0ZWQgcHVzaCBzdWJzY3JpcHRpb246ICR7aWR9YClcclxuICB9XHJcblxyXG4gIGFzeW5jIHNlbmROb3RpZmljYXRpb24oZHRvOiBTZW5kTm90aWZpY2F0aW9uRHRvKTogUHJvbWlzZTx7IHF1ZXVlZDogbnVtYmVyOyBlcnJvcnM6IHN0cmluZ1tdIH0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGxldCBzdWJzY3JpcHRpb25zOiBQdXNoU3Vic2NyaXB0aW9uW10gPSBbXVxyXG5cclxuICAgICAgaWYgKGR0by5zdWJzY3JpcHRpb25JZHM/Lmxlbmd0aCkge1xyXG4gICAgICAgIHN1YnNjcmlwdGlvbnMgPSBhd2FpdCB0aGlzLnN1YnNjcmlwdGlvblJlcG9zaXRvcnkuZmluZCh7XHJcbiAgICAgICAgICB3aGVyZToge1xyXG4gICAgICAgICAgICBpZDogeyAkaW46IGR0by5zdWJzY3JpcHRpb25JZHMgfSBhcyBhbnksXHJcbiAgICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9KVxyXG4gICAgICB9IGVsc2UgaWYgKGR0by51c2VySWRzPy5sZW5ndGgpIHtcclxuICAgICAgICBzdWJzY3JpcHRpb25zID0gYXdhaXQgdGhpcy5zdWJzY3JpcHRpb25SZXBvc2l0b3J5LmZpbmQoe1xyXG4gICAgICAgICAgd2hlcmU6IHtcclxuICAgICAgICAgICAgdXNlcklkOiB7ICRpbjogZHRvLnVzZXJJZHMgfSBhcyBhbnksXHJcbiAgICAgICAgICAgIGlzQWN0aXZlOiB0cnVlLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9KVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIFNlbmQgdG8gYWxsIGFjdGl2ZSBzdWJzY3JpcHRpb25zIChiZSBjYXJlZnVsIHdpdGggdGhpcyEpXHJcbiAgICAgICAgc3Vic2NyaXB0aW9ucyA9IGF3YWl0IHRoaXMuc3Vic2NyaXB0aW9uUmVwb3NpdG9yeS5maW5kKHtcclxuICAgICAgICAgIHdoZXJlOiB7IGlzQWN0aXZlOiB0cnVlIH0sXHJcbiAgICAgICAgICB0YWtlOiAxMDAwLCAvLyBMaW1pdCB0byBwcmV2ZW50IG92ZXJ3aGVsbWluZ1xyXG4gICAgICAgIH0pXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChzdWJzY3JpcHRpb25zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHJldHVybiB7IHF1ZXVlZDogMCwgZXJyb3JzOiBbXCJObyBhY3RpdmUgc3Vic2NyaXB0aW9ucyBmb3VuZFwiXSB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIEdldCBub3RpZmljYXRpb24gdGVtcGxhdGUgaWYgc3BlY2lmaWVkXHJcbiAgICAgIGxldCB0ZW1wbGF0ZTogTm90aWZpY2F0aW9uVGVtcGxhdGUgfCBudWxsID0gbnVsbFxyXG4gICAgICBpZiAoZHRvLnRlbXBsYXRlVHlwZSkge1xyXG4gICAgICAgIHRlbXBsYXRlID0gYXdhaXQgdGhpcy50ZW1wbGF0ZVJlcG9zaXRvcnkuZmluZE9uZSh7XHJcbiAgICAgICAgICB3aGVyZTogeyB0eXBlOiBkdG8udGVtcGxhdGVUeXBlLCBpc0FjdGl2ZTogdHJ1ZSB9LFxyXG4gICAgICAgIH0pXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFByZXBhcmUgbm90aWZpY2F0aW9uIG9wdGlvbnNcclxuICAgICAgbGV0IG5vdGlmaWNhdGlvbk9wdGlvbnM6IE5vdGlmaWNhdGlvbk9wdGlvbnNcclxuXHJcbiAgICAgIGlmICh0ZW1wbGF0ZSkge1xyXG4gICAgICAgIG5vdGlmaWNhdGlvbk9wdGlvbnMgPSB0ZW1wbGF0ZS5yZW5kZXIoZHRvLnZhcmlhYmxlcyB8fCB7fSlcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBub3RpZmljYXRpb25PcHRpb25zID0ge1xyXG4gICAgICAgICAgdGl0bGU6IGR0by50aXRsZSB8fCBcIk5vdGlmaWNhdGlvblwiLFxyXG4gICAgICAgICAgYm9keTogZHRvLmJvZHkgfHwgXCJcIixcclxuICAgICAgICAgIC4uLmR0by5vcHRpb25zLFxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gUXVldWUgbm90aWZpY2F0aW9uc1xyXG4gICAgICBjb25zdCBqb2JzID0gc3Vic2NyaXB0aW9ucy5tYXAoKHN1YnNjcmlwdGlvbikgPT4gKHtcclxuICAgICAgICBuYW1lOiBcInNlbmQtcHVzaC1ub3RpZmljYXRpb25cIixcclxuICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICBzdWJzY3JpcHRpb25JZDogc3Vic2NyaXB0aW9uLmlkLFxyXG4gICAgICAgICAgc3Vic2NyaXB0aW9uOiBzdWJzY3JpcHRpb24uZ2V0U3Vic2NyaXB0aW9uRGF0YSgpLFxyXG4gICAgICAgICAgbm90aWZpY2F0aW9uOiBub3RpZmljYXRpb25PcHRpb25zLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb3B0czoge1xyXG4gICAgICAgICAgZGVsYXk6IGR0by5zY2hlZHVsZUF0ID8gZHRvLnNjaGVkdWxlQXQuZ2V0VGltZSgpIC0gRGF0ZS5ub3coKSA6IDAsXHJcbiAgICAgICAgICBhdHRlbXB0czogMyxcclxuICAgICAgICAgIGJhY2tvZmY6IHtcclxuICAgICAgICAgICAgdHlwZTogXCJleHBvbmVudGlhbFwiLFxyXG4gICAgICAgICAgICBkZWxheTogMjAwMCxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgfSkpXHJcblxyXG4gICAgICBhd2FpdCB0aGlzLm5vdGlmaWNhdGlvblF1ZXVlLmFkZEJ1bGsoam9icylcclxuXHJcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgUXVldWVkICR7am9icy5sZW5ndGh9IHB1c2ggbm90aWZpY2F0aW9uc2ApXHJcblxyXG4gICAgICByZXR1cm4geyBxdWV1ZWQ6IGpvYnMubGVuZ3RoLCBlcnJvcnM6IFtdIH1cclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gc2VuZCBub3RpZmljYXRpb25zOiAke2Vycm9yLm1lc3NhZ2V9YCwgZXJyb3Iuc3RhY2spXHJcbiAgICAgIHJldHVybiB7IHF1ZXVlZDogMCwgZXJyb3JzOiBbZXJyb3IubWVzc2FnZV0gfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgc2VuZFRvU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbjogUHVzaFN1YnNjcmlwdGlvbkRhdGEsIG5vdGlmaWNhdGlvbjogTm90aWZpY2F0aW9uT3B0aW9ucyk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcGF5bG9hZCA9IEpTT04uc3RyaW5naWZ5KG5vdGlmaWNhdGlvbilcclxuICAgICAgYXdhaXQgd2VicHVzaC5zZW5kTm90aWZpY2F0aW9uKHN1YnNjcmlwdGlvbiwgcGF5bG9hZClcclxuICAgICAgcmV0dXJuIHRydWVcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gc2VuZCBwdXNoIG5vdGlmaWNhdGlvbjogJHtlcnJvci5tZXNzYWdlfWApXHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0U3Vic2NyaXB0aW9ucyhmaWx0ZXJzOiB7XHJcbiAgICB1c2VySWQ/OiBzdHJpbmdcclxuICAgIGlzQWN0aXZlPzogYm9vbGVhblxyXG4gICAgZGV2aWNlVHlwZT86IHN0cmluZ1xyXG4gICAgbGltaXQ/OiBudW1iZXJcclxuICAgIG9mZnNldD86IG51bWJlclxyXG4gIH0pOiBQcm9taXNlPHsgc3Vic2NyaXB0aW9uczogUHVzaFN1YnNjcmlwdGlvbltdOyB0b3RhbDogbnVtYmVyIH0+IHtcclxuICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5zdWJzY3JpcHRpb25SZXBvc2l0b3J5LmNyZWF0ZVF1ZXJ5QnVpbGRlcihcInN1YnNjcmlwdGlvblwiKVxyXG5cclxuICAgIGlmIChmaWx0ZXJzLnVzZXJJZCkge1xyXG4gICAgICBxdWVyeS5hbmRXaGVyZShcInN1YnNjcmlwdGlvbi51c2VySWQgPSA6dXNlcklkXCIsIHsgdXNlcklkOiBmaWx0ZXJzLnVzZXJJZCB9KVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChmaWx0ZXJzLmlzQWN0aXZlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgcXVlcnkuYW5kV2hlcmUoXCJzdWJzY3JpcHRpb24uaXNBY3RpdmUgPSA6aXNBY3RpdmVcIiwgeyBpc0FjdGl2ZTogZmlsdGVycy5pc0FjdGl2ZSB9KVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChmaWx0ZXJzLmRldmljZVR5cGUpIHtcclxuICAgICAgcXVlcnkuYW5kV2hlcmUoXCJzdWJzY3JpcHRpb24uZGV2aWNlVHlwZSA9IDpkZXZpY2VUeXBlXCIsIHsgZGV2aWNlVHlwZTogZmlsdGVycy5kZXZpY2VUeXBlIH0pXHJcbiAgICB9XHJcblxyXG4gICAgcXVlcnkub3JkZXJCeShcInN1YnNjcmlwdGlvbi5jcmVhdGVkQXRcIiwgXCJERVNDXCIpXHJcblxyXG4gICAgaWYgKGZpbHRlcnMubGltaXQpIHtcclxuICAgICAgcXVlcnkubGltaXQoZmlsdGVycy5saW1pdClcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZmlsdGVycy5vZmZzZXQpIHtcclxuICAgICAgcXVlcnkub2Zmc2V0KGZpbHRlcnMub2Zmc2V0KVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IFtzdWJzY3JpcHRpb25zLCB0b3RhbF0gPSBhd2FpdCBxdWVyeS5nZXRNYW55QW5kQ291bnQoKVxyXG5cclxuICAgIHJldHVybiB7IHN1YnNjcmlwdGlvbnMsIHRvdGFsIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFN1YnNjcmlwdGlvblN0YXRzKCk6IFByb21pc2U8e1xyXG4gICAgdG90YWw6IG51bWJlclxyXG4gICAgYWN0aXZlOiBudW1iZXJcclxuICAgIGJ5RGV2aWNlVHlwZTogUmVjb3JkPHN0cmluZywgbnVtYmVyPlxyXG4gICAgYnlVc2VyQWdlbnQ6IFJlY29yZDxzdHJpbmcsIG51bWJlcj5cclxuICB9PiB7XHJcbiAgICBjb25zdCBbdG90YWwsIGFjdGl2ZV0gPSBhd2FpdCBQcm9taXNlLmFsbChbXHJcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uUmVwb3NpdG9yeS5jb3VudCgpLFxyXG4gICAgICB0aGlzLnN1YnNjcmlwdGlvblJlcG9zaXRvcnkuY291bnQoeyB3aGVyZTogeyBpc0FjdGl2ZTogdHJ1ZSB9IH0pLFxyXG4gICAgXSlcclxuXHJcbiAgICBjb25zdCBkZXZpY2VUeXBlU3RhdHMgPSBhd2FpdCB0aGlzLnN1YnNjcmlwdGlvblJlcG9zaXRvcnlcclxuICAgICAgLmNyZWF0ZVF1ZXJ5QnVpbGRlcihcInN1YnNjcmlwdGlvblwiKVxyXG4gICAgICAuc2VsZWN0KFwic3Vic2NyaXB0aW9uLmRldmljZVR5cGVcIiwgXCJkZXZpY2VUeXBlXCIpXHJcbiAgICAgIC5hZGRTZWxlY3QoXCJDT1VOVCgqKVwiLCBcImNvdW50XCIpXHJcbiAgICAgIC53aGVyZShcInN1YnNjcmlwdGlvbi5pc0FjdGl2ZSA9IDppc0FjdGl2ZVwiLCB7IGlzQWN0aXZlOiB0cnVlIH0pXHJcbiAgICAgIC5ncm91cEJ5KFwic3Vic2NyaXB0aW9uLmRldmljZVR5cGVcIilcclxuICAgICAgLmdldFJhd01hbnkoKVxyXG5cclxuICAgIGNvbnN0IHVzZXJBZ2VudFN0YXRzID0gYXdhaXQgdGhpcy5zdWJzY3JpcHRpb25SZXBvc2l0b3J5XHJcbiAgICAgIC5jcmVhdGVRdWVyeUJ1aWxkZXIoXCJzdWJzY3JpcHRpb25cIilcclxuICAgICAgLnNlbGVjdChcInN1YnNjcmlwdGlvbi51c2VyQWdlbnRcIiwgXCJ1c2VyQWdlbnRcIilcclxuICAgICAgLmFkZFNlbGVjdChcIkNPVU5UKCopXCIsIFwiY291bnRcIilcclxuICAgICAgLndoZXJlKFwic3Vic2NyaXB0aW9uLmlzQWN0aXZlID0gOmlzQWN0aXZlXCIsIHsgaXNBY3RpdmU6IHRydWUgfSlcclxuICAgICAgLmdyb3VwQnkoXCJzdWJzY3JpcHRpb24udXNlckFnZW50XCIpXHJcbiAgICAgIC5nZXRSYXdNYW55KClcclxuXHJcbiAgICBjb25zdCBieURldmljZVR5cGUgPSBkZXZpY2VUeXBlU3RhdHMucmVkdWNlKChhY2MsIHN0YXQpID0+IHtcclxuICAgICAgYWNjW3N0YXQuZGV2aWNlVHlwZSB8fCBcInVua25vd25cIl0gPSBOdW1iZXIucGFyc2VJbnQoc3RhdC5jb3VudClcclxuICAgICAgcmV0dXJuIGFjY1xyXG4gICAgfSwge30pXHJcblxyXG4gICAgY29uc3QgYnlVc2VyQWdlbnQgPSB1c2VyQWdlbnRTdGF0cy5yZWR1Y2UoKGFjYywgc3RhdCkgPT4ge1xyXG4gICAgICBhY2Nbc3RhdC51c2VyQWdlbnQgfHwgXCJ1bmtub3duXCJdID0gTnVtYmVyLnBhcnNlSW50KHN0YXQuY291bnQpXHJcbiAgICAgIHJldHVybiBhY2NcclxuICAgIH0sIHt9KVxyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIHRvdGFsLFxyXG4gICAgICBhY3RpdmUsXHJcbiAgICAgIGJ5RGV2aWNlVHlwZSxcclxuICAgICAgYnlVc2VyQWdlbnQsXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==