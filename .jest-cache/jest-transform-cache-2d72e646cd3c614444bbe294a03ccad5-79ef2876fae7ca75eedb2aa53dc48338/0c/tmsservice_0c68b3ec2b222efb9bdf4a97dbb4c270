17bed53b91a4bd26b77782125b06b80f
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var TmsService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TmsService = void 0;
const common_1 = require("@nestjs/common");
let TmsService = TmsService_1 = class TmsService {
    constructor(configService) {
        this.configService = configService;
        this.logger = new common_1.Logger(TmsService_1.name);
        this.apiUrl = this.configService.get("TMS_API_URL", "");
        this.apiKey = this.configService.get("TMS_API_KEY", "");
        this.projectId = this.configService.get("TMS_PROJECT_ID", "");
    }
    async getTranslations(locale, namespace) {
        if (!this.isConfigured()) {
            this.logger.warn("TMS not configured, returning empty translations");
            return [];
        }
        try {
            const url = new URL(`${this.apiUrl}/projects/${this.projectId}/translations`);
            url.searchParams.set("locale", locale);
            if (namespace) {
                url.searchParams.set("namespace", namespace);
            }
            const response = await fetch(url.toString(), {
                headers: {
                    Authorization: `Bearer ${this.apiKey}`,
                    "Content-Type": "application/json",
                },
            });
            if (!response.ok) {
                throw new Error(`TMS API error: ${response.status} ${response.statusText}`);
            }
            const data = await response.json();
            return this.mapTmsResponse(data);
        }
        catch (error) {
            this.logger.error(`Failed to fetch translations from TMS:`, error);
            throw error;
        }
    }
    async uploadTranslations(translations) {
        if (!this.isConfigured()) {
            this.logger.warn("TMS not configured, skipping upload");
            return;
        }
        try {
            const response = await fetch(`${this.apiUrl}/projects/${this.projectId}/translations`, {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${this.apiKey}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    translations: translations.map(this.mapToTmsFormat),
                }),
            });
            if (!response.ok) {
                throw new Error(`TMS API error: ${response.status} ${response.statusText}`);
            }
            this.logger.log(`Uploaded ${translations.length} translations to TMS`);
        }
        catch (error) {
            this.logger.error(`Failed to upload translations to TMS:`, error);
            throw error;
        }
    }
    async getProject() {
        if (!this.isConfigured()) {
            return null;
        }
        try {
            const response = await fetch(`${this.apiUrl}/projects/${this.projectId}`, {
                headers: {
                    Authorization: `Bearer ${this.apiKey}`,
                    "Content-Type": "application/json",
                },
            });
            if (!response.ok) {
                throw new Error(`TMS API error: ${response.status} ${response.statusText}`);
            }
            return response.json();
        }
        catch (error) {
            this.logger.error(`Failed to fetch project from TMS:`, error);
            return null;
        }
    }
    async requestTranslation(key, sourceLocale, targetLocales, context) {
        if (!this.isConfigured()) {
            this.logger.warn("TMS not configured, skipping translation request");
            return;
        }
        try {
            const response = await fetch(`${this.apiUrl}/projects/${this.projectId}/translation-requests`, {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${this.apiKey}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    key,
                    sourceLocale,
                    targetLocales,
                    context,
                }),
            });
            if (!response.ok) {
                throw new Error(`TMS API error: ${response.status} ${response.statusText}`);
            }
            this.logger.log(`Requested translation for key: ${key}`);
        }
        catch (error) {
            this.logger.error(`Failed to request translation from TMS:`, error);
            throw error;
        }
    }
    async getTranslationStatus(key, locale) {
        if (!this.isConfigured()) {
            return null;
        }
        try {
            const response = await fetch(`${this.apiUrl}/projects/${this.projectId}/translations/${key}/status?locale=${locale}`, {
                headers: {
                    Authorization: `Bearer ${this.apiKey}`,
                    "Content-Type": "application/json",
                },
            });
            if (!response.ok) {
                return null;
            }
            const data = await response.json();
            return data.status;
        }
        catch (error) {
            this.logger.error(`Failed to get translation status from TMS:`, error);
            return null;
        }
    }
    isConfigured() {
        return !!(this.apiUrl && this.apiKey && this.projectId);
    }
    mapTmsResponse(data) {
        // Map TMS-specific response format to our internal format
        if (!data.translations || !Array.isArray(data.translations)) {
            return [];
        }
        return data.translations.map((item) => ({
            key: item.key || item.identifier,
            locale: item.locale || item.language,
            namespace: item.namespace || item.file || "common",
            value: item.value || item.translation,
            description: item.description || item.comment,
            context: item.context,
            metadata: {
                tmsId: item.id,
                lastModified: item.updatedAt,
                status: item.status,
            },
        }));
    }
    mapToTmsFormat(translation) {
        // Map our internal format to TMS-specific format
        return {
            key: translation.key,
            locale: translation.locale,
            namespace: translation.namespace,
            value: translation.value,
            description: translation.description,
            context: translation.context,
        };
    }
};
exports.TmsService = TmsService;
exports.TmsService = TmsService = TmsService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [Object])
], TmsService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxpMThuXFxzZXJ2aWNlc1xcdG1zLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUFtRDtBQXNCNUMsSUFBTSxVQUFVLGtCQUFoQixNQUFNLFVBQVU7SUFNckIsWUFBNkIsYUFBNEI7UUFBNUIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFMeEMsV0FBTSxHQUFHLElBQUksZUFBTSxDQUFDLFlBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQU1uRCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFTLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUMvRCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFTLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUMvRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFTLGdCQUFnQixFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBQ3ZFLENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZSxDQUFDLE1BQWMsRUFBRSxTQUFrQjtRQUN0RCxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUM7WUFDekIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0RBQWtELENBQUMsQ0FBQTtZQUNwRSxPQUFPLEVBQUUsQ0FBQTtRQUNYLENBQUM7UUFFRCxJQUFJLENBQUM7WUFDSCxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLGFBQWEsSUFBSSxDQUFDLFNBQVMsZUFBZSxDQUFDLENBQUE7WUFDN0UsR0FBRyxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFBO1lBQ3RDLElBQUksU0FBUyxFQUFFLENBQUM7Z0JBQ2QsR0FBRyxD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QUFPLEVBQUUsV0FBVyxDQUFDLE9BQU87U0FDN0IsQ0FBQTtJQUNILENBQUM7Q0FDRixDQUFBO0FBdE1ZLGdDQUFVO3FCQUFWLFVBQVU7SUFEdEIsSUFBQSxtQkFBVSxHQUFFOztHQUNBLFVBQVUsQ0FzTXRCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcZy1la29oXFxEZXNrdG9wXFxTdHJlbGxlck1pbmRzLUJhY2tlbmRcXHNyY1xcaTE4blxcc2VydmljZXNcXHRtcy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIExvZ2dlciB9IGZyb20gXCJAbmVzdGpzL2NvbW1vblwiXHJcbmltcG9ydCB0eXBlIHsgQ29uZmlnU2VydmljZSB9IGZyb20gXCJAbmVzdGpzL2NvbmZpZ1wiXHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFRtc1RyYW5zbGF0aW9uIHtcclxuICBrZXk6IHN0cmluZ1xyXG4gIGxvY2FsZTogc3RyaW5nXHJcbiAgbmFtZXNwYWNlOiBzdHJpbmdcclxuICB2YWx1ZTogc3RyaW5nXHJcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmdcclxuICBjb250ZXh0Pzogc3RyaW5nXHJcbiAgbWV0YWRhdGE/OiBhbnlcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBUbXNQcm9qZWN0IHtcclxuICBpZDogc3RyaW5nXHJcbiAgbmFtZTogc3RyaW5nXHJcbiAgc291cmNlTG9jYWxlOiBzdHJpbmdcclxuICB0YXJnZXRMb2NhbGVzOiBzdHJpbmdbXVxyXG4gIHN0YXR1czogc3RyaW5nXHJcbn1cclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFRtc1NlcnZpY2Uge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihUbXNTZXJ2aWNlLm5hbWUpXHJcbiAgcHJpdmF0ZSByZWFkb25seSBhcGlVcmw6IHN0cmluZ1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgYXBpS2V5OiBzdHJpbmdcclxuICBwcml2YXRlIHJlYWRvbmx5IHByb2plY3RJZDogc3RyaW5nXHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSkge1xyXG4gICAgdGhpcy5hcGlVcmwgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oXCJUTVNfQVBJX1VSTFwiLCBcIlwiKVxyXG4gICAgdGhpcy5hcGlLZXkgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oXCJUTVNfQVBJX0tFWVwiLCBcIlwiKVxyXG4gICAgdGhpcy5wcm9qZWN0SWQgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oXCJUTVNfUFJPSkVDVF9JRFwiLCBcIlwiKVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0VHJhbnNsYXRpb25zKGxvY2FsZTogc3RyaW5nLCBuYW1lc3BhY2U/OiBzdHJpbmcpOiBQcm9taXNlPFRtc1RyYW5zbGF0aW9uW10+IHtcclxuICAgIGlmICghdGhpcy5pc0NvbmZpZ3VyZWQoKSkge1xyXG4gICAgICB0aGlzLmxvZ2dlci53YXJuKFwiVE1TIG5vdCBjb25maWd1cmVkLCByZXR1cm5pbmcgZW1wdHkgdHJhbnNsYXRpb25zXCIpXHJcbiAgICAgIHJldHVybiBbXVxyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoYCR7dGhpcy5hcGlVcmx9L3Byb2plY3RzLyR7dGhpcy5wcm9qZWN0SWR9L3RyYW5zbGF0aW9uc2ApXHJcbiAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KFwibG9jYWxlXCIsIGxvY2FsZSlcclxuICAgICAgaWYgKG5hbWVzcGFjZSkge1xyXG4gICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KFwibmFtZXNwYWNlXCIsIG5hbWVzcGFjZSlcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwudG9TdHJpbmcoKSwge1xyXG4gICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLmFwaUtleX1gLFxyXG4gICAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXHJcbiAgICAgICAgfSxcclxuICAgICAgfSlcclxuXHJcbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRNUyBBUEkgZXJyb3I6ICR7cmVzcG9uc2Uuc3RhdHVzfSAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YClcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKVxyXG4gICAgICByZXR1cm4gdGhpcy5tYXBUbXNSZXNwb25zZShkYXRhKVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBmZXRjaCB0cmFuc2xhdGlvbnMgZnJvbSBUTVM6YCwgZXJyb3IpXHJcbiAgICAgIHRocm93IGVycm9yXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyB1cGxvYWRUcmFuc2xhdGlvbnModHJhbnNsYXRpb25zOiBUbXNUcmFuc2xhdGlvbltdKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBpZiAoIXRoaXMuaXNDb25maWd1cmVkKCkpIHtcclxuICAgICAgdGhpcy5sb2dnZXIud2FybihcIlRNUyBub3QgY29uZmlndXJlZCwgc2tpcHBpbmcgdXBsb2FkXCIpXHJcbiAgICAgIHJldHVyblxyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7dGhpcy5hcGlVcmx9L3Byb2plY3RzLyR7dGhpcy5wcm9qZWN0SWR9L3RyYW5zbGF0aW9uc2AsIHtcclxuICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxyXG4gICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLmFwaUtleX1gLFxyXG4gICAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXHJcbiAgICAgICAgfSxcclxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICB0cmFuc2xhdGlvbnM6IHRyYW5zbGF0aW9ucy5tYXAodGhpcy5tYXBUb1Rtc0Zvcm1hdCksXHJcbiAgICAgICAgfSksXHJcbiAgICAgIH0pXHJcblxyXG4gICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUTVMgQVBJIGVycm9yOiAke3Jlc3BvbnNlLnN0YXR1c30gJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhgVXBsb2FkZWQgJHt0cmFuc2xhdGlvbnMubGVuZ3RofSB0cmFuc2xhdGlvbnMgdG8gVE1TYClcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gdXBsb2FkIHRyYW5zbGF0aW9ucyB0byBUTVM6YCwgZXJyb3IpXHJcbiAgICAgIHRocm93IGVycm9yXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRQcm9qZWN0KCk6IFByb21pc2U8VG1zUHJvamVjdCB8IG51bGw+IHtcclxuICAgIGlmICghdGhpcy5pc0NvbmZpZ3VyZWQoKSkge1xyXG4gICAgICByZXR1cm4gbnVsbFxyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7dGhpcy5hcGlVcmx9L3Byb2plY3RzLyR7dGhpcy5wcm9qZWN0SWR9YCwge1xyXG4gICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLmFwaUtleX1gLFxyXG4gICAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXHJcbiAgICAgICAgfSxcclxuICAgICAgfSlcclxuXHJcbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRNUyBBUEkgZXJyb3I6ICR7cmVzcG9uc2Uuc3RhdHVzfSAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YClcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBmZXRjaCBwcm9qZWN0IGZyb20gVE1TOmAsIGVycm9yKVxyXG4gICAgICByZXR1cm4gbnVsbFxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgcmVxdWVzdFRyYW5zbGF0aW9uKFxyXG4gICAga2V5OiBzdHJpbmcsXHJcbiAgICBzb3VyY2VMb2NhbGU6IHN0cmluZyxcclxuICAgIHRhcmdldExvY2FsZXM6IHN0cmluZ1tdLFxyXG4gICAgY29udGV4dD86IHN0cmluZyxcclxuICApOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGlmICghdGhpcy5pc0NvbmZpZ3VyZWQoKSkge1xyXG4gICAgICB0aGlzLmxvZ2dlci53YXJuKFwiVE1TIG5vdCBjb25maWd1cmVkLCBza2lwcGluZyB0cmFuc2xhdGlvbiByZXF1ZXN0XCIpXHJcbiAgICAgIHJldHVyblxyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7dGhpcy5hcGlVcmx9L3Byb2plY3RzLyR7dGhpcy5wcm9qZWN0SWR9L3RyYW5zbGF0aW9uLXJlcXVlc3RzYCwge1xyXG4gICAgICAgIG1ldGhvZDogXCJQT1NUXCIsXHJcbiAgICAgICAgaGVhZGVyczoge1xyXG4gICAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuYXBpS2V5fWAsXHJcbiAgICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcclxuICAgICAgICB9LFxyXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcclxuICAgICAgICAgIGtleSxcclxuICAgICAgICAgIHNvdXJjZUxvY2FsZSxcclxuICAgICAgICAgIHRhcmdldExvY2FsZXMsXHJcbiAgICAgICAgICBjb250ZXh0LFxyXG4gICAgICAgIH0pLFxyXG4gICAgICB9KVxyXG5cclxuICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVE1TIEFQSSBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXN9ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKVxyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmxvZ2dlci5sb2coYFJlcXVlc3RlZCB0cmFuc2xhdGlvbiBmb3Iga2V5OiAke2tleX1gKVxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byByZXF1ZXN0IHRyYW5zbGF0aW9uIGZyb20gVE1TOmAsIGVycm9yKVxyXG4gICAgICB0aHJvdyBlcnJvclxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0VHJhbnNsYXRpb25TdGF0dXMoa2V5OiBzdHJpbmcsIGxvY2FsZTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XHJcbiAgICBpZiAoIXRoaXMuaXNDb25maWd1cmVkKCkpIHtcclxuICAgICAgcmV0dXJuIG51bGxcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKFxyXG4gICAgICAgIGAke3RoaXMuYXBpVXJsfS9wcm9qZWN0cy8ke3RoaXMucHJvamVjdElkfS90cmFuc2xhdGlvbnMvJHtrZXl9L3N0YXR1cz9sb2NhbGU9JHtsb2NhbGV9YCxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLmFwaUtleX1gLFxyXG4gICAgICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgKVxyXG5cclxuICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xyXG4gICAgICAgIHJldHVybiBudWxsXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKClcclxuICAgICAgcmV0dXJuIGRhdGEuc3RhdHVzXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRmFpbGVkIHRvIGdldCB0cmFuc2xhdGlvbiBzdGF0dXMgZnJvbSBUTVM6YCwgZXJyb3IpXHJcbiAgICAgIHJldHVybiBudWxsXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzQ29uZmlndXJlZCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAhISh0aGlzLmFwaVVybCAmJiB0aGlzLmFwaUtleSAmJiB0aGlzLnByb2plY3RJZClcclxuICB9XHJcblxyXG4gIHByaXZhdGUgbWFwVG1zUmVzcG9uc2UoZGF0YTogYW55KTogVG1zVHJhbnNsYXRpb25bXSB7XHJcbiAgICAvLyBNYXAgVE1TLXNwZWNpZmljIHJlc3BvbnNlIGZvcm1hdCB0byBvdXIgaW50ZXJuYWwgZm9ybWF0XHJcbiAgICBpZiAoIWRhdGEudHJhbnNsYXRpb25zIHx8ICFBcnJheS5pc0FycmF5KGRhdGEudHJhbnNsYXRpb25zKSkge1xyXG4gICAgICByZXR1cm4gW11cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZGF0YS50cmFuc2xhdGlvbnMubWFwKChpdGVtOiBhbnkpID0+ICh7XHJcbiAgICAgIGtleTogaXRlbS5rZXkgfHwgaXRlbS5pZGVudGlmaWVyLFxyXG4gICAgICBsb2NhbGU6IGl0ZW0ubG9jYWxlIHx8IGl0ZW0ubGFuZ3VhZ2UsXHJcbiAgICAgIG5hbWVzcGFjZTogaXRlbS5uYW1lc3BhY2UgfHwgaXRlbS5maWxlIHx8IFwiY29tbW9uXCIsXHJcbiAgICAgIHZhbHVlOiBpdGVtLnZhbHVlIHx8IGl0ZW0udHJhbnNsYXRpb24sXHJcbiAgICAgIGRlc2NyaXB0aW9uOiBpdGVtLmRlc2NyaXB0aW9uIHx8IGl0ZW0uY29tbWVudCxcclxuICAgICAgY29udGV4dDogaXRlbS5jb250ZXh0LFxyXG4gICAgICBtZXRhZGF0YToge1xyXG4gICAgICAgIHRtc0lkOiBpdGVtLmlkLFxyXG4gICAgICAgIGxhc3RNb2RpZmllZDogaXRlbS51cGRhdGVkQXQsXHJcbiAgICAgICAgc3RhdHVzOiBpdGVtLnN0YXR1cyxcclxuICAgICAgfSxcclxuICAgIH0pKVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBtYXBUb1Rtc0Zvcm1hdCh0cmFuc2xhdGlvbjogVG1zVHJhbnNsYXRpb24pOiBhbnkge1xyXG4gICAgLy8gTWFwIG91ciBpbnRlcm5hbCBmb3JtYXQgdG8gVE1TLXNwZWNpZmljIGZvcm1hdFxyXG4gICAgcmV0dXJuIHtcclxuICAgICAga2V5OiB0cmFuc2xhdGlvbi5rZXksXHJcbiAgICAgIGxvY2FsZTogdHJhbnNsYXRpb24ubG9jYWxlLFxyXG4gICAgICBuYW1lc3BhY2U6IHRyYW5zbGF0aW9uLm5hbWVzcGFjZSxcclxuICAgICAgdmFsdWU6IHRyYW5zbGF0aW9uLnZhbHVlLFxyXG4gICAgICBkZXNjcmlwdGlvbjogdHJhbnNsYXRpb24uZGVzY3JpcHRpb24sXHJcbiAgICAgIGNvbnRleHQ6IHRyYW5zbGF0aW9uLmNvbnRleHQsXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==