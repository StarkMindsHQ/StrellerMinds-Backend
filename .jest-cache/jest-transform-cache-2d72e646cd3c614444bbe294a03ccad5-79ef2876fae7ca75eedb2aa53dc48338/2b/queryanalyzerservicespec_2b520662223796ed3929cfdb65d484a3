33d381a596a912727e526d6a8e827972
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const typeorm_1 = require("@nestjs/typeorm");
const query_analyzer_service_1 = require("../services/query-analyzer.service");
const optimization_config_interface_1 = require("../interfaces/optimization-config.interface");
// Mock jest if not available globally
const mockFn = () => {
    const fn = (...args) => fn;
    fn.mockResolvedValue = (value) => {
        fn._mockResolvedValue = value;
        return fn;
    };
    fn.mockRejectedValue = (value) => {
        fn._mockRejectedValue = value;
        return fn;
    };
    fn.mockImplementationOnce = (impl) => {
        fn._mockImplementationOnce = impl;
        return fn;
    };
    fn.mockClear = () => {
        delete fn._mockResolvedValue;
        delete fn._mockRejectedValue;
        return fn;
    };
    return fn;
};
const jest = {
    fn: mockFn,
    clearAllMocks: () => { },
};
describe("QueryAnalyzerService", () => {
    let service;
    let dataSource;
    const mockExecutionPlan = {
        nodeType: "Seq Scan",
        totalCost: 1500.0,
        startupCost: 0.0,
        planRows: 1000,
        planWidth: 100,
        actualRows: 950,
        actualLoops: 1,
        actualTotalTime: 25.5,
        children: [],
    };
    const mockDataSource = {
        query: jest.fn(),
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                query_analyzer_service_1.QueryAnalyzerService,
                {
                    provide: (0, typeorm_1.getDataSourceToken)(),
                    useValue: mockDataSource,
                },
                {
                    provide: optimization_config_interface_1.DatabaseOptimizationConfig,
                    useValue: optimization_config_interface_1.DEFAULT_OPTIMIZATION_CONFIG,
                },
            ],
        }).compile();
        service = module.get(query_analyzer_service_1.QueryAnalyzerService);
        dataSource = module.get((0, typeorm_1.getDataSourceToken)());
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    describe("analyzeQuery", () => {
        it("should analyze a query and return optimization suggestions", async () => {
            const testQuery = "SELECT * FROM users WHERE age > 25";
            dataSource.query.mockResolvedValue([{ "QUERY PLAN": [mockExecutionPlan] }]);
            const result = await service.analyzeQuery(testQuery);
            expect(result).toBeDefined();
            expect(result.query).toBe(testQuery);
            expect(result.executionPlan).toEqual(mockExecutionPlan);
            expect(result.suggestions).toBeInstanceOf(Array);
            expect(result.indexRecommendations).toBeInstanceOf(Array);
            expect(typeof result.performanceScore).toBe("number");
            expect(result.performanceScore).toBeGreaterThanOrEqual(0);
            expect(result.performanceScore).toBeLessThanOrEqual(100);
        });
        it("should detect sequential scan and suggest index creation", async () => {
            const testQuery = "SELECT * FROM large_table WHERE column1 = 123";
            dataSource.query.mockResolvedValue([{ "QUERY PLAN": [mockExecutionPlan] }]);
            const result = await service.analyzeQuery(testQuery);
            const indexSuggestion = result.suggestions.find((s) => s.type === "INDEX");
            expect(indexSuggestion).toBeDefined();
            expect(indexSuggestion?.priority).toBe("HIGH");
            expect(indexSuggestion?.description).toContain("Sequential scan detected");
        });
        it("should detect SELECT * usage and suggest optimization", async () => {
            const testQuery = "SELECT * FROM users";
            dataSource.query.mockResolvedValue([{ "QUERY PLAN": [{ ...mockExecutionPlan, nodeType: "Index Scan" }] }]);
            const result = await service.analyzeQuery(testQuery);
            const selectStarSuggestion = result.suggestions.find((s) => s.description.includes("SELECT * usage detected"));
            expect(selectStarSuggestion).toBeDefined();
            expect(selectStarSuggestion?.priority).toBe("LOW");
        });
        it("should detect missing WHERE clause", async () => {
            const testQuery = "SELECT name, email FROM users";
            dataSource.query.mockResolvedValue([{ "QUERY PLAN": [mockExecutionPlan] }]);
            const result = await service.analyzeQuery(testQuery);
            const whereClauseSuggestion = result.suggestions.find((s) => s.description.includes("Query without WHERE clause"));
            expect(whereClauseSuggestion).toBeDefined();
            expect(whereClauseSuggestion?.priority).toBe("CRITICAL");
        });
        it("should handle query analysis errors gracefully", async () => {
            const testQuery = "INVALID SQL QUERY";
            dataSource.query.mockRejectedValue(new Error("SQL syntax error"));
            await expect(service.analyzeQuery(testQuery)).rejects.toThrow("SQL syntax error");
        });
    });
    describe("query history management", () => {
        it("should track query performance metrics", async () => {
            const testQuery = "SELECT id FROM users WHERE active = true";
            dataSource.query.mockResolvedValue([{ "QUERY PLAN": [{ ...mockExecutionPlan, nodeType: "Index Scan" }] }]);
            // Execute the same query multiple times
            await service.analyzeQuery(testQuery);
            await service.analyzeQuery(testQuery);
            await service.analyzeQuery(testQuery);
            const history = service.getQueryHistory();
            expect(history.length).toBe(1);
            const queryMetrics = history[0];
            expect(queryMetrics.totalExecutions).toBe(3);
            expect(queryMetrics.query).toBe(testQuery);
            expect(queryMetrics.avgExecutionTime).toBeGreaterThan(0);
        });
        it("should identify slow queries correctly", async () => {
            const fastQuery = "SELECT id FROM users LIMIT 1";
            const slowQuery = "SELECT * FROM large_table";
            // Mock fast execution
            dataSource.query.mockResolvedValue([{ "QUERY PLAN": [{ ...mockExecutionPlan, totalCost: 10 }] }]);
            await service.analyzeQuery(fastQuery);
            // Mock slow execution by delaying
            dataSource.query.mockImplementationOnce(() => new Promise((resolve) => setTimeout(() => resolve([{ "QUERY PLAN": [mockExecutionPlan] }]), 1100)));
            await service.analyzeQuery(slowQuery);
            const slowQueries = service.getSlowQueries(1000);
            expect(slowQueries.length).toBe(1);
            expect(slowQueries[0].query).toBe(slowQuery);
        });
        it("should clear query history", async () => {
            const testQuery = "SELECT * FROM test_table";
            dataSource.query.mockResolvedValue([{ "QUERY PLAN": [mockExecutionPlan] }]);
            await service.analyzeQuery(testQuery);
            expect(service.getQueryHistory().length).toBe(1);
            service.clearQueryHistory();
            expect(service.getQueryHistory().length).toBe(0);
        });
    });
    describe("performance scoring", () => {
        it("should calculate performance score based on execution time and cost", async () => {
            const efficientQuery = "SELECT id FROM users WHERE id = 1";
            dataSource.query.mockResolvedValue([
                { "QUERY PLAN": [{ ...mockExecutionPlan, totalCost: 10, nodeType: "Index Scan" }] },
            ]);
            const result = await service.analyzeQuery(efficientQuery);
            expect(result.performanceScore).toBeGreaterThan(80);
        });
        it("should penalize queries with sequential scans", async () => {
            const inefficientQuery = "SELECT * FROM large_table WHERE column = value";
            dataSource.query.mockResolvedValue([
                { "QUERY PLAN": [mockExecutionPlan] }, // Sequential scan with high cost
            ]);
            const result = await service.analyzeQuery(inefficientQuery);
            expect(result.performanceScore).toBeLessThan(80);
        });
    });
    describe("index recommendations", () => {
        it("should recommend indexes for sequential scans", async () => {
            const testQuery = "SELECT * FROM products WHERE category_id = 5";
            dataSource.query.mockResolvedValue([{ "QUERY PLAN": [mockExecutionPlan] }]);
            const result = await service.analyzeQuery(testQuery);
            expect(result.indexRecommendations.length).toBeGreaterThan(0);
            const recommendation = result.indexRecommendations[0];
            expect(recommendation.indexType).toBe("BTREE");
            expect(recommendation.estimatedImprovement).toBeGreaterThan(0);
            expect(recommendation.reason).toContain("Sequential scan detected");
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxkYXRhYmFzZS1vcHRpbWl6YXRpb25cXF9fdGVzdHNfX1xccXVlcnktYW5hbHl6ZXIuc2VydmljZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQTBEO0FBQzFELDZDQUFvRDtBQUNwRCwrRUFBeUU7QUFDekUsK0ZBQXFIO0FBRXJILHNDQUFzQztBQUN0QyxNQUFNLE1BQU0sR0FBRyxHQUFHLEVBQUU7SUFDbEIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxHQUFHLElBQVcsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFBO0lBQ2pDLEVBQUUsQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLEtBQVUsRUFBRSxFQUFFO1FBQ3BDLEVBQUUsQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUE7UUFDN0IsT0FBTyxFQUFFLENBQUE7SUFDWCxDQUFDLENBQUE7SUFDRCxFQUFFLENBQUMsaUJBQWlCLEdBQUcsQ0FBQyxLQUFVLEVBQUUsRUFBRTtRQUNwQyxFQUFFLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFBO1FBQzdCLE9BQU8sRUFBRSxDQUFBO0lBQ1gsQ0FBQyxDQUFBO0lBQ0QsRUFBRSxDQUFDLHNCQUFzQixHQUFHLENBQUMsSUFBUyxFQUFFLEVBQUU7UUFDeEMsRUFBRSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQTtRQUNqQyxPQUFPLEVBQUUsQ0FBQTtJQUNYLENBQUMsQ0FBQTtJQUNELEVBQUUsQ0FBQyxTQUFTLEdBQUcsR0FBRyxFQUFFO1FBQ2xCLE9BQU8sRUFBRSxDQUFDLGtCQUFrQixDQUFBO1FBQzVCLE9BQU8sRUFBRSxDQUFDLGtCQUFrQixDQUFBO1FBQzVCLE9BQU8sRUFBRSxDQUFBO0lBQ1gsQ0FBQyxDQUFBO0lBQ0QsT0FBTyxFQUFFLENBQUE7QUFDWCxDQUFDLENBQUE7QUFFRCxNQUFNLElBQUksR0FBRztJQUNYLEVBQUUsRUFBRSxNQUFNO0lBQ1YsYUFBYSxFQUFFLEdBQUcsRUFB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QUNsRCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0lBRUYsUUFBUSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRTtRQUNyQyxFQUFFLENBQUMsK0NBQStDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDN0QsTUFBTSxTQUFTLEdBQUcsOENBQThDLENBQUE7WUFFaEUsVUFBVSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLEVBQUUsWUFBWSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUUzRSxNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUE7WUFFcEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDN0QsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ3JELE1BQU0sQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQzlDLE1BQU0sQ0FBQyxjQUFjLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDOUQsTUFBTSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxTQUFTLENBQUMsMEJBQTBCLENBQUMsQ0FBQTtRQUNyRSxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxkYXRhYmFzZS1vcHRpbWl6YXRpb25cXF9fdGVzdHNfX1xccXVlcnktYW5hbHl6ZXIuc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIHR5cGUgVGVzdGluZ01vZHVsZSB9IGZyb20gXCJAbmVzdGpzL3Rlc3RpbmdcIlxyXG5pbXBvcnQgeyBnZXREYXRhU291cmNlVG9rZW4gfSBmcm9tIFwiQG5lc3Rqcy90eXBlb3JtXCJcclxuaW1wb3J0IHsgUXVlcnlBbmFseXplclNlcnZpY2UgfSBmcm9tIFwiLi4vc2VydmljZXMvcXVlcnktYW5hbHl6ZXIuc2VydmljZVwiXHJcbmltcG9ydCB7IERhdGFiYXNlT3B0aW1pemF0aW9uQ29uZmlnLCBERUZBVUxUX09QVElNSVpBVElPTl9DT05GSUcgfSBmcm9tIFwiLi4vaW50ZXJmYWNlcy9vcHRpbWl6YXRpb24tY29uZmlnLmludGVyZmFjZVwiXHJcblxyXG4vLyBNb2NrIGplc3QgaWYgbm90IGF2YWlsYWJsZSBnbG9iYWxseVxyXG5jb25zdCBtb2NrRm4gPSAoKSA9PiB7XHJcbiAgY29uc3QgZm4gPSAoLi4uYXJnczogYW55W10pID0+IGZuXHJcbiAgZm4ubW9ja1Jlc29sdmVkVmFsdWUgPSAodmFsdWU6IGFueSkgPT4ge1xyXG4gICAgZm4uX21vY2tSZXNvbHZlZFZhbHVlID0gdmFsdWVcclxuICAgIHJldHVybiBmblxyXG4gIH1cclxuICBmbi5tb2NrUmVqZWN0ZWRWYWx1ZSA9ICh2YWx1ZTogYW55KSA9PiB7XHJcbiAgICBmbi5fbW9ja1JlamVjdGVkVmFsdWUgPSB2YWx1ZVxyXG4gICAgcmV0dXJuIGZuXHJcbiAgfVxyXG4gIGZuLm1vY2tJbXBsZW1lbnRhdGlvbk9uY2UgPSAoaW1wbDogYW55KSA9PiB7XHJcbiAgICBmbi5fbW9ja0ltcGxlbWVudGF0aW9uT25jZSA9IGltcGxcclxuICAgIHJldHVybiBmblxyXG4gIH1cclxuICBmbi5tb2NrQ2xlYXIgPSAoKSA9PiB7XHJcbiAgICBkZWxldGUgZm4uX21vY2tSZXNvbHZlZFZhbHVlXHJcbiAgICBkZWxldGUgZm4uX21vY2tSZWplY3RlZFZhbHVlXHJcbiAgICByZXR1cm4gZm5cclxuICB9XHJcbiAgcmV0dXJuIGZuXHJcbn1cclxuXHJcbmNvbnN0IGplc3QgPSB7XHJcbiAgZm46IG1vY2tGbixcclxuICBjbGVhckFsbE1vY2tzOiAoKSA9PiB7fSxcclxufVxyXG5cclxuZGVzY3JpYmUoXCJRdWVyeUFuYWx5emVyU2VydmljZVwiLCAoKSA9PiB7XHJcbiAgbGV0IHNlcnZpY2U6IFF1ZXJ5QW5hbHl6ZXJTZXJ2aWNlXHJcbiAgbGV0IGRhdGFTb3VyY2U6IGFueVxyXG5cclxuICBjb25zdCBtb2NrRXhlY3V0aW9uUGxhbiA9IHtcclxuICAgIG5vZGVUeXBlOiBcIlNlcSBTY2FuXCIsXHJcbiAgICB0b3RhbENvc3Q6IDE1MDAuMCxcclxuICAgIHN0YXJ0dXBDb3N0OiAwLjAsXHJcbiAgICBwbGFuUm93czogMTAwMCxcclxuICAgIHBsYW5XaWR0aDogMTAwLFxyXG4gICAgYWN0dWFsUm93czogOTUwLFxyXG4gICAgYWN0dWFsTG9vcHM6IDEsXHJcbiAgICBhY3R1YWxUb3RhbFRpbWU6IDI1LjUsXHJcbiAgICBjaGlsZHJlbjogW10sXHJcbiAgfVxyXG5cclxuICBjb25zdCBtb2NrRGF0YVNvdXJjZSA9IHtcclxuICAgIHF1ZXJ5OiBqZXN0LmZuKCksXHJcbiAgfVxyXG5cclxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XHJcbiAgICAgIHByb3ZpZGVyczogW1xyXG4gICAgICAgIFF1ZXJ5QW5hbHl6ZXJTZXJ2aWNlLFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIHByb3ZpZGU6IGdldERhdGFTb3VyY2VUb2tlbigpLFxyXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tEYXRhU291cmNlLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogRGF0YWJhc2VPcHRpbWl6YXRpb25Db25maWcsXHJcbiAgICAgICAgICB1c2VWYWx1ZTogREVGQVVMVF9PUFRJTUlaQVRJT05fQ09ORklHLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0sXHJcbiAgICB9KS5jb21waWxlKClcclxuXHJcbiAgICBzZXJ2aWNlID0gbW9kdWxlLmdldDxRdWVyeUFuYWx5emVyU2VydmljZT4oUXVlcnlBbmFseXplclNlcnZpY2UpXHJcbiAgICBkYXRhU291cmNlID0gbW9kdWxlLmdldChnZXREYXRhU291cmNlVG9rZW4oKSlcclxuICB9KVxyXG5cclxuICBhZnRlckVhY2goKCkgPT4ge1xyXG4gICAgamVzdC5jbGVhckFsbE1vY2tzKClcclxuICB9KVxyXG5cclxuICBkZXNjcmliZShcImFuYWx5emVRdWVyeVwiLCAoKSA9PiB7XHJcbiAgICBpdChcInNob3VsZCBhbmFseXplIGEgcXVlcnkgYW5kIHJldHVybiBvcHRpbWl6YXRpb24gc3VnZ2VzdGlvbnNcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0UXVlcnkgPSBcIlNFTEVDVCAqIEZST00gdXNlcnMgV0hFUkUgYWdlID4gMjVcIlxyXG5cclxuICAgICAgZGF0YVNvdXJjZS5xdWVyeS5tb2NrUmVzb2x2ZWRWYWx1ZShbeyBcIlFVRVJZIFBMQU5cIjogW21vY2tFeGVjdXRpb25QbGFuXSB9XSlcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuYW5hbHl6ZVF1ZXJ5KHRlc3RRdWVyeSlcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KHJlc3VsdC5xdWVyeSkudG9CZSh0ZXN0UXVlcnkpXHJcbiAgICAgIGV4cGVjdChyZXN1bHQuZXhlY3V0aW9uUGxhbikudG9FcXVhbChtb2NrRXhlY3V0aW9uUGxhbilcclxuICAgICAgZXhwZWN0KHJlc3VsdC5zdWdnZXN0aW9ucykudG9CZUluc3RhbmNlT2YoQXJyYXkpXHJcbiAgICAgIGV4cGVjdChyZXN1bHQuaW5kZXhSZWNvbW1lbmRhdGlvbnMpLnRvQmVJbnN0YW5jZU9mKEFycmF5KVxyXG4gICAgICBleHBlY3QodHlwZW9mIHJlc3VsdC5wZXJmb3JtYW5jZVNjb3JlKS50b0JlKFwibnVtYmVyXCIpXHJcbiAgICAgIGV4cGVjdChyZXN1bHQucGVyZm9ybWFuY2VTY29yZSkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgwKVxyXG4gICAgICBleHBlY3QocmVzdWx0LnBlcmZvcm1hbmNlU2NvcmUpLnRvQmVMZXNzVGhhbk9yRXF1YWwoMTAwKVxyXG4gICAgfSlcclxuXHJcbiAgICBpdChcInNob3VsZCBkZXRlY3Qgc2VxdWVudGlhbCBzY2FuIGFuZCBzdWdnZXN0IGluZGV4IGNyZWF0aW9uXCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdFF1ZXJ5ID0gXCJTRUxFQ1QgKiBGUk9NIGxhcmdlX3RhYmxlIFdIRVJFIGNvbHVtbjEgPSAxMjNcIlxyXG5cclxuICAgICAgZGF0YVNvdXJjZS5xdWVyeS5tb2NrUmVzb2x2ZWRWYWx1ZShbeyBcIlFVRVJZIFBMQU5cIjogW21vY2tFeGVjdXRpb25QbGFuXSB9XSlcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuYW5hbHl6ZVF1ZXJ5KHRlc3RRdWVyeSlcclxuXHJcbiAgICAgIGNvbnN0IGluZGV4U3VnZ2VzdGlvbiA9IHJlc3VsdC5zdWdnZXN0aW9ucy5maW5kKChzKSA9PiBzLnR5cGUgPT09IFwiSU5ERVhcIilcclxuICAgICAgZXhwZWN0KGluZGV4U3VnZ2VzdGlvbikudG9CZURlZmluZWQoKVxyXG4gICAgICBleHBlY3QoaW5kZXhTdWdnZXN0aW9uPy5wcmlvcml0eSkudG9CZShcIkhJR0hcIilcclxuICAgICAgZXhwZWN0KGluZGV4U3VnZ2VzdGlvbj8uZGVzY3JpcHRpb24pLnRvQ29udGFpbihcIlNlcXVlbnRpYWwgc2NhbiBkZXRlY3RlZFwiKVxyXG4gICAgfSlcclxuXHJcbiAgICBpdChcInNob3VsZCBkZXRlY3QgU0VMRUNUICogdXNhZ2UgYW5kIHN1Z2dlc3Qgb3B0aW1pemF0aW9uXCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdFF1ZXJ5ID0gXCJTRUxFQ1QgKiBGUk9NIHVzZXJzXCJcclxuXHJcbiAgICAgIGRhdGFTb3VyY2UucXVlcnkubW9ja1Jlc29sdmVkVmFsdWUoW3sgXCJRVUVSWSBQTEFOXCI6IFt7IC4uLm1vY2tFeGVjdXRpb25QbGFuLCBub2RlVHlwZTogXCJJbmRleCBTY2FuXCIgfV0gfV0pXHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmFuYWx5emVRdWVyeSh0ZXN0UXVlcnkpXHJcblxyXG4gICAgICBjb25zdCBzZWxlY3RTdGFyU3VnZ2VzdGlvbiA9IHJlc3VsdC5zdWdnZXN0aW9ucy5maW5kKChzKSA9PiBzLmRlc2NyaXB0aW9uLmluY2x1ZGVzKFwiU0VMRUNUICogdXNhZ2UgZGV0ZWN0ZWRcIikpXHJcbiAgICAgIGV4cGVjdChzZWxlY3RTdGFyU3VnZ2VzdGlvbikudG9CZURlZmluZWQoKVxyXG4gICAgICBleHBlY3Qoc2VsZWN0U3RhclN1Z2dlc3Rpb24/LnByaW9yaXR5KS50b0JlKFwiTE9XXCIpXHJcbiAgICB9KVxyXG5cclxuICAgIGl0KFwic2hvdWxkIGRldGVjdCBtaXNzaW5nIFdIRVJFIGNsYXVzZVwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3RRdWVyeSA9IFwiU0VMRUNUIG5hbWUsIGVtYWlsIEZST00gdXNlcnNcIlxyXG5cclxuICAgICAgZGF0YVNvdXJjZS5xdWVyeS5tb2NrUmVzb2x2ZWRWYWx1ZShbeyBcIlFVRVJZIFBMQU5cIjogW21vY2tFeGVjdXRpb25QbGFuXSB9XSlcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuYW5hbHl6ZVF1ZXJ5KHRlc3RRdWVyeSlcclxuXHJcbiAgICAgIGNvbnN0IHdoZXJlQ2xhdXNlU3VnZ2VzdGlvbiA9IHJlc3VsdC5zdWdnZXN0aW9ucy5maW5kKChzKSA9PiBzLmRlc2NyaXB0aW9uLmluY2x1ZGVzKFwiUXVlcnkgd2l0aG91dCBXSEVSRSBjbGF1c2VcIikpXHJcbiAgICAgIGV4cGVjdCh3aGVyZUNsYXVzZVN1Z2dlc3Rpb24pLnRvQmVEZWZpbmVkKClcclxuICAgICAgZXhwZWN0KHdoZXJlQ2xhdXNlU3VnZ2VzdGlvbj8ucHJpb3JpdHkpLnRvQmUoXCJDUklUSUNBTFwiKVxyXG4gICAgfSlcclxuXHJcbiAgICBpdChcInNob3VsZCBoYW5kbGUgcXVlcnkgYW5hbHlzaXMgZXJyb3JzIGdyYWNlZnVsbHlcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0UXVlcnkgPSBcIklOVkFMSUQgU1FMIFFVRVJZXCJcclxuXHJcbiAgICAgIGRhdGFTb3VyY2UucXVlcnkubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKFwiU1FMIHN5bnRheCBlcnJvclwiKSlcclxuXHJcbiAgICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLmFuYWx5emVRdWVyeSh0ZXN0UXVlcnkpKS5yZWplY3RzLnRvVGhyb3coXCJTUUwgc3ludGF4IGVycm9yXCIpXHJcbiAgICB9KVxyXG4gIH0pXHJcblxyXG4gIGRlc2NyaWJlKFwicXVlcnkgaGlzdG9yeSBtYW5hZ2VtZW50XCIsICgpID0+IHtcclxuICAgIGl0KFwic2hvdWxkIHRyYWNrIHF1ZXJ5IHBlcmZvcm1hbmNlIG1ldHJpY3NcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB0ZXN0UXVlcnkgPSBcIlNFTEVDVCBpZCBGUk9NIHVzZXJzIFdIRVJFIGFjdGl2ZSA9IHRydWVcIlxyXG5cclxuICAgICAgZGF0YVNvdXJjZS5xdWVyeS5tb2NrUmVzb2x2ZWRWYWx1ZShbeyBcIlFVRVJZIFBMQU5cIjogW3sgLi4ubW9ja0V4ZWN1dGlvblBsYW4sIG5vZGVUeXBlOiBcIkluZGV4IFNjYW5cIiB9XSB9XSlcclxuXHJcbiAgICAgIC8vIEV4ZWN1dGUgdGhlIHNhbWUgcXVlcnkgbXVsdGlwbGUgdGltZXNcclxuICAgICAgYXdhaXQgc2VydmljZS5hbmFseXplUXVlcnkodGVzdFF1ZXJ5KVxyXG4gICAgICBhd2FpdCBzZXJ2aWNlLmFuYWx5emVRdWVyeSh0ZXN0UXVlcnkpXHJcbiAgICAgIGF3YWl0IHNlcnZpY2UuYW5hbHl6ZVF1ZXJ5KHRlc3RRdWVyeSlcclxuXHJcbiAgICAgIGNvbnN0IGhpc3RvcnkgPSBzZXJ2aWNlLmdldFF1ZXJ5SGlzdG9yeSgpXHJcbiAgICAgIGV4cGVjdChoaXN0b3J5Lmxlbmd0aCkudG9CZSgxKVxyXG5cclxuICAgICAgY29uc3QgcXVlcnlNZXRyaWNzID0gaGlzdG9yeVswXVxyXG4gICAgICBleHBlY3QocXVlcnlNZXRyaWNzLnRvdGFsRXhlY3V0aW9ucykudG9CZSgzKVxyXG4gICAgICBleHBlY3QocXVlcnlNZXRyaWNzLnF1ZXJ5KS50b0JlKHRlc3RRdWVyeSlcclxuICAgICAgZXhwZWN0KHF1ZXJ5TWV0cmljcy5hdmdFeGVjdXRpb25UaW1lKS50b0JlR3JlYXRlclRoYW4oMClcclxuICAgIH0pXHJcblxyXG4gICAgaXQoXCJzaG91bGQgaWRlbnRpZnkgc2xvdyBxdWVyaWVzIGNvcnJlY3RseVwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGZhc3RRdWVyeSA9IFwiU0VMRUNUIGlkIEZST00gdXNlcnMgTElNSVQgMVwiXHJcbiAgICAgIGNvbnN0IHNsb3dRdWVyeSA9IFwiU0VMRUNUICogRlJPTSBsYXJnZV90YWJsZVwiXHJcblxyXG4gICAgICAvLyBNb2NrIGZhc3QgZXhlY3V0aW9uXHJcbiAgICAgIGRhdGFTb3VyY2UucXVlcnkubW9ja1Jlc29sdmVkVmFsdWUoW3sgXCJRVUVSWSBQTEFOXCI6IFt7IC4uLm1vY2tFeGVjdXRpb25QbGFuLCB0b3RhbENvc3Q6IDEwIH1dIH1dKVxyXG5cclxuICAgICAgYXdhaXQgc2VydmljZS5hbmFseXplUXVlcnkoZmFzdFF1ZXJ5KVxyXG5cclxuICAgICAgLy8gTW9jayBzbG93IGV4ZWN1dGlvbiBieSBkZWxheWluZ1xyXG4gICAgICBkYXRhU291cmNlLnF1ZXJ5Lm1vY2tJbXBsZW1lbnRhdGlvbk9uY2UoXHJcbiAgICAgICAgKCkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQoKCkgPT4gcmVzb2x2ZShbeyBcIlFVRVJZIFBMQU5cIjogW21vY2tFeGVjdXRpb25QbGFuXSB9XSksIDExMDApKSxcclxuICAgICAgKVxyXG5cclxuICAgICAgYXdhaXQgc2VydmljZS5hbmFseXplUXVlcnkoc2xvd1F1ZXJ5KVxyXG5cclxuICAgICAgY29uc3Qgc2xvd1F1ZXJpZXMgPSBzZXJ2aWNlLmdldFNsb3dRdWVyaWVzKDEwMDApXHJcbiAgICAgIGV4cGVjdChzbG93UXVlcmllcy5sZW5ndGgpLnRvQmUoMSlcclxuICAgICAgZXhwZWN0KHNsb3dRdWVyaWVzWzBdLnF1ZXJ5KS50b0JlKHNsb3dRdWVyeSlcclxuICAgIH0pXHJcblxyXG4gICAgaXQoXCJzaG91bGQgY2xlYXIgcXVlcnkgaGlzdG9yeVwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRlc3RRdWVyeSA9IFwiU0VMRUNUICogRlJPTSB0ZXN0X3RhYmxlXCJcclxuXHJcbiAgICAgIGRhdGFTb3VyY2UucXVlcnkubW9ja1Jlc29sdmVkVmFsdWUoW3sgXCJRVUVSWSBQTEFOXCI6IFttb2NrRXhlY3V0aW9uUGxhbl0gfV0pXHJcblxyXG4gICAgICBhd2FpdCBzZXJ2aWNlLmFuYWx5emVRdWVyeSh0ZXN0UXVlcnkpXHJcbiAgICAgIGV4cGVjdChzZXJ2aWNlLmdldFF1ZXJ5SGlzdG9yeSgpLmxlbmd0aCkudG9CZSgxKVxyXG5cclxuICAgICAgc2VydmljZS5jbGVhclF1ZXJ5SGlzdG9yeSgpXHJcbiAgICAgIGV4cGVjdChzZXJ2aWNlLmdldFF1ZXJ5SGlzdG9yeSgpLmxlbmd0aCkudG9CZSgwKVxyXG4gICAgfSlcclxuICB9KVxyXG5cclxuICBkZXNjcmliZShcInBlcmZvcm1hbmNlIHNjb3JpbmdcIiwgKCkgPT4ge1xyXG4gICAgaXQoXCJzaG91bGQgY2FsY3VsYXRlIHBlcmZvcm1hbmNlIHNjb3JlIGJhc2VkIG9uIGV4ZWN1dGlvbiB0aW1lIGFuZCBjb3N0XCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgZWZmaWNpZW50UXVlcnkgPSBcIlNFTEVDVCBpZCBGUk9NIHVzZXJzIFdIRVJFIGlkID0gMVwiXHJcblxyXG4gICAgICBkYXRhU291cmNlLnF1ZXJ5Lm1vY2tSZXNvbHZlZFZhbHVlKFtcclxuICAgICAgICB7IFwiUVVFUlkgUExBTlwiOiBbeyAuLi5tb2NrRXhlY3V0aW9uUGxhbiwgdG90YWxDb3N0OiAxMCwgbm9kZVR5cGU6IFwiSW5kZXggU2NhblwiIH1dIH0sXHJcbiAgICAgIF0pXHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLmFuYWx5emVRdWVyeShlZmZpY2llbnRRdWVyeSlcclxuICAgICAgZXhwZWN0KHJlc3VsdC5wZXJmb3JtYW5jZVNjb3JlKS50b0JlR3JlYXRlclRoYW4oODApXHJcbiAgICB9KVxyXG5cclxuICAgIGl0KFwic2hvdWxkIHBlbmFsaXplIHF1ZXJpZXMgd2l0aCBzZXF1ZW50aWFsIHNjYW5zXCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgaW5lZmZpY2llbnRRdWVyeSA9IFwiU0VMRUNUICogRlJPTSBsYXJnZV90YWJsZSBXSEVSRSBjb2x1bW4gPSB2YWx1ZVwiXHJcblxyXG4gICAgICBkYXRhU291cmNlLnF1ZXJ5Lm1vY2tSZXNvbHZlZFZhbHVlKFtcclxuICAgICAgICB7IFwiUVVFUlkgUExBTlwiOiBbbW9ja0V4ZWN1dGlvblBsYW5dIH0sIC8vIFNlcXVlbnRpYWwgc2NhbiB3aXRoIGhpZ2ggY29zdFxyXG4gICAgICBdKVxyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5hbmFseXplUXVlcnkoaW5lZmZpY2llbnRRdWVyeSlcclxuICAgICAgZXhwZWN0KHJlc3VsdC5wZXJmb3JtYW5jZVNjb3JlKS50b0JlTGVzc1RoYW4oODApXHJcbiAgICB9KVxyXG4gIH0pXHJcblxyXG4gIGRlc2NyaWJlKFwiaW5kZXggcmVjb21tZW5kYXRpb25zXCIsICgpID0+IHtcclxuICAgIGl0KFwic2hvdWxkIHJlY29tbWVuZCBpbmRleGVzIGZvciBzZXF1ZW50aWFsIHNjYW5zXCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdGVzdFF1ZXJ5ID0gXCJTRUxFQ1QgKiBGUk9NIHByb2R1Y3RzIFdIRVJFIGNhdGVnb3J5X2lkID0gNVwiXHJcblxyXG4gICAgICBkYXRhU291cmNlLnF1ZXJ5Lm1vY2tSZXNvbHZlZFZhbHVlKFt7IFwiUVVFUlkgUExBTlwiOiBbbW9ja0V4ZWN1dGlvblBsYW5dIH1dKVxyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5hbmFseXplUXVlcnkodGVzdFF1ZXJ5KVxyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5pbmRleFJlY29tbWVuZGF0aW9ucy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKVxyXG4gICAgICBjb25zdCByZWNvbW1lbmRhdGlvbiA9IHJlc3VsdC5pbmRleFJlY29tbWVuZGF0aW9uc1swXVxyXG4gICAgICBleHBlY3QocmVjb21tZW5kYXRpb24uaW5kZXhUeXBlKS50b0JlKFwiQlRSRUVcIilcclxuICAgICAgZXhwZWN0KHJlY29tbWVuZGF0aW9uLmVzdGltYXRlZEltcHJvdmVtZW50KS50b0JlR3JlYXRlclRoYW4oMClcclxuICAgICAgZXhwZWN0KHJlY29tbWVuZGF0aW9uLnJlYXNvbikudG9Db250YWluKFwiU2VxdWVudGlhbCBzY2FuIGRldGVjdGVkXCIpXHJcbiAgICB9KVxyXG4gIH0pXHJcbn0pXHJcbiJdLCJ2ZXJzaW9uIjozfQ==