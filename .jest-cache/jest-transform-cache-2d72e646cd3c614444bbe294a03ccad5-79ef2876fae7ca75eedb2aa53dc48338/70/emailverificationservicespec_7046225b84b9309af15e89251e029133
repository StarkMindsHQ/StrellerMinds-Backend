3581ffa254c0877c9bdbd4cee56c7096
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const typeorm_1 = require("@nestjs/typeorm");
const common_1 = require("@nestjs/common");
const email_verification_service_1 = require("./email-verification.service");
const user_entity_1 = require("../entities/user.entity");
const email_service_1 = require("../email/email.service");
describe('EmailVerificationService', () => {
    let service;
    let userRepository;
    let emailService;
    const mockUser = {
        id: '123',
        email: 'test@example.com',
        isEmailVerified: false,
        emailVerificationToken: null,
        emailVerificationTokenExpiry: null,
    };
    const mockUserRepository = {
        findOne: jest.fn(),
        update: jest.fn(),
    };
    const mockEmailService = {
        sendVerificationEmail: jest.fn(),
    };
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                email_verification_service_1.EmailVerificationService,
                {
                    provide: (0, typeorm_1.getRepositoryToken)(user_entity_1.User),
                    useValue: mockUserRepository,
                },
                {
                    provide: email_service_1.EmailService,
                    useValue: mockEmailService,
                },
            ],
        }).compile();
        service = module.get(email_verification_service_1.EmailVerificationService);
        userRepository = module.get((0, typeorm_1.getRepositoryToken)(user_entity_1.User));
        emailService = module.get(email_service_1.EmailService);
    });
    describe('sendVerificationEmail', () => {
        it('should send verification email for valid user', async () => {
            mockUserRepository.findOne.mockResolvedValue(mockUser);
            mockUserRepository.update.mockResolvedValue({});
            mockEmailService.sendVerificationEmail.mockResolvedValue(undefined);
            const result = await service.sendVerificationEmail('test@example.com');
            expect(result.message).toBe('Verification email sent successfully');
            expect(mockEmailService.sendVerificationEmail).toHaveBeenCalled();
        });
        it('should throw NotFoundException for non-existent user', async () => {
            mockUserRepository.findOne.mockResolvedValue(null);
            await expect(service.sendVerificationEmail('test@example.com'))
                .rejects.toThrow(common_1.NotFoundException);
        });
        it('should throw BadRequestException for already verified email', async () => {
            mockUserRepository.findOne.mockResolvedValue({
                ...mockUser,
                isEmailVerified: true,
            });
            await expect(service.sendVerificationEmail('test@example.com'))
                .rejects.toThrow(common_1.BadRequestException);
        });
    });
    describe('verifyEmail', () => {
        it('should verify email with valid token', async () => {
            const mockUserWithToken = {
                ...mockUser,
                emailVerificationToken: 'valid-token',
                emailVerificationTokenExpiry: new Date(Date.now() + 24 * 60 * 60 * 1000),
            };
            mockUserRepository.findOne.mockResolvedValue(mockUserWithToken);
            mockUserRepository.update.mockResolvedValue({});
            const result = await service.verifyEmail('valid-token');
            expect(result.message).toBe('Email verified successfully');
            expect(result.user.isEmailVerified).toBe(true);
        });
        it('should throw BadRequestException for invalid token', async () => {
            mockUserRepository.findOne.mockResolvedValue(null);
            await expect(service.verifyEmail('invalid-token'))
                .rejects.toThrow(common_1.BadRequestException);
        });
        it('should throw BadRequestException for expired token', async () => {
            const mockUserWithExpiredToken = {
                ...mockUser,
                emailVerificationToken: 'expired-token',
                emailVerificationTokenExpiry: new Date(Date.now() - 1000),
            };
            mockUserRepository.findOne.mockResolvedValue(mockUserWithExpiredToken);
            await expect(service.verifyEmail('expired-token'))
                .rejects.toThrow(common_1.BadRequestException);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxlbWFpbC12ZXJpZmljYXRpb25cXGVtYWlsLXZlcmlmaWNhdGlvbi5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBc0Q7QUFDdEQsNkNBQXFEO0FBRXJELDJDQUF3RTtBQUN4RSw2RUFBd0U7QUFDeEUseURBQStDO0FBQy9DLDBEQUFzRDtBQUV0RCxRQUFRLENBQUMsMEJBQTBCLEVBQUUsR0FBRyxFQUFFO0lBQ3hDLElBQUksT0FBaUMsQ0FBQztJQUN0QyxJQUFJLGNBQWdDLENBQUM7SUFDckMsSUFBSSxZQUEwQixDQUFDO0lBRS9CLE1BQU0sUUFBUSxHQUFHO1FBQ2YsRUFBRSxFQUFFLEtBQUs7UUFDVCxLQUFLLEVBQUUsa0JBQWtCO1FBQ3pCLGVBQWUsRUFBRSxLQUFLO1FBQ3RCLHNCQUFzQixFQUFFLElBQUk7UUFDNUIsNEJBQTRCLEVBQUUsSUFBSTtLQUNuQyxDQUFDO0lBRUYsTUFBTSxrQkFBa0IsR0FBRztRQUN6QixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNsQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtLQUNsQixDQUFDO0lBRUYsTUFBTSxnQkFBZ0IsR0FBRztRQUN2QixxQkFBcUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ2pDLENBQUM7SUFFRixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRTtnQkFDVCxxREFBd0I7Z0JBQ3hCO29CQUNFLE9BQU8sRUFBRSxJQUFBLDRCQUFrQixFQUFDLGtCQUFJLENBQUM7b0JBQ2pDLFFBQVEsRUFBRSxrQkFBa0I7aUJBQzdCO2dCQUNEO29CQUNFLE9BQU8sRUFBRSw0QkFBWTtvQkFDckIsUUFBUSxFQUFFLGdCQUFnQjtpQkFDM0I7YUFDRjtTQUNGLENBQUMsQ0FB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QUssSUFBSSxFQUFFO1lBQ2xFLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUVuRCxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDO2lCQUMvQyxPQUFPLENBQUMsT0FBTyxDQUFDLDRCQUFtQixDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsb0RBQW9ELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDbEUsTUFBTSx3QkFBd0IsR0FBRztnQkFDL0IsR0FBRyxRQUFRO2dCQUNYLHNCQUFzQixFQUFFLGVBQWU7Z0JBQ3ZDLDRCQUE0QixFQUFFLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7YUFDMUQsQ0FBQztZQUVGLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1lBRXZFLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLENBQUM7aUJBQy9DLE9BQU8sQ0FBQyxPQUFPLENBQUMsNEJBQW1CLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxnLWVrb2hcXERlc2t0b3BcXFN0cmVsbGVyTWluZHMtQmFja2VuZFxcc3JjXFxlbWFpbC12ZXJpZmljYXRpb25cXGVtYWlsLXZlcmlmaWNhdGlvbi5zZXJ2aWNlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XHJcbmltcG9ydCB7IGdldFJlcG9zaXRvcnlUb2tlbiB9IGZyb20gJ0BuZXN0anMvdHlwZW9ybSc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICd0eXBlb3JtJztcclxuaW1wb3J0IHsgQmFkUmVxdWVzdEV4Y2VwdGlvbiwgTm90Rm91bmRFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XHJcbmltcG9ydCB7IEVtYWlsVmVyaWZpY2F0aW9uU2VydmljZSB9IGZyb20gJy4vZW1haWwtdmVyaWZpY2F0aW9uLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vZW50aXRpZXMvdXNlci5lbnRpdHknO1xyXG5pbXBvcnQgeyBFbWFpbFNlcnZpY2UgfSBmcm9tICcuLi9lbWFpbC9lbWFpbC5zZXJ2aWNlJztcclxuXHJcbmRlc2NyaWJlKCdFbWFpbFZlcmlmaWNhdGlvblNlcnZpY2UnLCAoKSA9PiB7XHJcbiAgbGV0IHNlcnZpY2U6IEVtYWlsVmVyaWZpY2F0aW9uU2VydmljZTtcclxuICBsZXQgdXNlclJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8VXNlcj47XHJcbiAgbGV0IGVtYWlsU2VydmljZTogRW1haWxTZXJ2aWNlO1xyXG5cclxuICBjb25zdCBtb2NrVXNlciA9IHtcclxuICAgIGlkOiAnMTIzJyxcclxuICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXHJcbiAgICBpc0VtYWlsVmVyaWZpZWQ6IGZhbHNlLFxyXG4gICAgZW1haWxWZXJpZmljYXRpb25Ub2tlbjogbnVsbCxcclxuICAgIGVtYWlsVmVyaWZpY2F0aW9uVG9rZW5FeHBpcnk6IG51bGwsXHJcbiAgfTtcclxuXHJcbiAgY29uc3QgbW9ja1VzZXJSZXBvc2l0b3J5ID0ge1xyXG4gICAgZmluZE9uZTogamVzdC5mbigpLFxyXG4gICAgdXBkYXRlOiBqZXN0LmZuKCksXHJcbiAgfTtcclxuXHJcbiAgY29uc3QgbW9ja0VtYWlsU2VydmljZSA9IHtcclxuICAgIHNlbmRWZXJpZmljYXRpb25FbWFpbDogamVzdC5mbigpLFxyXG4gIH07XHJcblxyXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcclxuICAgICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAgRW1haWxWZXJpZmljYXRpb25TZXJ2aWNlLFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIHByb3ZpZGU6IGdldFJlcG9zaXRvcnlUb2tlbihVc2VyKSxcclxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrVXNlclJlcG9zaXRvcnksXHJcbiAgICAgICAgfSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBwcm92aWRlOiBFbWFpbFNlcnZpY2UsXHJcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja0VtYWlsU2VydmljZSxcclxuICAgICAgICB9LFxyXG4gICAgICBdLFxyXG4gICAgfSkuY29tcGlsZSgpO1xyXG5cclxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PEVtYWlsVmVyaWZpY2F0aW9uU2VydmljZT4oRW1haWxWZXJpZmljYXRpb25TZXJ2aWNlKTtcclxuICAgIHVzZXJSZXBvc2l0b3J5ID0gbW9kdWxlLmdldDxSZXBvc2l0b3J5PFVzZXI+PihnZXRSZXBvc2l0b3J5VG9rZW4oVXNlcikpO1xyXG4gICAgZW1haWxTZXJ2aWNlID0gbW9kdWxlLmdldDxFbWFpbFNlcnZpY2U+KEVtYWlsU2VydmljZSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdzZW5kVmVyaWZpY2F0aW9uRW1haWwnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHNlbmQgdmVyaWZpY2F0aW9uIGVtYWlsIGZvciB2YWxpZCB1c2VyJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBtb2NrVXNlclJlcG9zaXRvcnkuZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlcik7XHJcbiAgICAgIG1vY2tVc2VyUmVwb3NpdG9yeS51cGRhdGUubW9ja1Jlc29sdmVkVmFsdWUoe30pO1xyXG4gICAgICBtb2NrRW1haWxTZXJ2aWNlLnNlbmRWZXJpZmljYXRpb25FbWFpbC5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5zZW5kVmVyaWZpY2F0aW9uRW1haWwoJ3Rlc3RAZXhhbXBsZS5jb20nKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQubWVzc2FnZSkudG9CZSgnVmVyaWZpY2F0aW9uIGVtYWlsIHNlbnQgc3VjY2Vzc2Z1bGx5Jyk7XHJcbiAgICAgIGV4cGVjdChtb2NrRW1haWxTZXJ2aWNlLnNlbmRWZXJpZmljYXRpb25FbWFpbCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBOb3RGb3VuZEV4Y2VwdGlvbiBmb3Igbm9uLWV4aXN0ZW50IHVzZXInLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tVc2VyUmVwb3NpdG9yeS5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KHNlcnZpY2Uuc2VuZFZlcmlmaWNhdGlvbkVtYWlsKCd0ZXN0QGV4YW1wbGUuY29tJykpXHJcbiAgICAgICAgLnJlamVjdHMudG9UaHJvdyhOb3RGb3VuZEV4Y2VwdGlvbik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHRocm93IEJhZFJlcXVlc3RFeGNlcHRpb24gZm9yIGFscmVhZHkgdmVyaWZpZWQgZW1haWwnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tVc2VyUmVwb3NpdG9yeS5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKHtcclxuICAgICAgICAuLi5tb2NrVXNlcixcclxuICAgICAgICBpc0VtYWlsVmVyaWZpZWQ6IHRydWUsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KHNlcnZpY2Uuc2VuZFZlcmlmaWNhdGlvbkVtYWlsKCd0ZXN0QGV4YW1wbGUuY29tJykpXHJcbiAgICAgICAgLnJlamVjdHMudG9UaHJvdyhCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgndmVyaWZ5RW1haWwnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHZlcmlmeSBlbWFpbCB3aXRoIHZhbGlkIHRva2VuJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtb2NrVXNlcldpdGhUb2tlbiA9IHtcclxuICAgICAgICAuLi5tb2NrVXNlcixcclxuICAgICAgICBlbWFpbFZlcmlmaWNhdGlvblRva2VuOiAndmFsaWQtdG9rZW4nLFxyXG4gICAgICAgIGVtYWlsVmVyaWZpY2F0aW9uVG9rZW5FeHBpcnk6IG5ldyBEYXRlKERhdGUubm93KCkgKyAyNCAqIDYwICogNjAgKiAxMDAwKSxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIG1vY2tVc2VyUmVwb3NpdG9yeS5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc2VyV2l0aFRva2VuKTtcclxuICAgICAgbW9ja1VzZXJSZXBvc2l0b3J5LnVwZGF0ZS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZXJ2aWNlLnZlcmlmeUVtYWlsKCd2YWxpZC10b2tlbicpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5tZXNzYWdlKS50b0JlKCdFbWFpbCB2ZXJpZmllZCBzdWNjZXNzZnVsbHknKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdC51c2VyLmlzRW1haWxWZXJpZmllZCkudG9CZSh0cnVlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgdGhyb3cgQmFkUmVxdWVzdEV4Y2VwdGlvbiBmb3IgaW52YWxpZCB0b2tlbicsIGFzeW5jICgpID0+IHtcclxuICAgICAgbW9ja1VzZXJSZXBvc2l0b3J5LmZpbmRPbmUubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS52ZXJpZnlFbWFpbCgnaW52YWxpZC10b2tlbicpKVxyXG4gICAgICAgIC5yZWplY3RzLnRvVGhyb3coQmFkUmVxdWVzdEV4Y2VwdGlvbik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHRocm93IEJhZFJlcXVlc3RFeGNlcHRpb24gZm9yIGV4cGlyZWQgdG9rZW4nLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG1vY2tVc2VyV2l0aEV4cGlyZWRUb2tlbiA9IHtcclxuICAgICAgICAuLi5tb2NrVXNlcixcclxuICAgICAgICBlbWFpbFZlcmlmaWNhdGlvblRva2VuOiAnZXhwaXJlZC10b2tlbicsXHJcbiAgICAgICAgZW1haWxWZXJpZmljYXRpb25Ub2tlbkV4cGlyeTogbmV3IERhdGUoRGF0ZS5ub3coKSAtIDEwMDApLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgbW9ja1VzZXJSZXBvc2l0b3J5LmZpbmRPbmUubW9ja1Jlc29sdmVkVmFsdWUobW9ja1VzZXJXaXRoRXhwaXJlZFRva2VuKTtcclxuXHJcbiAgICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLnZlcmlmeUVtYWlsKCdleHBpcmVkLXRva2VuJykpXHJcbiAgICAgICAgLnJlamVjdHMudG9UaHJvdyhCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9