{"file":"C:\\Users\\g-ekoh\\Desktop\\StrellerMinds-Backend\\src\\email\\email.service.spec.ts","mappings":"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","names":[],"sources":["C:\\Users\\g-ekoh\\Desktop\\StrellerMinds-Backend\\src\\email\\email.service.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { EmailService } from './email.service';\r\nimport { getRepositoryToken } from '@nestjs/typeorm';\r\nimport { EmailTemplate } from './entities/email-template.entity';\r\nimport { EmailLog } from './entities/email-log.entity';\r\nimport { EmailPreference } from './entities/email-preference.entity';\r\nimport { Queue } from 'bull';\r\nimport { JwtService } from '@nestjs/jwt';\r\n\r\ndescribe('EmailService.verifyUnsubscribeToken', () => {\r\n  let service: EmailService;\r\n  let config: Partial<ConfigService>;\r\n  let jwt: { sign: jest.Mock; verify: jest.Mock };\r\n\r\n  beforeEach(async () => {\r\n    config = {\r\n      get: jest.fn((key: string) => {\r\n        if (key === 'UNSUBSCRIBE_JWT_SECRET') return 'secret-x';\r\n        if (key === 'JWT_SECRET') return 'fallback';\r\n        return undefined;\r\n      }),\r\n    } as any;\r\n\r\n    jwt = { sign: jest.fn(), verify: jest.fn() };\r\n\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        EmailService,\r\n        { provide: ConfigService, useValue: config },\r\n        { provide: 'BullQueue_email', useValue: { add: jest.fn() } as Partial<Queue> },\r\n        { provide: getRepositoryToken(EmailTemplate), useValue: {} },\r\n        { provide: getRepositoryToken(EmailLog), useValue: {} },\r\n        { provide: getRepositoryToken(EmailPreference), useValue: {} },\r\n        { provide: JwtService, useValue: jwt },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get(EmailService);\r\n  });\r\n\r\n  it('returns true when token payload email matches', async () => {\r\n    jwt.verify.mockReturnValue({ email: 'user@example.com' });\r\n    const ok = await service.verifyUnsubscribeToken('user@example.com', 'tok');\r\n    expect(ok).toBe(true);\r\n  });\r\n\r\n  it('returns false on invalid token', async () => {\r\n    jwt.verify.mockImplementation(() => { throw new Error('bad'); });\r\n    const ok = await service.verifyUnsubscribeToken('user@example.com', 'tok');\r\n    expect(ok).toBe(false);\r\n  });\r\n});\r\n\r\nimport { Test, TestingModule } from '@nestjs/testing';\r\nimport { EmailService } from './email.service';\r\nimport { getRepositoryToken } from '@nestjs/typeorm';\r\nimport { EmailTemplate } from './entities/email-template.entity';\r\nimport { EmailLog } from './entities/email-log.entity';\r\nimport { EmailPreference } from './entities/email-preference.entity';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { Queue } from 'bull';\r\n\r\ndescribe('EmailService', () => {\r\n  let service: EmailService;\r\n  let mockQueue: Queue;\r\n\r\n  const mockEmailTemplateRepo = {\r\n    findOne: jest.fn(),\r\n  };\r\n  const mockEmailLogRepo = {\r\n    create: jest.fn().mockImplementation((data) => data),\r\n    save: jest.fn(),\r\n    update: jest.fn(),\r\n    findOne: jest.fn(),\r\n  };\r\n  const mockEmailPreferenceRepo = {\r\n    findOne: jest.fn(),\r\n    find: jest.fn(),\r\n    create: jest.fn(),\r\n    save: jest.fn(),\r\n  };\r\n\r\n  beforeEach(async () => {\r\n    mockQueue = {\r\n      add: jest.fn(),\r\n    } as any;\r\n\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        EmailService,\r\n        { provide: ConfigService, useValue: { get: jest.fn(() => 'mock') } },\r\n        { provide: getRepositoryToken(EmailTemplate), useValue: mockEmailTemplateRepo },\r\n        { provide: getRepositoryToken(EmailLog), useValue: mockEmailLogRepo },\r\n        { provide: getRepositoryToken(EmailPreference), useValue: mockEmailPreferenceRepo },\r\n        { provide: 'BullQueue_email', useValue: mockQueue },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get<EmailService>(EmailService);\r\n  });\r\n\r\n  it('should be defined', () => {\r\n    expect(service).toBeDefined();\r\n  });\r\n\r\n  describe('sendEmail', () => {\r\n    it('should queue the email if user has not opted out', async () => {\r\n      mockEmailPreferenceRepo.findOne.mockResolvedValue(null);\r\n      const result = await service.sendEmail({\r\n        to: 'user@example.com',\r\n        subject: 'Test',\r\n        templateName: 'email-verification',\r\n        context: {},\r\n      });\r\n      expect(result).toBe(true);\r\n      expect(mockQueue.add).toHaveBeenCalled();\r\n    });\r\n\r\n    it('should not send email if user has opted out', async () => {\r\n      mockEmailPreferenceRepo.findOne.mockResolvedValue({ optOut: true });\r\n      const result = await service.sendEmail({\r\n        to: 'user@example.com',\r\n        subject: 'Test',\r\n        templateName: 'email-verification',\r\n        context: {},\r\n      });\r\n      expect(result).toBe(false);\r\n      expect(mockQueue.add).not.toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe('updateEmailPreference', () => {\r\n    it('should create a new preference if none exists', async () => {\r\n      mockEmailPreferenceRepo.findOne.mockResolvedValue(null);\r\n      await service.updateEmailPreference('user@example.com', 'email-verification', true);\r\n      expect(mockEmailPreferenceRepo.create).toHaveBeenCalled();\r\n      expect(mockEmailPreferenceRepo.save).toHaveBeenCalled();\r\n    });\r\n\r\n    it('should update existing preference', async () => {\r\n      mockEmailPreferenceRepo.findOne.mockResolvedValue({ email: 'user@example.com', optOut: false });\r\n      await service.updateEmailPreference('user@example.com', 'email-verification', true);\r\n      expect(mockEmailPreferenceRepo.save).toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe('getTemplate', () => {\r\n    it('should fetch template from database if exists', async () => {\r\n      mockEmailTemplateRepo.findOne.mockResolvedValue({ content: '<p>Hello</p>' });\r\n      const template = await service.getTemplate('email-verification');\r\n      expect(template).toBe('<p>Hello</p>');\r\n    });\r\n  });\r\n});\r\n"],"version":3}